<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Datos JSON</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { 
            background: #f5f7fa; 
            padding: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding-top: 120px;
            overflow: hidden;
        }
        
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .filtros-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            backdrop-filter: blur(5px);
        }
        
        .filtro-input {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            width: 200px;
            margin-right: 10px;
        }
        
        .btn-filtro {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-filtro:hover {
            background: #2980b9;
        }
        
        .container-main {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .main-content {
            background: white;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 80px;
        }
        
        .fixed-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 20px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 999;
            border-top: 2px solid #3498db;
        }
        
        .controls-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .table-container {
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            height: calc(100vh - 220px);
        }
        
        .table {
            min-width: 1300px;
            margin-bottom: 0;
        }
        
        .table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table th {
            background-color: white;
            color: #2c3e50;
            font-weight: 700;
            padding: 15px 10px;
            white-space: nowrap;
            position: sticky;
            top: 0;
            border-bottom: 3px solid #3498db;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center; /* TODOS LOS T√çTULOS CENTRADOS */
        }
        
        .table td {
            padding: 12px 10px;
            vertical-align: middle;
            max-width: 300px;
            min-width: 100px;
            font-size: 15px;
            border-bottom: 1px solid #eee;
        }
        
        /* Alineaci√≥n espec√≠fica para celdas */
            .table td:nth-child(1) { text-align: center; } /* ID - CENTRADO */
            .table td:nth-child(2) { text-align: left; } /* NOMBRE COMPLETO - IZQUIERDA */
            .table td:nth-child(3) { text-align: right; } /* C√âDULA - DERECHA */
            .table td:nth-child(4) { text-align: center; } /* FECHA AFILIACI√ìN - CENTRADO */
            .table td:nth-child(5) { text-align: center; } /* REGISTRO - CENTRADO */
            .table td:nth-child(6) { text-align: center; } /* FOLIO - CENTRADO */
            .table td:nth-child(7) { text-align: center; } /* RENGL√ìN - CENTRADO */
            .table td:nth-child(8) { text-align: center; } /* DIRECCI√ìN - CENTRADO */
            .table td:nth-child(9) { text-align: center; } /* TEL√âFONO - CENTRADO */
        
        .editable-cell { 
            cursor: pointer; 
            transition: all 0.2s;
        }
        
        .editable-cell:hover { 
            background: #e8f4fd !important; 
        }
        
        .celda-activa {
            background: #d1ecf1 !important;
            border: 2px solid #3498db !important;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
            position: relative;
            z-index: 5;
        }
        
        .btn-action { 
            padding: 8px 16px;
            font-weight: 500;
            min-width: 140px;
            margin: 2px;
        }
        
        .file-input { display: none; }
        
        .file-label { 
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .alert-message {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .nombre-columna {
            min-width: 300px !important;
            word-wrap: break-word;
        }
        
        .columna-oculta {
            display: none !important;
        }
        
        .columna-firma-oculta {
            display: none !important;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 10px 15px;
            border-top: 1px solid #dee2e6;
            font-size: 14px;
            color: #666;
        }
        
        .badge-info {
            font-size: 0.9em;
            padding: 6px 10px;
        }
        
        .modal-pdf {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content-pdf {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .titulo-input-group {
            margin-bottom: 15px;
        }
        
        .btn-add-titulo {
            padding: 6px 12px;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .form-check {
            margin: 10px 0;
        }
        
        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .config-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .config-section h5 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }
        
        .form-range {
            width: 100%;
            margin: 10px 0;
        }
        
        .range-value {
            display: inline-block;
            width: 40px;
            text-align: center;
            font-weight: bold;
            color: #3498db;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .add-column-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .column-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .custom-column {
            background: #e8f4fd;
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fila-filtrada {
            display: none;
        }

        .form-control-sm {
            font-size: 15px !important;
        }

        #btnLimpiarFiltro {
            margin-left: 10px;
        }
        
        .config-columnas-table {
            width: 100%;
            margin-bottom: 15px;
        }
        
        .config-columnas-table th {
            background: #f8f9fa;
            padding: 10px;
            font-size: 13px;
            text-align: center;
        }
        
        .config-columnas-table td {
            padding: 8px;
            vertical-align: middle;
            font-size: 13px;
        }
        
        .ancho-columna-input {
            width: 80px;
            padding: 4px 8px;
            text-align: center;
        }
        
        .alineacion-select {
            width: 100px;
            padding: 4px 8px;
        }
        
        .fila-sin-nombre {
            background-color: #ffe6e6 !important;
        }
        .celda-sin-nombre {
            background-color: #ffe6e6 !important;
            color: #cc0000 !important;
            font-weight: bold;
        }

.filtros-panel {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center; /* Centrar horizontalmente */
}

.filtro-input {
    padding: 6px 10px;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.9);
    width: 200px;
    margin-right: 10px;
    color: #333; /* Para mejor legibilidad */
}

.btn-filtro {
    background: #3498db;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-filtro:hover {
    background: #2980b9;
}
    </style>
</head>
<body>
    <div class="fixed-header">
        <div class="header-content">
            <div class="row align-items-center">
    <!-- T√≠tulo ocupa TODA la fila y est√° centrado -->
    <div class="col-12 text-center position-relative">
        <h5 class="mb-1">
            JUNTA DE ACCION COMUNAL BARRIO BATEAS SECTOR 3
            <span id="fecha-y-hora-actual" class="ms-2"></span>
        </h5>
        
        <!-- Badges posicionados absolutamente a la derecha -->
        <div class="position-absolute top-0 end-0 mt-1">
            <span id="rowCount" class="badge bg-secondary">0 registros</span>
            <span id="folioInfo" class="badge bg-info ms-2">Folio: -</span>
        </div>
    </div>
</div>
            
            <div class="filtros-panel">
    <div class="d-flex align-items-center justify-content-center"> <!-- Agregar justify-content-center -->
        <input type="text" id="filtroTexto" class="filtro-input" 
               placeholder="Buscar en todos los campos...">
        <select id="filtroColumna" class="filtro-input">
            <option value="todos">Todos los campos</option>
            <option value="nombre">Nombre</option>
            <option value="cedula">C√©dula</option>
            <option value="folio">Folio</option>
            <option value="registro">Registro</option>
        </select>
        <button id="btnAplicarFiltro" class="btn-filtro">üîç Filtrar</button>
        <button id="btnLimpiarFiltro" class="btn-filtro" style="background: #95a5a6;">‚úï Limpiar</button>
        <span id="filtroInfo" class="ms-2" style="font-size: 12px; opacity: 0.9;"></span>
    </div>
</div>
        </div>
    </div>

    <div class="modal-pdf" id="pdfConfigModal">
        <div class="modal-content-pdf">
            <h4 class="mb-4">‚öôÔ∏è Configuraci√≥n Avanzada de PDF</h4>
            
            <div class="config-section">
                <h5>üìù T√≠tulos del Documento</h5>
                <p class="text-muted small mb-2">Solo aparecer√°n en la primera p√°gina</p>
                <div id="titulosContainer">
                    <div class="titulo-input-group d-flex align-items-center mb-2">
                        <input type="text" class="form-control pdf-titulo" 
                               value="JUNTA DE ACCI√ìN COMUNAL DEL BARRIO BATEAS SECTOR 3" 
                               placeholder="T√≠tulo principal">
                        <button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>
                    </div>
                    <div class="titulo-input-group d-flex align-items-center mb-2">
                        <input type="text" class="form-control pdf-titulo" 
                               value="PUERTO GAIT√ÅN META" 
                               placeholder="T√≠tulo adicional">
                        <button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-primary btn-add-titulo" onclick="agregarTitulo()">
                    + Agregar l√≠nea de t√≠tulo
                </button>
                <button type="button" class="btn btn-sm btn-secondary btn-add-titulo ms-2" onclick="restaurarTitulosPredeterminados()">
                    üîÑ Restaurar predeterminados
                </button>
            </div>
            
            <div class="config-section">
                <h5>üìã Subt√≠tulos</h5>
                <p class="text-muted small mb-2">Solo aparecer√°n en la primera p√°gina</p>
                <div id="subtitulosContainer">
                    <div class="titulo-input-group d-flex align-items-center mb-2">
                        <input type="text" class="form-control pdf-subtitulo" 
                               value="ASAMBLEA PREVIA" 
                               placeholder="Subt√≠tulo">
                        <button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>
                    </div>
                    <div class="titulo-input-group d-flex align-items-center mb-2">
                        <input type="text" class="form-control pdf-subtitulo" 
                               value="ASISTENCIA DE AFILIADOS" 
                               placeholder="Subt√≠tulo">
                        <button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>
                    </div>
                    <div class="titulo-input-group d-flex align-items-center mb-2">
                        <input type="text" class="form-control pdf-subtitulo" 
                               value="FECHA: {{fecha}}" 
                               placeholder="Subt√≠tulo con fecha">
                        <button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-primary btn-add-titulo" onclick="agregarSubtitulo()">
                    + Agregar l√≠nea de subt√≠tulo
                </button>
                <button type="button" class="btn btn-sm btn-secondary btn-add-titulo ms-2" onclick="restaurarSubtitulosPredeterminados()">
                    üîÑ Restaurar predeterminados
                </button>
            </div>
            
            <div class="config-section">
                <h5>üìÑ Configuraci√≥n de P√°ginas</h5>
                <div class="config-grid">
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="incluirNumPaginas" checked>
                            <label class="form-check-label" for="incluirNumPaginas">
                                Numeraci√≥n de p√°ginas
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="incluirFecha" checked>
                            <label class="form-check-label" for="incluirFecha">
                                Incluir fecha
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="soloFilasVisibles" checked>
                            <label class="form-check-label" for="soloFilasVisibles">
                                Solo filas visibles (filtradas)
                            </label>
                        </div>
                    </div>
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alternarColores">
                            <label class="form-check-label" for="alternarColores">
                                Filas alternadas
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bordeCeldas" checked>
                            <label class="form-check-label" for="bordeCeldas">
                                Bordes en celdas
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cabeceraNegrita" checked>
                            <label class="form-check-label" for="cabeceraNegrita">
                                Cabecera en negrita
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <h5>üé® Ajustes de Dise√±o</h5>
                <div class="config-grid">
                    <div>
                        <label class="form-label">
                            Tama√±o letra t√≠tulos: <span class="range-value" id="tamTituloVal">18</span>pt
                            <input type="range" class="form-range" id="tamTitulo" min="10" max="28" value="18" step="1">
                        </label>
                        
                        <label class="form-label">
                            Tama√±o letra tabla: <span class="range-value" id="tamTablaVal">10</span>pt
                            <input type="range" class="form-range" id="tamTabla" min="6" max="14" value="10" step="1">
                        </label>
                    </div>
                    <div>
                        <label class="form-label">
                            Alto de celdas: <span class="range-value" id="altoCeldaVal">8</span>pt
                            <input type="range" class="form-range" id="altoCelda" min="5" max="15" value="8" step="1">
                        </label>
                        
                        <label class="form-label">
                            Margen superior: <span class="range-value" id="margenSupVal">20</span>mm
                            <input type="range" class="form-range" id="margenSup" min="5" max="40" value="20" step="1">
                        </label>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h5>üìä Ordenar Datos</h5>
                <div class="config-grid">
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ordenarPor" id="ordenarCedula" value="cedula" checked>
                            <label class="form-check-label" for="ordenarCedula">
                                Por C√©dula (menor a mayor)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ordenarPor" id="ordenarNombre" value="nombre">
                            <label class="form-check-label" for="ordenarNombre">
                                Por Nombre (A-Z)
                            </label>
                        </div>
                    </div>
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ordenarPor" id="ordenarFolio" value="folio">
                            <label class="form-check-label" for="ordenarFolio">
                                Por Folio (menor a mayor)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ordenarPor" id="sinOrdenar" value="ninguno">
                            <label class="form-check-label" for="sinOrdenar">
                                Sin ordenar (como en tabla)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ordenDescendente">
                        <label class="form-check-label" for="ordenDescendente">
                            Orden descendente (Z-A / mayor a menor)
                        </label>
                    </div>
                </div>
            </div>


            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="numeracionConsecutiva" checked>
                <label class="form-check-label" for="numeracionConsecutiva">
                    Numeraci√≥n consecutiva (1, 2, 3...)
                </label>
            </div>
            
            <div class="config-section">
                <h5>üìä Configuraci√≥n de Columnas (Ancho PDF)</h5>
                <div class="table-responsive mb-3">
                    <table class="table table-sm config-columnas-table">
                        <thead>
                            <tr>
                                <th>Activar</th>
                                <th>Columna</th>
                                <th>Ancho PDF (mm)</th>
                                <th>Alineaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="columnasConfig">
                        </tbody>
                    </table>
                </div>
                
                <div class="add-column-section mt-3">
                    <h6>‚ûï Agregar Columnas Personalizadas</h6>
                    <div class="column-input-group">
                        <input type="text" id="nuevaColNombre" class="form-control form-control-sm" 
                               placeholder="Nombre de la columna">
                        <input type="text" id="nuevaColClave" class="form-control form-control-sm" 
                               placeholder="Clave (ej: 'area')">
                        <button class="btn btn-sm btn-success" onclick="agregarColumnaPersonalizada()">
                            Agregar
                        </button>
                    </div>
                    <div id="columnasPersonalizadas">
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                <button type="button" class="btn btn-secondary" onclick="cerrarConfigPDF()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="exportarPDF()">
                    üìÑ Generar PDF
                </button>
            </div>
        </div>
    </div>

    <div class="container-main">
        <div class="main-content">
            <div class="table-container">
                <table class="table table-hover" id="dataTable">
                    <thead>
                        <tr id="tableHeaders"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="status-bar">
                <div class="row">
                    <div class="col">
                        <span id="fileName">No hay archivo cargado</span>
                        <span id="filtroEstado" class="ms-2 text-muted"></span>
                    </div>
                    <div class="col text-end">
                        <span id="editStatus">Sin cambios</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed-controls">
        <div class="controls-content">
            <input type="file" id="jsonFile" class="file-input" accept=".json">
            <label for="jsonFile" class="btn btn-primary btn-action file-label">
                üìÇ Cargar JSON
            </label>
            
            <button id="saveBtn" class="btn btn-success btn-action" disabled>
                üíæ Guardar JSON
            </button>
            
            <button id="addRowBtn" class="btn btn-warning btn-action" disabled>
                ‚ûï Nuevo Registro
            </button>
            
            <button id="configPdfBtn" class="btn btn-danger btn-action">
                üìÑ Exportar PDF
            </button>
        </div>
    </div>

    <div id="message" class="alert-message alert" style="display: none;"></div>

 <script>
    // ============================================
    // SCRIPT PARA FECHA Y HORA EN EL T√çTULO
    // ============================================
    function mostrarFechaYHora() {
        const elementoFechaHora = document.getElementById("fecha-y-hora-actual");
        const ahora = new Date();
        
        // Formato compacto para fecha
        const fechaFormateada = ahora.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        // Formato compacto para hora
        const horaFormateada = ahora.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        
        // Mostrar sin separador, solo espacio
        elementoFechaHora.textContent = ` ${fechaFormateada} ${horaFormateada}`;
    }

    // Ejecutar al cargar y cada minuto
    mostrarFechaYHora();
    setInterval(mostrarFechaYHora, 60000);
    
    // ============================================
    // SCRIPT PRINCIPAL DEL EDITOR JSON
    // ============================================
    let jsonData = [];
    let originalFileName = '';
    let hasChanges = false;
    let filtroTexto = '';
    let filtroColumna = 'todos';
    let columnasPersonalizadas = [];
    let configAnchoColumnasPDF = {};
    let celdaActiva = null;
    let celdaEnEdicion = null;

    // T√≠tulos predeterminados
    const titulosPredeterminados = [
        "JUNTA DE ACCI√ìN COMUNAL DEL BARRIO BATEAS SECTOR 3",
        "PUERTO GAIT√ÅN META"
    ];

    const subtitulosPredeterminados = [
        "ASAMBLEA PREVIA",
        "ASISTENCIA DE AFILIADOS",
        "FECHA: {{fecha}}"
    ];

    function formatearCedula(valor) {
        if (!valor) return '';
        const numero = valor.toString().replace(/\D/g, '');
        return numero.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // Funci√≥n para obtener solo n√∫meros de una c√©dula
    function obtenerNumerosCedula(cedula) {
        if (!cedula) return 0;
        return parseInt(cedula.toString().replace(/\D/g, '')) || 0;
    }

    document.getElementById('jsonFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        originalFileName = file.name;
        document.getElementById('fileName').textContent = `Archivo: ${file.name}`;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                jsonData = JSON.parse(event.target.result);
                
                // CORRECCI√ìN IMPORTANTE: Limpiar propiedades CSS del JSON
                // Asegurar que solo tengamos los datos de los registros, no propiedades del DOM
                if (Array.isArray(jsonData)) {
                    jsonData = jsonData.map(registro => {
                        // Crear un nuevo objeto con solo las propiedades que necesitamos
                        const nuevoRegistro = {};
                        
                        // Propiedades base que deben existir
                        const propiedadesBase = ['id', 'nombre', 'cedula', 'fecha_afiliacion', 'registro', 
                                                'folio', 'renglon', 'direccion', 'telefono', 'pagos', 'firma'];
                        
                        // Copiar solo las propiedades v√°lidas
                        propiedadesBase.forEach(prop => {
                            if (registro.hasOwnProperty(prop)) {
                                nuevoRegistro[prop] = registro[prop];
                            } else {
                                nuevoRegistro[prop] = prop === 'firma' ? '' : '';
                            }
                        });
                        
                        // Copiar columnas personalizadas si existen
                        columnasPersonalizadas.forEach(col => {
                            if (registro.hasOwnProperty(col.clave)) {
                                nuevoRegistro[col.clave] = registro[col.clave];
                            }
                        });
                        
                        return nuevoRegistro;
                    });
                }
                
                // CORRECCI√ìN IMPORTANTE: Activar botones incluso si el array est√° vac√≠o
                if (Array.isArray(jsonData)) {
                    // Siempre activar los botones, incluso con array vac√≠o
                    document.getElementById('saveBtn').disabled = false;
                    document.getElementById('addRowBtn').disabled = false;
                    
                    if (jsonData.length > 0) {
                        // Si hay datos, procesar normalmente
                        jsonData.forEach(registro => {
                            if (!registro.hasOwnProperty('firma')) {
                                registro.firma = '';
                            }
                            columnasPersonalizadas.forEach(col => {
                                if (!registro.hasOwnProperty(col.clave)) {
                                    registro[col.clave] = '';
                                }
                            });
                        });
                        
                        crearTabla();
                        mostrarMensaje('‚úÖ Archivo cargado correctamente', 'success');
                        actualizarContador();
                        actualizarInfoFolio();
                    } else {
                        // Si el array est√° vac√≠o, mostrar mensaje pero mantener botones activos
                        crearTabla(); // Esto crear√° una tabla vac√≠a
                        mostrarMensaje('üìÑ Archivo JSON cargado (vac√≠o). Puedes agregar nuevos registros.', 'info');
                        actualizarContador();
                        actualizarInfoFolio();
                    }
                    
                    hasChanges = false;
                    actualizarEstado();
                    actualizarConfigColumnasPDF();
                }
            } catch (error) {
                mostrarMensaje('‚ùå Error al leer el JSON', 'danger');
            }
        };
        reader.readAsText(file);
    });

    function crearTabla() {
        const headers = document.getElementById('tableHeaders');
        const body = document.getElementById('tableBody');
        headers.innerHTML = '';
        body.innerHTML = '';
        
        if (jsonData.length > 0) {
            const columnasBase = [
                { key: 'id', label: 'ID', width: '70px' },
                { key: 'nombre', label: 'NOMBRE COMPLETO', width: '200px', class: 'nombre-columna' },
                { key: 'cedula', label: 'C√âDULA', width: '100px' },
                { key: 'fecha_afiliacion', label: 'FECHA AFILIACI√ìN', width: '100px' },
                { key: 'registro', label: 'REGISTRO', width: '50px' },
                { key: 'folio', label: 'FOLIO', width: '50px' },
                { key: 'renglon', label: 'RENGL√ìN', width: '50px' },
                { key: 'direccion', label: 'DIRECCI√ìN', width: '150px' },
                { key: 'telefono', label: 'TEL√âFONO', width: '90px' },
                { key: 'pagos', label: 'PAGOS', width: '100px', class: 'columna-oculta' },
                { key: 'firma', label: 'FIRMA', width: '100px', class: 'columna-firma-oculta' }
            ];
            const columnasPersonalizadasTabla = columnasPersonalizadas.map(col => ({
                key: col.clave,
                label: col.label,
                width: '120px'
            }));
            const todasColumnas = [...columnasBase, ...columnasPersonalizadasTabla];
            
            // Solo mostrar columnas NO OCULTAS en los headers
            todasColumnas.forEach(col => {
                if (!col.class || (!col.class.includes('columna-oculta') && !col.class.includes('columna-firma-oculta'))) {
                    const th = document.createElement('th');
                    th.textContent = col.label;
                    th.style.width = col.width;
                    if (col.class) th.className = col.class;
                    headers.appendChild(th);
                }
            });
            
            jsonData.forEach((item, rowIndex) => {
                const tr = document.createElement('tr');
                tr.dataset.rowIndex = rowIndex;
                
                const nombreVacio = !item.nombre || item.nombre.trim() === '';
                if (nombreVacio) {
                    tr.classList.add('fila-sin-nombre');
                }
                
                // Contador para columnas visibles
                let colVisibleIndex = 0;
                
                // Solo mostrar columnas NO OCULTAS en el body
                todasColumnas.forEach((col, colIndex) => {
                    if (!col.class || (!col.class.includes('columna-oculta') && !col.class.includes('columna-firma-oculta'))) {
                        const td = document.createElement('td');
                        td.className = 'editable-cell ' + (col.class || '');
                        
                        if (nombreVacio) {
                            td.classList.add('celda-sin-nombre');
                        }
                        
                        td.textContent = col.key === 'cedula' ? formatearCedula(item[col.key]) : (item[col.key] || '');
                        td.dataset.key = col.key;
                        td.dataset.row = rowIndex;
                        td.dataset.col = colVisibleIndex;
                        td.tabIndex = 0;
                        
                        if (col.key !== 'pagos' && col.key !== 'firma') {
                            td.addEventListener('click', function(e) {
                                if (celdaEnEdicion === this) return;
                                iniciarEdicion(this);
                            });
                        } else {
                            td.style.cursor = 'default';
                        }
                        
                        td.addEventListener('focus', function(e) {
                            celdaActiva = this;
                            this.classList.add('celda-activa');
                        });
                        
                        td.addEventListener('blur', function(e) {
                            this.classList.remove('celda-activa');
                        });
                        
                        tr.appendChild(td);
                        colVisibleIndex++;
                    }
                });
                body.appendChild(tr);
            });
        }
    }

    function iniciarEdicion(celda) {
        if (!celda || celda.dataset.key === 'pagos' || celda.dataset.key === 'firma') return;
        if (celdaEnEdicion) finalizarEdicion(celdaEnEdicion);
        
        const oldValue = celda.textContent;
        const key = celda.dataset.key;
        const row = celda.dataset.row;
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control form-control-sm';
        input.value = key === 'cedula' ? oldValue.replace(/\./g, '') : oldValue;
        input.style.width = '100%';
        input.style.height = '100%';
        input.style.border = 'none';
        input.style.background = 'transparent';
        input.style.outline = 'none';
        
        celda.textContent = '';
        celda.appendChild(input);
        celdaEnEdicion = celda;
        
        input.focus();
        input.select();
        
        function guardarCambio() {
            const newValue = input.value.trim();
            if (newValue !== (key === 'cedula' ? oldValue.replace(/\./g, '') : oldValue)) {
                jsonData[row][key] = key === 'cedula' ? newValue.replace(/\D/g, '') : newValue;
                celda.textContent = key === 'cedula' ? formatearCedula(newValue) : newValue;
                hasChanges = true;
                actualizarEstado();
                
                if (key === 'nombre') {
                    actualizarEstiloFila(row);
                }
                
                if (['registro', 'folio', 'renglon'].includes(key)) {
                    actualizarInfoFolio();
                }
            } else {
                celda.textContent = key === 'cedula' ? formatearCedula(oldValue) : oldValue;
            }
            celdaEnEdicion = null;
        }
        
        input.addEventListener('blur', guardarCambio);
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                guardarCambio();
                moverSiguienteCelda();
            } else if (e.key === 'Escape') {
                celda.textContent = key === 'cedula' ? formatearCedula(oldValue) : oldValue;
                celdaEnEdicion = null;
            } else if (e.key === 'Tab') {
                e.preventDefault();
                guardarCambio();
                if (e.shiftKey) {
                    moverCeldaAnterior();
                } else {
                    moverSiguienteCelda();
                }
            }
        });
    }

    function actualizarEstiloFila(rowIndex) {
        const tr = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if (!tr) return;
        
        const nombreVacio = !jsonData[rowIndex].nombre || jsonData[rowIndex].nombre.trim() === '';
        
        if (nombreVacio) {
            tr.classList.add('fila-sin-nombre');
            const celdas = tr.querySelectorAll('td');
            celdas.forEach(td => {
                td.classList.add('celda-sin-nombre');
            });
        } else {
            tr.classList.remove('fila-sin-nombre');
            const celdas = tr.querySelectorAll('td');
            celdas.forEach(td => {
                td.classList.remove('celda-sin-nombre');
            });
        }
    }

    function finalizarEdicion(celda) {
        if (celda && celda.querySelector('input')) {
            const input = celda.querySelector('input');
            const event = new Event('blur');
            input.dispatchEvent(event);
        }
    }

    function moverSiguienteCelda() {
        if (!celdaActiva) return;
        const row = parseInt(celdaActiva.dataset.row);
        const col = parseInt(celdaActiva.dataset.col);
        const totalRows = jsonData.length;
        
        // Obtener todas las celdas visibles de esta fila
        const celdasVisibles = Array.from(document.querySelectorAll(`td[data-row="${row}"]`))
            .filter(td => {
                const key = td.dataset.key;
                return key !== 'pagos' && key !== 'firma';
            });
        
        const totalCols = celdasVisibles.length;
        const currentIndex = celdasVisibles.findIndex(td => td === celdaActiva);
        
        if (currentIndex < totalCols - 1) {
            const nextCell = celdasVisibles[currentIndex + 1];
            if (nextCell) {
                nextCell.focus();
                iniciarEdicion(nextCell);
            }
        } else if (row < totalRows - 1) {
            // Ir a la primera celda de la siguiente fila
            const nextRowCells = Array.from(document.querySelectorAll(`td[data-row="${row + 1}"]`))
                .filter(td => {
                    const key = td.dataset.key;
                    return key !== 'pagos' && key !== 'firma';
                });
            if (nextRowCells.length > 0) {
                const nextCell = nextRowCells[0];
                if (nextCell) {
                    nextCell.focus();
                    iniciarEdicion(nextCell);
                }
            }
        }
    }

    function moverCeldaAnterior() {
        if (!celdaActiva) return;
        const row = parseInt(celdaActiva.dataset.row);
        const col = parseInt(celdaActiva.dataset.col);
        const totalRows = jsonData.length;
        
        // Obtener todas las celdas visibles de esta fila
        const celdasVisibles = Array.from(document.querySelectorAll(`td[data-row="${row}"]`))
            .filter(td => {
                const key = td.dataset.key;
                return key !== 'pagos' && key !== 'firma';
            });
        
        const totalCols = celdasVisibles.length;
        const currentIndex = celdasVisibles.findIndex(td => td === celdaActiva);
        
        if (currentIndex > 0) {
            const prevCell = celdasVisibles[currentIndex - 1];
            if (prevCell) {
                prevCell.focus();
                iniciarEdicion(prevCell);
            }
        } else if (row > 0) {
            // Ir a la √∫ltima celda de la fila anterior
            const prevRowCells = Array.from(document.querySelectorAll(`td[data-row="${row - 1}"]`))
                .filter(td => {
                    const key = td.dataset.key;
                    return key !== 'pagos' && key !== 'firma';
                });
            if (prevRowCells.length > 0) {
                const prevCell = prevRowCells[prevRowCells.length - 1];
                if (prevCell) {
                    prevCell.focus();
                    iniciarEdicion(prevCell);
                }
            }
        }
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' && celdaActiva && !celdaEnEdicion) {
            e.preventDefault();
            if (celdaActiva.dataset.key !== 'pagos' && celdaActiva.dataset.key !== 'firma') {
                iniciarEdicion(celdaActiva);
            }
        }
        
        if (e.key === 'Enter' && celdaActiva && !celdaEnEdicion) {
            e.preventDefault();
            if (celdaActiva.dataset.key !== 'pagos' && celdaActiva.dataset.key !== 'firma') {
                iniciarEdicion(celdaActiva);
            }
        }
        
        if (e.key === 'Delete' && celdaActiva && e.target.tagName !== 'INPUT') {
            const rowIndex = parseInt(celdaActiva.dataset.row);
            if (confirm('¬øEliminar esta fila? (Delete)')) {
                jsonData.splice(rowIndex, 1);
                crearTabla();
                hasChanges = true;
                actualizarEstado();
                actualizarContador();
                actualizarInfoFolio();
                mostrarMensaje('üóëÔ∏è Fila eliminada (Delete)', 'warning');
            }
        }
    });

    document.getElementById('btnAplicarFiltro').addEventListener('click', aplicarFiltro);
    document.getElementById('btnLimpiarFiltro').addEventListener('click', limpiarFiltro);
    document.getElementById('filtroTexto').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') aplicarFiltro();
    });

    function aplicarFiltro() {
        filtroTexto = document.getElementById('filtroTexto').value.toLowerCase();
        filtroColumna = document.getElementById('filtroColumna').value;
        
        if (!filtroTexto) {
            limpiarFiltro();
            return;
        }
        
        const filas = document.querySelectorAll('#tableBody tr');
        let coincidencias = 0;
        
        filas.forEach((fila, index) => {
            const celdas = fila.querySelectorAll('td');
            let coincide = false;
            
            if (filtroColumna === 'todos') {
                for (let celda of celdas) {
                    // CORRECCI√ìN: Para c√©dula, comparar sin puntos
                    if (celda.dataset.key === 'cedula') {
                        const cedulaSinPuntos = celda.textContent.replace(/\./g, '');
                        const filtroSinPuntos = filtroTexto.replace(/\./g, '');
                        if (cedulaSinPuntos.toLowerCase().includes(filtroSinPuntos)) {
                            coincide = true;
                            break;
                        }
                    } else if (celda.textContent.toLowerCase().includes(filtroTexto)) {
                        coincide = true;
                        break;
                    }
                }
            } else if (filtroColumna === 'cedula') {
                // CORRECCI√ìN ESPECIAL: para filtro por c√©dula, comparar sin puntos
                const indice = 2; // √≠ndice de la columna c√©dula
                if (celdas[indice]) {
                    const cedulaSinPuntos = celdas[indice].textContent.replace(/\./g, '');
                    const filtroSinPuntos = filtroTexto.replace(/\./g, '');
                    coincide = cedulaSinPuntos.toLowerCase().includes(filtroSinPuntos);
                }
            } else {
                const indices = { 'nombre': 1, 'cedula': 2, 'folio': 5, 'registro': 4 };
                const indice = indices[filtroColumna];
                if (indice !== undefined && celdas[indice]) {
                    coincide = celdas[indice].textContent.toLowerCase().includes(filtroTexto);
                }
            }
            
            if (coincide) {
                fila.classList.remove('fila-filtrada');
                coincidencias++;
            } else {
                fila.classList.add('fila-filtrada');
            }
        });
        
        document.getElementById('filtroInfo').textContent = `${coincidencias} de ${filas.length} registros`;
        document.getElementById('filtroEstado').textContent = `Filtrado: "${filtroTexto}" (${coincidencias} resultados)`;
        
        mostrarMensaje(`üîç Filtro aplicado: ${coincidencias} resultados`, 'info');
    }

    function limpiarFiltro() {
        document.getElementById('filtroTexto').value = '';
        document.getElementById('filtroInfo').textContent = '';
        document.getElementById('filtroEstado').textContent = '';
        
        const filas = document.querySelectorAll('#tableBody tr');
        filas.forEach(fila => {
            fila.classList.remove('fila-filtrada');
        });
        
        mostrarMensaje('Filtro limpiado', 'info');
    }

    document.getElementById('tamTitulo').addEventListener('input', function() {
        document.getElementById('tamTituloVal').textContent = this.value;
    });
    document.getElementById('tamTabla').addEventListener('input', function() {
        document.getElementById('tamTablaVal').textContent = this.value;
    });
    document.getElementById('altoCelda').addEventListener('input', function() {
        document.getElementById('altoCeldaVal').textContent = this.value;
    });
    document.getElementById('margenSup').addEventListener('input', function() {
        document.getElementById('margenSupVal').textContent = this.value;
    });

    function restaurarTitulosPredeterminados() {
        const container = document.getElementById('titulosContainer');
        container.innerHTML = '';
        
        titulosPredeterminados.forEach(titulo => {
            const div = document.createElement('div');
            div.className = 'titulo-input-group d-flex align-items-center mb-2';
            div.innerHTML = `
                <input type="text" class="form-control pdf-titulo" 
                       value="${titulo}" placeholder="T√≠tulo">
                <button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>
            `;
            container.appendChild(div);
        });
        
        mostrarMensaje('T√≠tulos predeterminados restaurados', 'info');
    }

    function restaurarSubtitulosPredeterminados() {
        const container = document.getElementById('subtitulosContainer');
        container.innerHTML = '';
        
        subtitulosPredeterminados.forEach(subtitulo => {
            const div = document.createElement('div');
            div.className = 'titulo-input-group d-flex align-items-center mb-2';
            div.innerHTML = `
                <input type="text" class="form-control pdf-subtitulo" 
                       value="${subtitulo}" placeholder="Subt√≠tulo">
                <button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>
            `;
            container.appendChild(div);
        });
        
        mostrarMensaje('Subt√≠tulos predeterminados restaurados', 'info');
    }

    function agregarTitulo() {
        const container = document.getElementById('titulosContainer');
        const div = document.createElement('div');
        div.className = 'titulo-input-group d-flex align-items-center';
        div.innerHTML = `<input type="text" class="form-control pdf-titulo" placeholder="Nuevo t√≠tulo"><button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>`;
        container.appendChild(div);
    }
    
    function agregarSubtitulo() {
        const container = document.getElementById('subtitulosContainer');
        const div = document.createElement('div');
        div.className = 'titulo-input-group d-flex align-items-center';
        div.innerHTML = `<input type="text" class="form-control pdf-subtitulo" placeholder="Nuevo subt√≠tulo"><button type="button" class="btn-remove ms-2" onclick="this.parentElement.remove()">‚úï</button>`;
        container.appendChild(div);
    }

    function actualizarConfigColumnasPDF() {
        if (jsonData.length === 0) return;
        
        const container = document.getElementById('columnasConfig');
        container.innerHTML = '';
        
        const columnasBase = [
            { key: 'id', label: 'ID', ancho: 15, alineacion: 'center' },
            { key: 'nombre', label: 'NOMBRE COMPLETO', ancho: 95, alineacion: 'left' },
            { key: 'cedula', label: 'C√âDULA', ancho: 50, alineacion: 'right' },
            { key: 'fecha_afiliacion', label: 'FECHA AFILIACI√ìN', ancho: 50, alineacion: 'center' },
            { key: 'registro', label: 'REGISTRO', ancho: 20, alineacion: 'center' },
            { key: 'folio', label: 'FOLIO', ancho: 20, alineacion: 'center' },
            { key: 'renglon', label: 'RENGL√ìN', ancho: 20, alineacion: 'center' },
            { key: 'direccion', label: 'DIRECCI√ìN', ancho: 50, alineacion: 'center' },
            { key: 'telefono', label: 'TEL√âFONO', ancho: 50, alineacion: 'center' },
            { key: 'pagos', label: 'PAGOS', ancho: 30, alineacion: 'center' },
            { key: 'firma', label: 'FIRMA', ancho: 55, alineacion: 'center' }
        ];
        
        const todasColumnas = [...columnasBase, ...columnasPersonalizadas];
        
        if (Object.keys(configAnchoColumnasPDF).length === 0) {
            todasColumnas.forEach(col => {
                configAnchoColumnasPDF[col.key] = {
                    activa: true,
                    ancho: col.ancho || 30,
                    alineacion: col.alineacion || 'center'
                };
            });
        } else {
            todasColumnas.forEach(col => {
                if (!configAnchoColumnasPDF[col.key]) {
                    configAnchoColumnasPDF[col.key] = {
                        activa: true,
                        ancho: col.ancho || 30,
                        alineacion: col.alineacion || 'center'
                    };
                }
            });
        }
        
        todasColumnas.forEach((col, index) => {
            const config = configAnchoColumnasPDF[col.key] || { activa: true, ancho: 30, alineacion: 'center' };
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="form-check-input" 
                           id="colActivar${index}" ${config.activa ? 'checked' : ''}
                           onchange="actualizarConfigColumnaPDF('${col.key}', 'activa', this.checked)">
                </td>
                <td>${col.label}</td>
                <td class="text-center">
                    <input type="number" class="form-control form-control-sm ancho-columna-input" 
                           value="${config.ancho}" min="5" max="100" step="1"
                           onchange="actualizarConfigColumnaPDF('${col.key}', 'ancho', this.value)">
                    <small class="text-muted">mm</small>
                </td>
                <td class="text-center">
                    <select class="form-select form-select-sm alineacion-select"
                            onchange="actualizarConfigColumnaPDF('${col.key}', 'alineacion', this.value)">
                        <option value="left" ${config.alineacion === 'left' ? 'selected' : ''}>Izquierda</option>
                        <option value="center" ${config.alineacion === 'center' ? 'selected' : ''}>Centro</option>
                        <option value="right" ${config.alineacion === 'right' ? 'selected' : ''}>Derecha</option>
                    </select>
                </td>
            `;
            container.appendChild(tr);
        });
        
        actualizarListaColumnasPersonalizadas();
    }

    function actualizarConfigColumnaPDF(key, propiedad, valor) {
        if (!configAnchoColumnasPDF[key]) {
            configAnchoColumnasPDF[key] = { activa: true, ancho: 30, alineacion: 'center' };
        }
        
        if (propiedad === 'ancho') {
            configAnchoColumnasPDF[key].ancho = parseInt(valor) || 30;
        } else if (propiedad === 'alineacion') {
            configAnchoColumnasPDF[key].alineacion = valor;
        } else if (propiedad === 'activa') {
            configAnchoColumnasPDF[key].activa = valor;
        }
    }

    function agregarColumnaPersonalizada() {
        const nombre = document.getElementById('nuevaColNombre').value.trim();
        const clave = document.getElementById('nuevaColClave').value.trim().toLowerCase();
        
        if (!nombre || !clave) {
            mostrarMensaje('‚ö†Ô∏è Completa ambos campos', 'warning');
            return;
        }
        
        if (columnasPersonalizadas.some(col => col.clave === clave) || clave === 'firma') {
            mostrarMensaje('‚ö†Ô∏è Ya existe una columna con esa clave', 'warning');
            return;
        }
        
        const nuevaColumna = { clave: clave, label: nombre.toUpperCase(), ancho: 30, alineacion: 'center' };
        columnasPersonalizadas.push(nuevaColumna);
        jsonData.forEach(registro => {
            if (!registro.hasOwnProperty(clave)) {
                registro[clave] = '';
            }
        });
        
        configAnchoColumnasPDF[clave] = { activa: true, ancho: 30, alineacion: 'center' };
        
        document.getElementById('nuevaColNombre').value = '';
        document.getElementById('nuevaColClave').value = '';
        crearTabla();
        actualizarConfigColumnasPDF();
        hasChanges = true;
        actualizarEstado();
        mostrarMensaje(`‚úÖ Columna "${nombre}" agregada`, 'success');
    }

    function actualizarListaColumnasPersonalizadas() {
        const container = document.getElementById('columnasPersonalizadas');
        container.innerHTML = '';
        columnasPersonalizadas.forEach((col, index) => {
            const div = document.createElement('div');
            div.className = 'custom-column';
            div.innerHTML = `<span>${col.label} (${col.clave})</span><button class="btn-remove" onclick="eliminarColumnaPersonalizada(${index})">‚úï</button>`;
            container.appendChild(div);
        });
    }

    function eliminarColumnaPersonalizada(index) {
        const columna = columnasPersonalizadas[index];
        if (confirm(`¬øEliminar la columna "${columna.label}"?`)) {
            columnasPersonalizadas.splice(index, 1);
            delete configAnchoColumnasPDF[columna.clave];
            jsonData.forEach(registro => {
                delete registro[columna.clave];
            });
            crearTabla();
            actualizarConfigColumnasPDF();
            hasChanges = true;
            actualizarEstado();
            mostrarMensaje(`üóëÔ∏è Columna "${columna.label}" eliminada', 'warning`);
        }
    }

    function calcularNuevosValores() {
        if (jsonData.length === 0) {
            return { registro: 1, folio: 2, renglon: 1 };
        }
        const ultimo = jsonData[jsonData.length - 1];
        let ultimoRegistro = parseInt(ultimo.registro) || 0;
        let ultimoFolio = parseInt(ultimo.folio) || 0;
        let ultimoRenglon = parseInt(ultimo.renglon) || 0;
        const nuevoRegistro = ultimoRegistro + 1;
        let nuevoRenglon, nuevoFolio;
        
        if (ultimoRenglon >= 36) {
            nuevoRenglon = 1;
            nuevoFolio = ultimoFolio + 2;
        } else {
            nuevoRenglon = ultimoRenglon + 1;
            nuevoFolio = ultimoFolio;
        }
        
        if (nuevoFolio % 2 !== 0) {
            nuevoFolio += 1;
        }
        
        return { registro: nuevoRegistro, folio: nuevoFolio, renglon: nuevoRenglon };
    }

    document.getElementById('addRowBtn').addEventListener('click', function() {
        // CORRECCI√ìN: Si no hay datos, crear estructura base
        if (jsonData.length === 0) {
            const newRow = {
                id: "1",
                nombre: "",
                cedula: "",
                fecha_afiliacion: "",
                registro: "1",
                folio: "2",
                renglon: "1",
                direccion: "MANZANA  CASA ",
                telefono: "",
                pagos: "",
                firma: ""
            };
            
            // Agregar columnas personalizadas si existen
            columnasPersonalizadas.forEach(col => {
                newRow[col.clave] = '';
            });
            
            jsonData.push(newRow);
            crearTabla();
            hasChanges = true;
            actualizarEstado();
            actualizarContador();
            actualizarInfoFolio();
            mostrarMensaje('‚ûï Primer registro creado', 'info');
            return;
        }
        
        // Si ya hay datos, calcular nuevos valores normalmente
        const nuevosValores = calcularNuevosValores();
        const newRow = {...jsonData[0]};
        newRow.id = (jsonData.length + 1).toString();
        newRow.registro = nuevosValores.registro;
        newRow.folio = nuevosValores.folio;
        newRow.renglon = nuevosValores.renglon;
        newRow.nombre = '';
        newRow.cedula = '';
        newRow.fecha_afiliacion = '';
        newRow.direccion = 'MANZANA  CASA ';
        newRow.telefono = '';
        newRow.pagos = '';
        newRow.firma = '';
        
        columnasPersonalizadas.forEach(col => {
            newRow[col.clave] = '';
        });
        
        jsonData.push(newRow);
        crearTabla();
        hasChanges = true;
        actualizarEstado();
        actualizarContador();
        actualizarInfoFolio();
        mostrarMensaje(`‚ûï Nuevo: Folio ${nuevosValores.folio}, Rengl√≥n ${nuevosValores.renglon}`, 'info');
    });

    document.getElementById('configPdfBtn').addEventListener('click', function() {
        if (jsonData.length === 0) {
            mostrarMensaje('‚ö†Ô∏è Primero carga un archivo JSON', 'warning');
            return;
        }
        document.getElementById('pdfConfigModal').style.display = 'flex';
        actualizarConfigColumnasPDF();
    });

    function cerrarConfigPDF() {
        document.getElementById('pdfConfigModal').style.display = 'none';
    }

    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape', 'mm', 'a4');
        
        // 1. LEER CONFIGURACI√ìN DEL MODAL
        const titulos = Array.from(document.querySelectorAll('.pdf-titulo')).map(input => input.value.trim()).filter(t => t !== '');
        const subtitulos = Array.from(document.querySelectorAll('.pdf-subtitulo')).map(input => {
            let texto = input.value.trim();
            if (texto.includes('{{fecha}}')) {
                const fechaActual = new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                texto = texto.replace('{{fecha}}', fechaActual);
            }
            return texto;
        }).filter(t => t !== '');
        
        const incluirNumPaginas = document.getElementById('incluirNumPaginas').checked;
        const incluirFecha = document.getElementById('incluirFecha').checked;
        const soloFilasVisibles = document.getElementById('soloFilasVisibles').checked;
        const alternarColores = document.getElementById('alternarColores').checked;
        const bordeCeldas = document.getElementById('bordeCeldas').checked;
        const cabeceraNegrita = document.getElementById('cabeceraNegrita').checked;
        const tamTitulo = parseInt(document.getElementById('tamTitulo').value);
        const tamTabla = parseInt(document.getElementById('tamTabla').value);
        const altoCelda = parseInt(document.getElementById('altoCelda').value);
        const margenSuperior = parseInt(document.getElementById('margenSup').value);
        const ordenarPor = document.querySelector('input[name="ordenarPor"]:checked').value;
        const ordenDescendente = document.getElementById('ordenDescendente').checked;
        const numeracionConsecutiva = document.getElementById('numeracionConsecutiva').checked;

        // 2. FILTRAR DATOS A EXPORTAR (solo filas visibles si est√° activado)
        let dataParaExportar = [];
        if (soloFilasVisibles) {
            const filasVisibles = document.querySelectorAll('#tableBody tr:not(.fila-filtrada)');
            filasVisibles.forEach(tr => {
                const index = parseInt(tr.dataset.rowIndex);
                if (!isNaN(index)) { dataParaExportar.push(jsonData[index]); }
            });
        } else { 
            dataParaExportar = [...jsonData]; 
        }
        
        if (dataParaExportar.length === 0) { 
            mostrarMensaje('‚ö†Ô∏è No hay datos para exportar', 'warning'); 
            cerrarConfigPDF(); 
            return; 
        }
        
        // 3. FILTRAR REGISTROS V√ÅLIDOS (NOMBRE y C√âDULA no vac√≠os)
        let datosFiltrados = dataParaExportar.filter(row => {
            const nombreValido = row.nombre && row.nombre.trim() !== '';
            const cedulaValida = row.cedula && row.cedula.toString().trim() !== '';
            return nombreValido && cedulaValida;
        });
        
        if (datosFiltrados.length === 0) { 
            mostrarMensaje('‚ö†Ô∏è No hay registros con nombre y c√©dula v√°lidos', 'warning'); 
            cerrarConfigPDF(); 
            return; 
        }
        
        // 4. CONSTRUIR LISTA DE COLUMNAS ACTIVAS
        const columnasPDF = [];
        
        const columnasBase = [
            { key: 'id', label: 'ID' },
            { key: 'nombre', label: 'NOMBRE COMPLETO' },
            { key: 'cedula', label: 'C√âDULA' },
            { key: 'fecha_afiliacion', label: 'FECHA AFILIACI√ìN' },
            { key: 'registro', label: 'REGISTRO' },
            { key: 'folio', label: 'FOLIO' },
            { key: 'renglon', label: 'RENGL√ìN' },
            { key: 'direccion', label: 'DIRECCI√ìN' },
            { key: 'telefono', label: 'TEL√âFONO' },
            { key: 'pagos', label: 'PAGOS' },
            { key: 'firma', label: 'FIRMA' }
        ];
        const todasLasColumnas = [...columnasBase, ...columnasPersonalizadas];
        
        todasLasColumnas.forEach(col => {
            const config = configAnchoColumnasPDF[col.key];
            if (config && config.activa && col.key !== 'pagos') {
                columnasPDF.push({ 
                    header: col.label, 
                    dataKey: col.key, 
                    width: config.ancho || 30
                });
            }
        });
        
        if (columnasPDF.length === 0) {
            mostrarMensaje('‚ö†Ô∏è No hay columnas activadas para exportar', 'warning');
            return;
        }

        // 5. PREPARAR DATOS PARA PDF (con filtro de NOMBRE y C√âDULA)
        let datosParaPdf = datosFiltrados.map(row => {
            let newRow = { ...row };
            if (newRow.cedula) {
                newRow.cedula = formatearCedula(newRow.cedula);
            }
            return newRow;
        });

        // 6. APLICAR ORDENAMIENTO SI NO ES "NINGUNO"
        if (ordenarPor !== 'ninguno') {
            datosParaPdf.sort((a, b) => {
                let valorA = a[ordenarPor] || '';
                let valorB = b[ordenarPor] || '';
                
                // CORRECCI√ìN IMPORTANTE: Para c√©dula, convertir a n√∫mero sin puntos
                if (ordenarPor === 'cedula') {
                    valorA = obtenerNumerosCedula(valorA);
                    valorB = obtenerNumerosCedula(valorB);
                }
                // Convertir a n√∫mero si es folio, registro o rengl√≥n
                else if (ordenarPor === 'folio' || ordenarPor === 'registro' || ordenarPor === 'renglon') {
                    valorA = parseInt(valorA) || 0;
                    valorB = parseInt(valorB) || 0;
                }
                // Para nombres, convertir a may√∫sculas para ordenar sin considerar may√∫sculas/min√∫sculas
                else if (ordenarPor === 'nombre') {
                    valorA = (valorA || '').toString().toUpperCase();
                    valorB = (valorB || '').toString().toUpperCase();
                }
                
                // Comparaci√≥n
                if (valorA < valorB) return ordenDescendente ? 1 : -1;
                if (valorA > valorB) return ordenDescendente ? -1 : 1;
                return 0;
            });
        }

        // 7. AGREGAR NUMERACI√ìN CONSECUTIVA AL INICIO
        if (numeracionConsecutiva) {
            // Agregar columna "N¬∞" al inicio
            columnasPDF.unshift({ 
                header: 'N¬∞', 
                dataKey: 'numero_consecutivo', 
                width: 15
            });
            
            // Agregar numeraci√≥n consecutiva a cada fila
            datosParaPdf = datosParaPdf.map((row, index) => {
                return {
                    numero_consecutivo: (index + 1).toString(),
                    ...row
                };
            });
        }

        // 8. DIBUJAR T√çTULOS EN LA PRIMERA P√ÅGINA
        let startY = margenSuperior;
        
        doc.setFontSize(tamTitulo);
        doc.setFont(undefined, 'bold');
        titulos.forEach(titulo => {
            doc.text(titulo, doc.internal.pageSize.width / 2, startY, { align: 'center' });
            startY += 8;
        });
        doc.setFontSize(tamTitulo - 2);
        doc.setFont(undefined, 'normal');
        subtitulos.forEach(subtitulo => {
            doc.text(subtitulo, doc.internal.pageSize.width / 2, startY, { align: 'center' });
            startY += 6;
        });
        
        if (incluirFecha) {
            startY += 5;
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            const fechaActual = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            doc.text(`Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, startY, { align: 'center' });
            startY += 10;
        }

        // 9. CREAR ESTILOS DE COLUMNAS
        const columnStyles = {};
        // Estilo para la numeraci√≥n consecutiva (si existe)
        if (numeracionConsecutiva) {
            columnStyles['numero_consecutivo'] = { 
                halign: 'center',
                cellWidth: 15
            };
        }
        
        // Estilos para las dem√°s columnas
        todasLasColumnas.forEach(col => {
            const config = configAnchoColumnasPDF[col.key];
            if (config && config.activa && col.key !== 'pagos') {
                columnStyles[col.key] = { 
                    halign: config.alineacion || 'center',
                    cellWidth: config.ancho || 30
                };
            }
        });

        // 10. GENERAR TABLA
        doc.autoTable({
            columns: columnasPDF,
            body: datosParaPdf,
            startY: startY,
            styles: { 
                fontSize: tamTabla, 
                cellPadding: altoCelda / 2, 
                textColor: [0, 0, 0], 
                lineColor: bordeCeldas ? [200, 200, 200] : [255, 255, 255], 
                lineWidth: bordeCeldas ? 0.1 : 0, 
                fontStyle: 'normal',
                fillColor: [255, 255, 255],
                halign: 'center'
            },
            headStyles: { 
                fillColor: [255, 255, 255], 
                textColor: [0, 0, 0], 
                fontStyle: cabeceraNegrita ? 'bold' : 'normal', 
                fontSize: tamTabla + 1, 
                lineColor: bordeCeldas ? [200, 200, 200] : [255, 255, 255], 
                lineWidth: bordeCeldas ? 0.1 : 0,
                halign: 'center'
            },
            bodyStyles: { 
                lineColor: bordeCeldas ? [200, 200, 200] : [255, 255, 255], 
                lineWidth: bordeCeldas ? 0.1 : 0,
                fillColor: [255, 255, 255]
            },
            alternateRowStyles: alternarColores ? { 
                fillColor: [245, 247, 250] 
            } : { fillColor: [255, 255, 255] },
            columnStyles: columnStyles,
            tableWidth: 'auto',
            showHead: 'everyPage',
            margin: { top: 10, left: 15, right: 15, bottom: 15 },
            didDrawPage: function(data) {
                if (data.pageNumber > 1) {
                    data.settings.margin.top = 10;
                }
            }
        });

        // 11. A√ëADIR NUMERACI√ìN DE P√ÅGINAS (SOLO SI EST√Å ACTIVADO)
        if (incluirNumPaginas) {
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text(
                    `P√°gina ${i} de ${totalPages}`,
                    doc.internal.pageSize.width - 15,
                    doc.internal.pageSize.height - 10,
                    { align: 'right' }
                );
            }
        }
        
        const nombreArchivo = originalFileName ? originalFileName.replace('.json', '') + '.pdf' : 'registro_afiliados.pdf';
        doc.save(nombreArchivo); 
        cerrarConfigPDF(); 
        mostrarMensaje('üìÑ PDF generado correctamente', 'success');
    }

    document.getElementById('saveBtn').addEventListener('click', function() {
        if (jsonData.length === 0) return;
        
        // CORRECCI√ìN: Preparar datos limpios para guardar
        const datosParaGuardar = jsonData.map(registro => {
            const registroLimpio = {};
            
            // Propiedades base
            const propiedadesBase = ['id', 'nombre', 'cedula', 'fecha_afiliacion', 'registro', 
                                    'folio', 'renglon', 'direccion', 'telefono', 'pagos', 'firma'];
            
            // Copiar solo las propiedades v√°lidas (evitar propiedades CSS)
            propiedadesBase.forEach(prop => {
                if (registro.hasOwnProperty(prop)) {
                    registroLimpio[prop] = registro[prop];
                }
            });
            
            // Copiar columnas personalizadas
            columnasPersonalizadas.forEach(col => {
                if (registro.hasOwnProperty(col.clave)) {
                    registroLimpio[col.clave] = registro[col.clave];
                }
            });
            
            return registroLimpio;
        });
        
        const dataStr = JSON.stringify(datosParaGuardar, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = originalFileName || 'datos_modificados.json';
        const linkElement = document.createElement('a'); 
        linkElement.setAttribute('href', dataUri); 
        linkElement.setAttribute('download', exportFileDefaultName); 
        linkElement.click();
        hasChanges = false; 
        actualizarEstado(); 
        mostrarMensaje('üíæ Archivo JSON guardado', 'success');
    });

    function mostrarMensaje(texto, tipo) {
        const messageEl = document.getElementById('message'); 
        messageEl.textContent = texto; 
        messageEl.className = `alert-mensaje alert alert-${tipo}`; 
        messageEl.style.display = 'block';
        setTimeout(() => { messageEl.style.display = 'none'; }, 3000);
    }
    
    function actualizarContador() { 
        const total = jsonData.length; 
        document.getElementById('rowCount').textContent = `${total} registros`; 
    }
    
    function actualizarInfoFolio() { 
        if (jsonData.length > 0) { 
            const ultimo = jsonData[jsonData.length - 1]; 
            document.getElementById('folioInfo').textContent = `√öltimo Folio: ${ultimo.folio}`; 
        } else { 
            document.getElementById('folioInfo').textContent = 'Folio: -'; 
        } 
    }
    
    function actualizarEstado() {
        const statusEl = document.getElementById('editStatus');
        if (hasChanges) { 
            statusEl.textContent = 'Hay cambios sin guardar'; 
            statusEl.className = 'text-warning fw-bold'; 
        } else { 
            statusEl.textContent = 'Sin cambios'; 
            statusEl.className = 'text-muted'; 
        }
    }
</script>
</body>
</html>

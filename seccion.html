<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAC Bateas 路 Inicio de Sesi贸n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #2a5a2a 0%, #1e4a1e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .login-container {
            max-width: 420px;
            width: 100%;
        }

        .login-card {
            background: white;
            border-radius: 32px;
            padding: 40px 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 20, 0, 0.5);
            border: 1px solid #a0c0a0;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: #e6f0e6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5rem;
            border: 2px solid #4c8c4c;
        }

        h1 {
            font-size: 1.8rem;
            color: #1a4a2a;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .subtitle {
            color: #4a6b4a;
            font-size: 0.9rem;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #1a4a2a;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #d0e4d0;
            border-radius: 16px;
            font-size: 0.95rem;
            transition: all 0.15s;
            background: #f8fff8;
        }

        .input-group input:focus {
            border-color: #2a7a4a;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(42, 122, 74, 0.1);
        }

        .btn-login {
            background: #1a4a2a;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1rem;
            width: 100%;
            cursor: pointer;
            transition: background 0.15s;
            margin-top: 16px;
        }

        .btn-login:hover {
            background: #2a6a3a;
        }

        .btn-login:disabled {
            background: #a0c0a0;
            cursor: not-allowed;
        }

        .alert {
            padding: 14px 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-error {
            background: #ffe4e4;
            color: #8a2a2a;
            border-left: 6px solid #c04040;
        }

        .alert-success {
            background: #e4ffe4;
            color: #1a4a2a;
            border-left: 6px solid #2a8e5a;
        }

        .alert-info {
            background: #e4f0ff;
            color: #2a4a6a;
            border-left: 6px solid #4a8ac0;
        }

        .footer {
            margin-top: 24px;
            color: #6a8b6a;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="logo"></div>
            <h1>JAC Bateas</h1>
            <div class="subtitle">
                Sistema de Recaudo 路 Barrio Bateas Sector 3<br>
                Puerto Gait谩n, Meta
            </div>

            <div id="alertMessage" class="alert"></div>

            <div class="input-group">
                <label>USUARIO</label>
                <input type="text" id="username" placeholder="Ingresa tu usuario" autocomplete="off" value="">
            </div>

            <div class="input-group">
                <label>CONTRASEA</label>
                <input type="password" id="password" placeholder="Ingresa tu contrase帽a" value="">
            </div>

            <button id="loginBtn" class="btn-login">Iniciar sesi贸n</button>

            <div class="footer">
                <span>Junta de Acci贸n Comunal 路 2025</span>
            </div>
        </div>
    </div>

    <script>
        // Configuraci贸n
        const USUARIOS_URL = "https://raw.githubusercontent.com/carlos2601/juntadeaccioncomunalbarriobateaspuertogaitanmetalilianalondo-ogallego1010101010101000111010001010010/refs/heads/main/usuarios.json"
        
        // Elementos DOM
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const alertMessage = document.getElementById('alertMessage');

        // Mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'error') {
            alertMessage.textContent = mensaje;
            alertMessage.className = `alert show alert-${tipo}`;
            setTimeout(() => {
                alertMessage.classList.remove('show');
            }, 5000);
        }

        // Validar credenciales contra GitHub
        async function validarUsuario(username, password) {
            try {
                // Mostrar loading
                loginBtn.innerHTML = '<span class="loading"></span> Verificando...';
                loginBtn.disabled = true;

                // Obtener usuarios desde GitHub
                const response = await fetch(USUARIOS_URL);
                
                if (!response.ok) {
                    throw new Error('No se pudo conectar con el servidor');
                }

                const data = await response.json();
                
                // Verificar la estructura del JSON
                console.log('Datos recibidos:', data);
                
                // Asegurarse de que data.usuarios existe y es un array
                if (!data || !data.usuarios || !Array.isArray(data.usuarios)) {
                    console.error('Estructura de datos inv谩lida:', data);
                    throw new Error('Error en la estructura de datos de usuarios');
                }

                // Buscar usuario que coincida (case-insensitive para username)
                const usuario = data.usuarios.find(u => {
                    // Verificar que el usuario tenga las propiedades necesarias
                    if (!u || typeof u.usuario !== 'string' || typeof u.password !== 'string') {
                        return false;
                    }
                    return u.usuario.toLowerCase() === username.toLowerCase() && 
                           u.password === password &&
                           u.activo === true;
                });

                if (!usuario) {
                    throw new Error('Usuario o contrase帽a incorrectos');
                }

                return usuario;

            } catch (error) {
                throw error;
            } finally {
                // Restaurar bot贸n
                loginBtn.innerHTML = 'Iniciar sesi贸n';
                loginBtn.disabled = false;
            }
        }

        // Redirigir seg煤n rol y permisos
        function redirigirSegunRol(usuario) {
            // Guardar informaci贸n del usuario en sessionStorage (solo para esta sesi贸n)
            sessionStorage.setItem('usuario_actual', JSON.stringify({
                usuario: usuario.usuario,
                rol: usuario.rol,
                permisos: usuario.permisos,
                activo: usuario.activo,
                fecha_registro: usuario.fecha_registro
            }));

            // Crear token de sesi贸n
            const sessionToken = btoa(`${usuario.usuario}:${Date.now()}`);
            sessionStorage.setItem('session_token', sessionToken);

            // Mostrar mensaje de 茅xito
            mostrarAlerta(`隆Bienvenido ${usuario.usuario}!`, 'success');
            
            // Redirigir seg煤n el rol
            setTimeout(() => {
                if (usuario.rol === 'presidente') {
                    // Presidente: modo solo lectura
                    window.location.href = `tesoreria.html?mode=readonly&user=${encodeURIComponent(usuario.usuario)}&token=${sessionToken}`;
                } else if (usuario.rol === 'tesorera') {
                    // Tesorera: acceso completo
                    window.location.href = `tesoreria.html?mode=full&user=${encodeURIComponent(usuario.usuario)}&token=${sessionToken}`;
                } else {
                    // Otros roles (por si acaso)
                    window.location.href = `tesoreria.html?mode=readonly&user=${encodeURIComponent(usuario.usuario)}&token=${sessionToken}`;
                }
            }, 800);
        }

        // Evento de login
        loginBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                mostrarAlerta('Por favor ingresa usuario y contrase帽a', 'error');
                return;
            }

            try {
                const usuario = await validarUsuario(username, password);
                redirigirSegunRol(usuario);
            } catch (error) {
                mostrarAlerta(error.message, 'error');
            }
        });

        // Permitir login con Enter
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                passwordInput.focus();
            }
        });

        // Verificar si ya hay sesi贸n activa
        (function verificarSesionActiva() {
            try {
                const usuarioActual = sessionStorage.getItem('usuario_actual');
                if (usuarioActual) {
                    const usuario = JSON.parse(usuarioActual);
                    // Preguntar si quiere continuar con la sesi贸n anterior
                    const continuar = confirm(`驴Continuar como ${usuario.usuario} (${usuario.rol})?`);
                    if (continuar) {
                        const token = sessionStorage.getItem('session_token');
                        const mode = usuario.rol === 'tesorera' ? 'full' : 'readonly';
                        window.location.href = `tesoreria.html?mode=${mode}&user=${encodeURIComponent(usuario.usuario)}&token=${token}`;
                    } else {
                        sessionStorage.clear();
                    }
                }
            } catch (e) {
                sessionStorage.clear();
            }
        })();
    </script>
</body>
</html>
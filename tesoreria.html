<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>JAC Bateas ¬∑ Control de Cuotas y Certificados</title>
    <style>
        /* ===== RESET Y VARIABLES - DISE√ëO CON COLORES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #4c724c 0%, #4c724c 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
        }

        .app {
            max-width: 1440px;
            width: 100%;
            background: white;
            border-radius: 28px;
            box-shadow: 0 15px 35px rgba(30, 74, 44, 0.08);
            padding: 5px;
            border: 1px solid rgba(200, 220, 200, 0.3);
        }

        /* ===== HEADER CON COLOR ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
            padding-bottom: 1px;
            border-bottom: 2px solid #d0e6d0;
        }

        .logo-area h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1a4a2a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-area h1 span {
            background: #e6f0e6;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #1a4a2a;
            letter-spacing: 0.3px;
            border: 1px solid #b8d8b8;
        }

        .year-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f2f9f2;
            padding: 6px 18px;
            border-radius: 100px;
            font-size: 0.85rem;
            color: #1a4a2a;
            border: 1px solid #c0e0c0;
            font-weight: 500;
        }

        .year-badge select {
            border: none;
            background: transparent;
            padding: 4px 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1a4a2a;
            outline: none;
            cursor: pointer;
        }

        /* ===== MODAL DE CONFIGURACI√ìN API ===== */
        .api-config {
            background: #f2f9f2;
            padding: 10px 15px;
            border-radius: 100px;
            border: 1px solid #c0e0c0;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-config input {
            border: 1px solid #a0c0a0;
            border-radius: 100px;
            padding: 6px 15px;
            width: 250px;
            font-size: 0.8rem;
            outline: none;
        }
        
        .api-config input:focus {
            border-color: #1a4a2a;
            box-shadow: 0 0 0 2px rgba(26, 74, 42, 0.2);
        }
        
        .api-config button {
            background: #1a4a2a;
            color: white;
            border: none;
            border-radius: 100px;
            padding: 6px 15px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .api-config button:hover {
            background: #2a6a3a;
        }

        /* ===== BOTONES CON COLORES ===== */
        .btn {
            border: none;
            padding: 8px 14px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.15s;
            background: white;
            color: #1e293b;
            border: 1px solid #d0e0d0;
        }

        .btn:hover {
            background: #f0f8f0;
            border-color: #a0c0a0;
        }

        .btn-primary {
            background: #1a4a2a;
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: #2a6a3a;
        }

        .btn-success {
            background: #1e7a4a;
            color: white;
            border: none;
        }
        .btn-success:hover {
            background: #2a8e5a;
        }

        .btn-warning {
            background: #fff1e0;
            color: #c10e0e;
            border: 1px solid #ff2100;
        }
        .btn-warning:hover {
            background: #ffe8d0;
        }

        /* ===== BARRA DE ACCIONES ===== */
        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 2px;
            align-items: center;
            background: #1a4a2a;
            padding: 12px 16px;
            border-radius: 20px;
            border: 1px solid #d8ecd8;
        }

        .search-box {
            flex: 1;
            min-width: 180px;
            display: flex;
            align-items: center;
            background: white;
            border: 1.5px solid #d8ecd8;
            border-radius: 10px;
            padding: 0 10px;
            transition: all 0.15s;
        }

        .search-box:focus-within {
            border-color: #2a7a4a;
            box-shadow: 0 0 0 3px rgba(42, 122, 74, 0.1);
        }

        .search-box input {
            flex: 1;
            padding: 8px 6px;
            border: none;
            background: transparent;
            font-size: 0.85rem;
        }
        .search-box input:focus { outline: none; }

        .report-group {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        /* ===== NUEVO: BADGE PARA SIGUIENTE RECIBO ===== */
        .next-receipt-badge {
            background: #ffd966;
            color: #1a4a2a;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 700;
            border: 1px solid #b68b40;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
        }
        .next-receipt-badge span {
            background: #1a4a2a;
            color: white;
            padding: 2px 8px;
            border-radius: 100px;
            font-size: 0.8rem;
        }

        /* ===== TARJETAS DE ESTAD√çSTICAS - 8 COLUMNAS M√ÅS PEQUE√ëAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-bottom: 5px;
            text-align: center;
        }

        .stat-card {
            background: white;
            padding: 8px 2px;
            border-radius: 8px;
            border: 1px solid #39b339;
            box-shadow: 0 2px 6px rgba(0, 40, 0, 0.02);
            border-top: 3px solid #8fc98f;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:nth-child(1) { border-top-color: #4a90e2; }
        .stat-card:nth-child(2) { border-top-color: #50c878; }
        .stat-card:nth-child(3) { border-top-color: #9370db; }
        .stat-card:nth-child(4) { border-top-color: #ffaa00; }
        .stat-card:nth-child(5) { border-top-color: #ff6b6b; }
        .stat-card:nth-child(6) { border-top-color: #b68b40; }
        .stat-card:nth-child(7) { border-top-color: #2a7a4a; }
        .stat-card:nth-child(8) { border-top-color: #ff4444; }

        .stat-label {
            font-size: 0.7rem;
            color: #4a6b4a;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            font-weight: 700;
            margin-bottom: 4px;
            white-space: nowrap;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a3a2a;
            line-height: 1.3;
            margin: 2px 0;
        }

        .stat-desc {
            font-size: 0.5rem;
            color: #6a8b6a;
            margin-top: 4px;
            white-space: nowrap;
        }

        /* ===== TABLA CON COLORES ===== */
        .table-section {
            background: #2b831c;
            border-radius: 20px;
            border: 3px solid #2b831c;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 40, 0, 0.02);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 5px;
            background: #f4fff4;
            border-bottom: 2px solid #c8e4c8;        
            background-color: #caddce;
        }

        .table-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1a4a2a;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            align-items: center;
        }
        .legend span { display: flex; align-items: center; gap: 4px; }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }

        th {
            background: #1a4a2a;
            color: rgb(255, 255, 255);
            font-weight: 600;
            padding: 10px 4px;
            text-align: center;
            font-size: 1.1rem;
            letter-spacing: 0.3px;
            align-content: center;
        }

        td {
            padding: 3px 3px;
            border-bottom: 1px solid #e8f4e8;
            vertical-align: middle;
            text-align: center;
            background: rgb(191, 255, 220);
            font-size: 15px;
            padding: 2px;
            background-color: #e7e6e6;
            font-weight: 500;
        }
        tr:hover td { background: #c7cac7; }

        .month-checkbox {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.1s;
        }

        .month-checkbox.debt {
            background: #fff1f0;
            border: 2px solid #d41515;
            cursor: pointer;
        }
        .month-checkbox.debt:hover {
            background: #ffe4e0;
            transform: scale(1.05);
            border-color: #c04040;
        }

        .month-checkbox.paid {
            background: #e4ffe4;
            border: 2px solid #5ab05a;
        }
        .month-checkbox.paid::after {
            content: "‚úì";
            color: #2a7a2a;
            font-weight: 700;
            font-size: 14px;
        }

        .month-checkbox.condoned {
            background: #e4ffe4;
            border: 2px solid #ffd966;
        }
        .month-checkbox.condoned::after {
            content: "‚úì";
            color: #2a7a2a;
            font-weight: 700;
            font-size: 14px;
        }

        .month-checkbox.future {
            background: #f0f8f0;
            border: 2px solid #a0c0a0;
            opacity: 0.6;
        }

        .month-checkbox.selected {
            background: #1a4a2a;
            border: 2px solid #1a4a2a;
        }
        .month-checkbox.selected::after {
            content: "‚úì";
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
            background: #f0f8f0;
            color: #1a4a2a;
        }

        .btn-detail {
            background: #e4f0e4;
            border: none;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.6rem;
            font-weight: 700;
            color: #1a4a2a;
            cursor: pointer;
            transition: all 0.1s;
            border: 1px solid #b8d8b8;
        }
        .btn-detail:hover { background: #d4e8d4; }

        /* ===== PAGINACI√ìN CENTRADA ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 16px;
            gap: 16px;
            border-top: 2px solid #d8ecd8;
            background: #caddce;
            flex-wrap: wrap;
        }

        .pagination-controls {
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .page-btn {
            min-width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: 1px solid #c8e0c8;
            background: white;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            color: #1a4a2a;
            padding: 0 4px;
        }
        .page-btn:hover {
            background: #e0f0e0;
        }
        .page-btn.active {
            background: #1a4a2a;
            color: white;
            border-color: #1a4a2a;
        }

        .page-input {
            width: 50px;
            padding: 4px;
            border: 2px solid #c8e0c8;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            color: #1a4a2a;
            font-size: 0.7rem;
        }

        /* ===== MODALES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 74, 42, 0.4);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 40, 0, 0.3);
            border: 1px solid #d0e4d0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #c8e4c8;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        .modal-header h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #1a4a2a;
            text-align: center;
            flex: 1;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #6a8b6a;
            padding: 2px 6px;
        }
        .close-btn:hover { color: #1a4a2a; }

        .receipt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 74, 42, 0.4);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 20px;
        }

        .receipt-content {
            background: white;
            border-radius: 24px;
            max-width: 400px;
            width: 100%;
            padding: 20px;
            border: 1px solid #d0e4d0;
        }

        .receipt-info {
            background: #f2fff2;
            padding: 12px;
            border-radius: 14px;
            margin-bottom: 16px;
            border-left: 6px solid;
        }

        /* ===== SELECTOR DE TIPO DE PAGO ===== */
        .payment-type-selector {
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fff8;
            border-radius: 14px;
            border: 2px solid #d0e4d0;
        }
        .payment-type-selector label {
            display: block;
            margin-bottom: 6px;
            font-weight: 700;
            color: #1a4a2a;
            font-size: 0.8rem;
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            margin-bottom: 2px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .payment-option.selected {
            background: #e4ffe4;
            border: 2px solid #2a7a4a;
        }
        .payment-option input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .payment-option .valor {
            font-weight: 700;
            color: #1a4a2a;
            margin-left: auto;
            font-size: 0.8rem;
        }

        .receipt-field {
            margin-bottom: 16px;
        }
        .receipt-field label {
            display: block;
            font-size: 0.65rem;
            font-weight: 700;
            color: #1a4a2a;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .receipt-field input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #d0e4d0;
            border-radius: 10px;
            font-size: 0.85rem;
        }
        .receipt-field input:focus {
            border-color: #2a7a4a;
            outline: none;
        }

        .month-badge {
            background: #ffffff;
            color: rgb(0, 0, 0);
            padding: 2px 8px;
            border-radius: 100px;
            font-size: 0.6rem;
            display: inline-block;
            margin: 1px;
        }

        .hidden { display: none !important; }
        .loading { animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            display: none;
            z-index: 10002;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .alert.show { display: block; }
        .alert-success { background: #e4ffe4; color: #1a4a2a; border-left: 6px solid #2a8e5a; }
        .alert-error { background: #ffe4e4; color: #8a2a2a; border-left: 6px solid #c04040; }
        .alert-info { background: #e4f0ff; color: #2a4a6a; border-left: 6px solid #4a8ac0; }

        /* ===== BADGE DE INACTIVIDAD ===== */
        .session-timer {
            background: #f0f0f0;
            color: #1a4a2a;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #c0c0c0;
            margin-right: 10px;
        }
        
        .timer-warning {
            background: #ffd966;
            color: #1a4a2a;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ===== INDICADOR DE SINCRONIZACI√ìN ===== */
        .sync-status {
            background: #f0f0f0;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #c0c0c0;
            margin-right: 10px;
        }
        
        .sync-status.syncing {
            background: #fff3cd;
            border-color: #ffd966;
            animation: pulse 1s infinite;
        }
        
        .sync-status.offline {
            background: #ffe4e4;
            border-color: #ff9999;
            color: #c04040;
        }
        
        .sync-status.online {
            background: #e4ffe4;
            border-color: #5ab05a;
            color: #1a7a3a;
        }

        /* Responsive para m√≥viles */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (max-width: 800px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .btn-cert-leyenda {
            background: #1a4a2a;
            color: white;
            border: none;
            padding: 3px 7px;
            border-radius: 100px;
            font-size: 0.6rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 2px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #9e7635;
        }

        .btn-cert-leyenda:hover {
            background: #1a4a2a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-cert-leyenda:active {
            transform: translateY(0);
        }

        .btn-cert-leyenda.disabled {
            background: #cccccc;
            border-color: #999999;
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        /* ===== TARJETAS CON VOLTEO ===== */
        .stats-grid {
            perspective: 1000px;
        }

        .stat-card {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
            position: relative;
            min-height: 90px;
        }

        .stat-card.flipped {
            transform: rotateY(180deg);
        }

        .stat-card .stat-front,
        .stat-card .stat-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            top: 0;
            left: 0;
            padding: 8px 2px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: white;
        }

        .stat-card .stat-front {
            transform: rotateY(0deg);
            z-index: 2;
        }

        .stat-card .stat-back {
            transform: rotateY(180deg);
            background: #1a4a2a;
            color: white;
            align-items: center;
            justify-content: center;
            gap: 5px;
            border: 2px solid #ffd966;
        }

        .stat-back .eye-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .stat-back .back-text {
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            padding: 0 5px;
        }

        .stat-card:nth-child(1) .stat-back { border-top: 3px solid #4a90e2; }
        .stat-card:nth-child(2) .stat-back { border-top: 3px solid #50c878; }
        .stat-card:nth-child(3) .stat-back { border-top: 3px solid #9370db; }
        .stat-card:nth-child(4) .stat-back { border-top: 3px solid #ffaa00; }
        .stat-card:nth-child(5) .stat-back { border-top: 3px solid #ff6b6b; }
        .stat-card:nth-child(6) .stat-back { border-top: 3px solid #b68b40; }
        .stat-card:nth-child(7) .stat-back { border-top: 3px solid #2a7a4a; }
        .stat-card:nth-child(8) .stat-back { border-top: 3px solid #ff4444; }
    </style>
</head>
<body>
    <!-- APLICACI√ìN PRINCIPAL -->
    <div class="app" id="mainApp">
        <!-- HEADER -->
        <div class="header">
            <div class="logo-area">
                <h1 style="text-align: center; align-items: center;">
                    üåø Sistema de Recaudo - Junta de Accion Comunal Bateas sector 3
                </h1>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <!-- CONFIGURACI√ìN API - TOKEN ELIMINADO DEL C√ìDIGO -->
                <div class="api-config">
                    <input type="password" id="apiTokenInput" placeholder="clave dinamica" value="">
                    <button id="saveTokenBtn">Guardar</button>
                </div>
               
                <!-- Temporizador de inactividad -->
                <div id="sessionTimer" class="session-timer">
                    <span>‚è±Ô∏è</span>
                    <span id="timerDisplay">5:00</span>
                </div>
                <div class="year-badge">
                    <span>üìÖ</span>
                    <select id="yearSelect"></select>
                </div>
                <button id="logoutBtn" class="btn" style="background: #c04040; color: white; border: none; padding: 6px 12px; border-radius: 100px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                    <span>üö™</span> Salir
                </button>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACI√ìN DE CIERRE DE SESI√ìN -->
        <div id="logoutConfirmModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div class="modal-header">
                    <h3 style="text-align: center; flex: 1;">üîí Cerrar sesi√≥n</h3>
                    <button class="close-btn" id="closeLogoutModalBtn">&times;</button>
                </div>
                <div style="padding: 20px 0;">
                    <p style="margin-bottom: 20px; font-size: 1rem;">¬øEst√°s seguro que deseas cerrar la sesi√≥n?</p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="confirmLogoutBtn" class="btn" style="background: #c04040; color: white; border: none; padding: 8px 20px;">S√≠, salir</button>
                        <button id="cancelLogoutBtn" class="btn">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE SESI√ìN EXPIRADA -->
        <div id="sessionExpiredModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div class="modal-header">
                    <h3 style="text-align: center; flex: 1;">‚è∞ Sesi√≥n expirada</h3>
                </div>
                <div style="padding: 20px 0;">
                    <p style="margin-bottom: 20px; font-size: 1rem;">Tu sesi√≥n ha expirado por inactividad de 5 minutos.</p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="redirectToLoginBtn" class="btn btn-primary">Ir al inicio de sesi√≥n</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALERTAS FLOTANTES -->
        <div id="alertMessage" class="alert"></div>

        <!-- ACCIONES -->
        <div class="action-bar">
            <div class="search-box">
                <span style="color: #6a8b6a;">üîç</span>
                <input type="text" id="searchInput" placeholder="Buscar por c√©dula o n√∫mero de recibo...">
            </div>
            <button id="toggleTableBtn" class="btn btn-primary">
                üìã Mostrar tabla
            </button>
            <!-- BOT√ìN DE TARJETAS MOVIDO AQU√ç -->
            <button id="toggleAllCardsBtn" class="btn" style="background: #1a4a2a; color: white;" title="Mostrar/ocultar todas las tarjetas">
                <span>üëÅÔ∏è</span> Tarjetas
            </button>
            <div class="report-group">
                <button id="paymentsTodayBtn" class="btn">üìÖ Hoy</button>
                <button id="paymentsMonthBtn" class="btn">üìÜ Mes</button>
                <button id="paymentsYearBtn" class="btn">üìä A√±o</button>
                <button id="paymentsAllBtn" class="btn">üìã Todos</button>
                <button id="certificatesReportBtn" class="btn" style="background: #ffd966;">üìú Certificados</button>
            </div>
            <!-- Badge con el siguiente n√∫mero de recibo (5 d√≠gitos) -->
            <div class="next-receipt-badge">
                Sgte. Recibo <span id="nextReceiptNumber">00001</span>
            </div>
        </div>

        <!-- ESTAD√çSTICAS CON VOLTEO -->
        <div class="stats-grid">
            <div class="stat-card" onclick="this.classList.toggle('flipped')">
                <div class="stat-front">
                    <div class="stat-label">üë• Afiliados</div>
                    <div class="stat-value" id="totalAfiliados">0</div>
                    <div class="stat-desc">total registrados</div>
                </div>
                <div class="stat-back">
                    <div class="eye-icon">üëÅÔ∏è</div>
                    <div class="back-text">Toca para ver</div>
                </div>
            </div>
            <div class="stat-card" onclick="this.classList.toggle('flipped')">
                <div class="stat-front">
                    <div class="stat-label">‚úÖ Al d√≠a</div>
                    <div class="stat-value" id="usuariosAlDia">0</div>
                    <div class="stat-desc">sin deuda</div>
                </div>
                <div class="stat-back">
                    <div class="eye-icon">üëÅÔ∏è</div>
                    <div class="back-text">Toca para ver</div>
                </div>
            </div>
            <div class="stat-card" onclick="this.classList.toggle('flipped')">
                <div class="stat-front">
                    <div class="stat-label">üìÜ Meses pagados</div>
                    <div class="stat-value" id="mesesPagados">0</div>
                    <div class="stat-desc">cancelados</div>
                </div>
                <div class="stat-back">
                    <div class="eye-icon">üëÅÔ∏è</div>
                    <div class="back-text">Toca para ver</div>
                </div>
            </div>
            <div class="stat-card" onclick="this.classList.toggle('flipped')">
                <div class="stat-front">
                    <div class="stat-label">üìú Certificados</div>
                    <div class="stat-value" id="totalCertificados">0</div>
                    <div class="stat-desc">emitidos</div>
                </div>
                <div class="stat-back">
                    <div class="eye-icon">üëÅÔ∏è</div>
                    <div class="back-text">Toca para ver</div>
                </div>
            </div>
            <div class="stat-card" onclick="this.classList.toggle('flipped')">
                <div class="stat-front">
                    <div class="stat-label">üí∞ Recaudado cuotas</div>
                    <div class="stat-value" id="recaudadoCuotas">$0</div>
                    <div class="stat-desc">valor cuotas</div>
                </div>
                <div class="stat-back">
                    <div class="eye-icon">üëÅÔ∏è</div>
                    <div class="back-text">Toca para ver</div>
                </div>
            </div>
            <div class="stat-card" onclick="this.classList.toggle('flipped')">
                <div class="stat-front">
                    <div class="stat-label">üßæ Recaudado certificados</div>
                    <div class="stat-value" id="recaudadoCertificados">$0</div>
                    <div class="stat-desc">valor certificados</div>
                </div>
                <div class="stat-back">
                    <div class="eye-icon">üëÅÔ∏è</div>
                    <div class="back-text">Toca para ver</div>
                </div>
            </div>
            <div class="stat-card" onclick="this.classList.toggle('flipped')">
                <div class="stat-front">
                    <div class="stat-label">üí∞ Total recaudado</div>
                    <div class="stat-value" id="totalRecaudado">$0</div>
                    <div class="stat-desc">general</div>
                </div>
                <div class="stat-back">
                    <div class="eye-icon">üëÅÔ∏è</div>
                    <div class="back-text">Toca para ver</div>
                </div>
            </div>
            <div class="stat-card" onclick="this.classList.toggle('flipped')">
                <div class="stat-front">
                    <div class="stat-label">‚ö†Ô∏è Deuda total</div>
                    <div class="stat-value" id="deudaTotal">$0</div>
                    <div class="stat-desc">pendiente</div>
                </div>
                <div class="stat-back">
                    <div class="eye-icon">üëÅÔ∏è</div>
                    <div class="back-text">Toca para ver</div>
                </div>
            </div>
        </div>

        <!-- TABLA CON PAGINACI√ìN -->
        <div id="tableContainer" style="display: none;">
            <div class="table-section">
                <div class="table-header">
                        <div class="table-title">
                            üìã Registro de pagos ¬∑ <span style="background: #d0e8d0; padding: 4px 14px; border-radius: 100px;" id="a√±oActualDisplay"></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <!-- NUEVO BOT√ìN DE CERTIFICADO AQU√ç -->
                            <button id="pagarCertificadoBtn" class="btn-cert-leyenda" title="Pagar certificado del usuario filtrado">
                                <span style="font-size: 1.2rem;">üìú</span> Pagar Certificado
                            </button>
                             
                            
                            <div class="legend">
                                <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="color: #dd2626; font-size: 24px; position: relative; top: -3px;">‚óè</span>Debe</span>
                                <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="color: #2aac2a; font-size: 24px; position: relative; top: -3px;">‚óè</span>Pagado</span>
                                <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="color: #ffd966; font-size: 24px; position: relative; top: -3px;">‚óè</span>Condonado</span>
                                <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="color: #ffffff; font-size: 24px; position: relative; top: -3px;">‚óè</span>Futuro</span>
                                <span style="display: inline-flex; align-items: center; gap: 4px;"><span style="color: #ffd966; font-size: 12px; position: relative; top: -3px;">üìú</span>Certificado</span>
                            </div>
                        </div>
                    </div>
                <div class="table-responsive">
                    <table id="paymentsTable">
                        <thead id="tableHeader">
                            <tr>
                                <th>C√©dula</th>
                                <th>Nombre y Apellidos</th>
                                <th>Afiliaci√≥n</th>
                                <th>Deuda</th>
                                <th>Cert</th>
                                <th>Detalle</th>
                                <th>Ene</th>
                                <th>Feb</th>
                                <th>Mar</th>
                                <th>Abr</th>
                                <th>May</th>
                                <th>Jun</th>
                                <th>Jul</th>
                                <th>Ago</th>
                                <th>Sep</th>
                                <th>Oct</th>
                                <th>Nov</th>
                                <th>Dic</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
                
                <!-- PAGINACI√ìN CENTRADA -->
                <div class="pagination" id="paginationContainer">
                    <div style="display: flex; gap: 2px; align-items: center;">
                        <span style="font-size: 0.7rem; color: #4a6b4a; font-weight: 600;">üìå p√°gina</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="page-btn" id="prevPageBtn">‚Äπ</button>
                        <div id="pageNumbers" style="display: flex; gap: 4px;"></div>
                        <button class="page-btn" id="nextPageBtn">‚Ä∫</button>
                        <div style="display: flex; align-items: center; gap: 6px; margin-left: 6px;">
                            <span style="font-size: 0.65rem; font-weight: 600;">Ir a</span>
                            <input type="number" id="pageInput" class="page-input" min="1" value="1">
                            <button class="page-btn" id="goToPageBtn">‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 12px; margin-top: 16px;">
                
                <button id="savePaymentsBtn" class="btn btn-success">üíæ Guardar Todo</button>
            </div>
        </div>

        <!-- MODAL DE RECIBO -->
        <div id="receiptModal" class="receipt-modal">
            <div class="receipt-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #1a4a2a;">üßæ Registrar pago</h3>
                    <button id="closeReceiptBtn" style="background: none; border: none; font-size: 1.3rem; cursor: pointer; color: #6a8b6a;">&times;</button>
                </div>
                <div id="receiptInfo" class="receipt-info"></div>
                
                <!-- Selector de tipo de pago -->
                <div class="payment-type-selector">
                    <label>TIPO DE PAGO</label>
                    <div class="payment-option selected" id="optionCuota">
                        <input type="radio" name="tipoPago" id="tipoCuota" value="cuota" checked>
                        <span>üí∞ Cuota mensual</span>
                        <span class="valor">$5.000</span>
                    </div>
                    <div class="payment-option" id="optionCertificado">
                        <input type="radio" name="tipoPago" id="tipoCertificado" value="certificado">
                        <span>üìú Certificado</span>
                        <span class="valor">$20.000</span>
                    </div>
                </div>

                <div class="receipt-field">
                    <label>N√öMERO DE RECIBO</label>
                    <!-- Placeholder actualizado a 5 d√≠gitos -->
                    <input type="text" id="receiptNumber" placeholder="Ej: 00001, 00002..." value="">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button id="cancelReceiptBtn" class="btn">Cancelar</button>
                    <button id="saveReceiptBtn" class="btn btn-success">Guardar pago</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE REPORTE -->
        <div id="reportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="reportTitle">Reporte de pagos</h3>
                    <div style="display: flex; gap: 2px;">
                        <button id="printReportBtn" class="btn" style="padding: 4px 10px;">üñ®Ô∏è</button>
                        <button class="close-btn" id="closeReportModalBtn">&times;</button>
                    </div>
                </div>
                <div id="reportContent" style="overflow-x: auto;"></div>
            </div>
        </div>

        <!-- MODAL DE DETALLE -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalNombre">Detalle del afiliado</h3>
                    <div style="display: flex; gap: 2px;">
                        <button id="printDetailBtn" class="btn" style="padding: 4px 10px;">üñ®Ô∏è</button>
                        <button class="close-btn" id="closeModalBtn">&times;</button>
                    </div>
                </div>
                <div id="modalContent"></div>
            </div>
        </div>

        <div style="margin-top: 24px; text-align: center; color: #6a8b6a; font-size: 0.6rem; font-weight: 500;">
            <span>Junta de Acci√≥n Comunal Barrio Bateas ¬∑ Puerto Gait√°n, Meta</span>
            <span style="margin-left: 16px;">üìÖ <span id="fechaActualDisplay"></span></span>
        </div>
    </div>
    
    <script>
        // ============================================================
        // VERIFICACI√ìN DE AUTENTICACI√ìN - DEBE IR AL INICIO DEL SCRIPT
        // ============================================================
        (function verificarAutenticacion() {
            // Obtener par√°metros de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const user = urlParams.get('user');
            const mode = urlParams.get('mode');
            
            // Verificar si hay sesi√≥n en sessionStorage
            const sessionToken = sessionStorage.getItem('session_token');
            const usuarioActual = sessionStorage.getItem('usuario_actual');
            
            // Si no hay token en URL ni en sessionStorage, redirigir al login
            if (!token && !sessionToken) {
                window.location.href = 'index.html';
                return;
            }
            
            // Si hay token en URL pero no en sessionStorage, guardarlo
            if (token && !sessionToken) {
                sessionStorage.setItem('session_token', token);
            }
            
            // Si hay usuario en URL pero no en sessionStorage, guardarlo
            if (user && !usuarioActual) {
                try {
                    const usuarioInfo = {
                        usuario: user,
                        rol: mode === 'full' ? 'tesorera' : 'presidente',
                        modo: mode
                    };
                    sessionStorage.setItem('usuario_actual', JSON.stringify(usuarioInfo));
                } catch (e) {
                    console.error('Error al guardar usuario:', e);
                }
            }
            
            // Verificaci√≥n final: si no hay usuario en sessionStorage, redirigir
            if (!sessionStorage.getItem('usuario_actual')) {
                window.location.href = 'index.html';
            }
        })();

        // ============================================================
        // JAC BATEAS - VERSI√ìN CON CACH√â LOCAL Y GITHUB
        // ============================================================
        const CONFIG = {
            REPO_OWNER: 'carlos2601',
            REPO_NAME: 'juntadeaccioncomunalbarriobateaspuertogaitanmetalilianalondo-ogallego1010101010101000111010001010010',
            AFILIADOS_PATH: 'afiliados.json',
            CUOTA_PATH: 'cuota.json',
            BRANCH: 'main',
            VALOR_CUOTA: 5000,
            VALOR_CERTIFICADO: 20000,
            PAGE_SIZE: 6
            // API_TOKEN ELIMINADO - ahora se configura manualmente
        };

        let appState = {
            afiliados: [],
            pagos: [],
            token: null, // Inicialmente null, se cargar√° de sessionStorage o se pedir√°
            fechaActual: new Date(),
            tablaVisible: false,
            filtroActual: '',
            modoBusqueda: false,
            selectedYear: new Date().getFullYear(),
            pendingPayment: null,
            currentPage: 1,
            totalPages: 1,
            ultimoTipoBusqueda: '',
            sincronizando: false,
            modoOffline: false,
            ultimaSincronizacion: null
        };

        // Cargar token guardado si existe
        const savedToken = sessionStorage.getItem('github_token');
        if (savedToken) {
            appState.token = savedToken;
        }

        // ============================================================
        // VARIABLES PARA INACTIVIDAD (5 MINUTOS)
        // ============================================================
        let inactivityTimer;
        const INACTIVITY_TIME = 5 * 60 * 1000; // 5 minutos en milisegundos
        let timerInterval;
        let remainingSeconds = 5 * 60; // 300 segundos

        const dom = {
            mainApp: document.getElementById('mainApp'),
            tableContainer: document.getElementById('tableContainer'),
            tableBody: document.getElementById('tableBody'),
            tableHeader: document.getElementById('tableHeader'),
            alertMessage: document.getElementById('alertMessage'),
            searchInput: document.getElementById('searchInput'),
            toggleTableBtn: document.getElementById('toggleTableBtn'),
            paymentsTodayBtn: document.getElementById('paymentsTodayBtn'),
            paymentsMonthBtn: document.getElementById('paymentsMonthBtn'),
            paymentsYearBtn: document.getElementById('paymentsYearBtn'),
            paymentsAllBtn: document.getElementById('paymentsAllBtn'),
            certificatesReportBtn: document.getElementById('certificatesReportBtn'),
            yearSelect: document.getElementById('yearSelect'),
            a√±oActualDisplay: document.getElementById('a√±oActualDisplay'),
            totalAfiliados: document.getElementById('totalAfiliados'),
            usuariosAlDia: document.getElementById('usuariosAlDia'),
            mesesPagados: document.getElementById('mesesPagados'),
            totalRecaudado: document.getElementById('totalRecaudado'),
            totalCertificados: document.getElementById('totalCertificados'),
            recaudadoCertificados: document.getElementById('recaudadoCertificados'),
            deudaTotal: document.getElementById('deudaTotal'),
            recaudadoCuotas: document.getElementById('recaudadoCuotas'),
            fechaActualDisplay: document.getElementById('fechaActualDisplay'),
            modal: document.getElementById('detailModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            printDetailBtn: document.getElementById('printDetailBtn'),
            modalNombre: document.getElementById('modalNombre'),
            modalContent: document.getElementById('modalContent'),
            reportModal: document.getElementById('reportModal'),
            closeReportModalBtn: document.getElementById('closeReportModalBtn'),
            printReportBtn: document.getElementById('printReportBtn'),
            reportTitle: document.getElementById('reportTitle'),
            reportContent: document.getElementById('reportContent'),
            receiptModal: document.getElementById('receiptModal'),
            closeReceiptBtn: document.getElementById('closeReceiptBtn'),
            cancelReceiptBtn: document.getElementById('cancelReceiptBtn'),
            saveReceiptBtn: document.getElementById('saveReceiptBtn'),
            receiptInfo: document.getElementById('receiptInfo'),
            receiptNumber: document.getElementById('receiptNumber'),
            nextReceiptNumber: document.getElementById('nextReceiptNumber'),
            tipoCuota: document.getElementById('tipoCuota'),
            tipoCertificado: document.getElementById('tipoCertificado'),
            optionCuota: document.getElementById('optionCuota'),
            optionCertificado: document.getElementById('optionCertificado'),
            paginationContainer: document.getElementById('paginationContainer'),
            prevPageBtn: document.getElementById('prevPageBtn'),
            nextPageBtn: document.getElementById('nextPageBtn'),
            pageNumbers: document.getElementById('pageNumbers'),
            pageInput: document.getElementById('pageInput'),
            goToPageBtn: document.getElementById('goToPageBtn'),
            sessionTimer: document.getElementById('sessionTimer'),
            timerDisplay: document.getElementById('timerDisplay'),
            sessionExpiredModal: document.getElementById('sessionExpiredModal'),
            syncStatus: document.getElementById('syncStatus'),
            syncIcon: document.getElementById('syncIcon'),
            syncText: document.getElementById('syncText'),
            apiTokenInput: document.getElementById('apiTokenInput'),
            saveTokenBtn: document.getElementById('saveTokenBtn')
        };

        // ============================================================
        // FUNCIONES DE INACTIVIDAD
        // ============================================================
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(handleInactivity, INACTIVITY_TIME);
            remainingSeconds = 5 * 60;
            updateTimerDisplay();
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerDisplay, 1000);
            if (dom.sessionTimer) {
                dom.sessionTimer.classList.remove('timer-warning');
            }
        }

        function updateTimerDisplay() {
            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
                return;
            }
            remainingSeconds--;
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            if (dom.timerDisplay) {
                dom.timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            if (remainingSeconds < 60) {
                dom.sessionTimer.classList.add('timer-warning');
            }
        }

        function handleInactivity() {
            clearInterval(timerInterval);
            clearTimeout(inactivityTimer);
            if (dom.sessionExpiredModal) {
                dom.sessionExpiredModal.style.display = 'flex';
            }
            sessionStorage.clear();
        }

        function initActivityDetection() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer);
            });
            resetInactivityTimer();
        }

        // ============================================================
        // FUNCIONES DE CACH√â LOCAL
        // ============================================================
        function guardarPagosEnLocalStorage() {
            try {
                const datosCache = {
                    pagos: appState.pagos,
                    ultimaSincronizacion: new Date().toISOString(),
                    version: '1.0'
                };
                localStorage.setItem('jac_pagos_cache', JSON.stringify(datosCache));
                console.log('üíæ Pagos guardados en cach√© local');
                return true;
            } catch (e) {
                console.error('Error guardando en localStorage:', e);
                return false;
            }
        }

        function cargarPagosDesdeLocalStorage() {
            try {
                const cache = localStorage.getItem('jac_pagos_cache');
                if (cache) {
                    const datosCache = JSON.parse(cache);
                    console.log('üì¶ Cargando pagos desde cach√© local');
                    appState.pagos = datosCache.pagos || [];
                    appState.ultimaSincronizacion = datosCache.ultimaSincronizacion;
                    if (appState.ultimaSincronizacion) {
                        const ultima = new Date(appState.ultimaSincronizacion);
                        const ahora = new Date();
                        const minutosPasados = (ahora - ultima) / (1000 * 60);
                        if (minutosPasados < 5) {
                            appState.modoOffline = false;
                        } else {
                            appState.modoOffline = true;
                        }
                    }
                    return true;
                }
            } catch (e) {
                console.error('Error cargando desde localStorage:', e);
            }
            return false;
        }

        async function sincronizarConGitHub() {
            if (appState.sincronizando) return;
            
            // Verificar que hay token
            if (!appState.token) {
                mostrarAlerta('‚ùå Debes configurar el token de GitHub primero', 'error');
                return;
            }
            
            appState.sincronizando = true;
            actualizarIndicadorSync();
            
            try {
                console.log('üîÑ Sincronizando con GitHub...');
                const pagosGitHub = await cargarPagos();
                
                const pagosCombinados = [...pagosGitHub];
                appState.pagos.forEach(pagoLocal => {
                    const index = pagosCombinados.findIndex(p => p.cedula === pagoLocal.cedula);
                    if (index >= 0) {
                        pagosCombinados[index] = pagoLocal;
                    } else {
                        pagosCombinados.push(pagoLocal);
                    }
                });
                
                appState.pagos = pagosCombinados;
                appState.ultimaSincronizacion = new Date().toISOString();
                appState.modoOffline = false;
                
                guardarPagosEnLocalStorage();
                
                console.log('‚úÖ Sincronizaci√≥n completada');
                
                guardarPagosEnGitHub().catch(e => {
                    console.log('‚ö†Ô∏è No se pudo guardar en GitHub, pero los datos est√°n en cach√©');
                });
                
                calcularEstadisticas();
                actualizarSiguienteRecibo();
                renderizarTabla();
                
                mostrarAlerta('‚úÖ Datos sincronizados con GitHub', 'success');
                
            } catch (e) {
                console.error('Error en sincronizaci√≥n:', e);
                appState.modoOffline = true;
                mostrarAlerta('‚ö†Ô∏è Sin conexi√≥n a GitHub. Usando datos locales.', 'warning');
            } finally {
                appState.sincronizando = false;
                actualizarIndicadorSync();
            }
        }

        function actualizarIndicadorSync() {
            // Este elemento no existe en el HTML actual, lo omitimos
        }

        // ============================================================
        // FUNCI√ìN DE CONDONACI√ìN
        // ============================================================
        function esMesCondonado(a√±o, mes) {
            if (a√±o === 2024) return true;
            if (a√±o === 2025 && mes >= 0 && mes <= 10) return true;
            return false;
        }

        // ============================================================
        // INICIO - CARGAR DATOS CON CACH√â
        // ============================================================
        async function cargarDatosIniciales() {
            try {
                mostrarAlerta('üì• Cargando afiliados...', 'info');
                appState.afiliados = await cargarAfiliados();
                
                // Intentar cargar pagos desde cach√© primero
                if (cargarPagosDesdeLocalStorage()) {
                    mostrarAlerta('üì• Pagos cargados desde cach√© local', 'info');
                } else {
                    mostrarAlerta('üì• Cargando pagos desde GitHub...', 'info');
                    appState.pagos = await cargarPagos();
                }
                
                calcularEstadisticas();
                actualizarSiguienteRecibo();
                
                appState.tablaVisible = true;
                dom.tableContainer.style.display = 'block';
                dom.toggleTableBtn.innerHTML = 'üïµÔ∏è Ocultar tabla';
                
                appState.modoBusqueda = false;
                appState.filtroActual = '';
                dom.searchInput.value = '';
                
                appState.currentPage = 1;
                renderizarTabla();
                
                mostrarAlerta(`‚úÖ ${appState.afiliados.length} afiliados cargados`, 'success');
                
                initActivityDetection();
                
            } catch (e) {
                mostrarAlerta('Error al cargar datos: ' + e.message, 'error');
            }
        }

        // ============================================================
        // UTILIDADES
        // ============================================================
        function parseFecha(fechaStr) {
            if (!fechaStr) return new Date();
            const partes = fechaStr.split('/');
            return new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
        }

        function formatearFecha(date) {
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatearHora(date) {
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

       function extraerPagosDeString(str, a√±o) {
    if (!str) return [];
    return str.split(';').filter(p => p.trim()).map(p => {
        const partes = p.trim().split('_');
        // Nuevo formato: mes_a√±o_valor_fecha_hora_recibo
        // partes[0]=mes, [1]=a√±o, [2]=valor, [3]=fecha, [4]=hora, [5]=recibo
        return {
            mes: partes[0],
            a√±o: parseInt(partes[1]),
            valor: parseInt(partes[2]),
            fecha: partes[3],
            hora: partes[4] || '00:00:00', // Si no hay hora (datos antiguos), asumir 00:00:00
            recibo: partes[5] || partes[4] || 'N/A' // Compatibilidad hacia atr√°s
        };
    }).filter(p => p.a√±o === a√±o);
}

        function extraerCertificadosDeString(str) {
    if (!str) return [];
    return str.split(';').filter(c => c.trim()).map(c => {
        const partes = c.trim().split('_');
        return {
            mes: partes[0],
            a√±o: parseInt(partes[1]),
            valor: parseInt(partes[2]),
            fecha: partes[3],
            hora: partes[4] || '00:00:00',
            recibo: partes[5] || 'N/A'
        };
    });
}

        function obtenerTodosLosPagos() {
            const pagos = [];
            appState.pagos.forEach(reg => {
                const afiliado = appState.afiliados.find(a => a.cedula === reg.cedula);
                const nombre = afiliado ? afiliado.nombre : reg.nombre;
                
                for (let a√±o = 2024; a√±o <= appState.fechaActual.getFullYear(); a√±o++) {
                    const campo = `fecha_pago_a√±o_${a√±o}`;
                    const pagosA√±o = extraerPagosDeString(reg[campo], a√±o);
                    pagosA√±o.forEach(p => {
                        pagos.push({
                            cedula: reg.cedula,
                            nombre,
                            tipo: 'cuota',
                            ...p,
                            fechaObj: new Date(p.fecha.split('/')[2], p.fecha.split('/')[1] - 1, p.fecha.split('/')[0])
                        });
                    });
                }
                
                if (reg.certificado) {
                    const certificados = extraerCertificadosDeString(reg.certificado);
                    certificados.forEach(c => {
                        pagos.push({
                            cedula: reg.cedula,
                            nombre,
                            tipo: 'certificado',
                            mes: c.mes,
                            a√±o: c.a√±o,
                            valor: c.valor,
                            fecha: c.fecha,
                            hora: c.hora,
                            recibo: c.recibo,
                            fechaObj: new Date(c.fecha.split('/')[2], c.fecha.split('/')[1] - 1, c.fecha.split('/')[0])
                        });
                    });
                }
            });
            return pagos;
        }

        function obtenerUltimosAfiliadosConPagos() {
            const todosPagos = obtenerTodosLosPagos();
            const pagosOrdenados = [...todosPagos].sort((a, b) => b.fechaObj - a.fechaObj);
            const cedulasUnicas = [];
            const afiliadosUnicos = [];
            
            for (const pago of pagosOrdenados) {
                if (!cedulasUnicas.includes(pago.cedula)) {
                    cedulasUnicas.push(pago.cedula);
                    const afiliado = appState.afiliados.find(a => a.cedula === pago.cedula);
                    if (afiliado) {
                        afiliadosUnicos.push(afiliado);
                    }
                    if (afiliadosUnicos.length >= CONFIG.PAGE_SIZE) {
                        break;
                    }
                }
            }
            return afiliadosUnicos;
        }

        function mesEstaPagado(cedula, a√±o, mes) {
            const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            const registro = appState.pagos.find(p => p.cedula === cedula);
            if (!registro) return false;
            const pagosStr = registro[`fecha_pago_a√±o_${a√±o}`] || '';
            return pagosStr.split(';').some(p => p.trim().startsWith(`${meses[mes]}_${a√±o}`));
        }

        function obtenerEstadoMes(cedula, a√±o, mes, fechaAfiliacion) {
            const afiliacion = parseFecha(fechaAfiliacion);
            const hoy = appState.fechaActual;
            
            if (a√±o < afiliacion.getFullYear() || (a√±o === afiliacion.getFullYear() && mes < afiliacion.getMonth())) {
                return 'no-visible';
            }
            
            if (mesEstaPagado(cedula, a√±o, mes)) {
                return 'paid';
            }
            
            if (a√±o > hoy.getFullYear() || (a√±o === hoy.getFullYear() && mes > hoy.getMonth())) {
                return 'future';
            }
            
            if (esMesCondonado(a√±o, mes)) {
                return 'condoned';
            }
            
            return 'debt';
        }

        function calcularMesesDeuda(cedula, fechaAfiliacion) {
            const afiliacion = parseFecha(fechaAfiliacion);
            const hoy = appState.fechaActual;
            const mesesDeuda = [];
            
            for (let a√±o = afiliacion.getFullYear(); a√±o <= hoy.getFullYear(); a√±o++) {
                const mesInicio = (a√±o === afiliacion.getFullYear()) ? afiliacion.getMonth() : 0;
                const mesFin = (a√±o === hoy.getFullYear()) ? hoy.getMonth() : 11;
                
                for (let mes = mesInicio; mes <= mesFin; mes++) {
                    if (!mesEstaPagado(cedula, a√±o, mes) && !esMesCondonado(a√±o, mes)) {
                        mesesDeuda.push({ a√±o, mes });
                    }
                }
            }
            return mesesDeuda;
        }

        function calcularInfoDetalle(cedula, fechaAfiliacion) {
            const afiliacion = parseFecha(fechaAfiliacion);
            const hoy = appState.fechaActual;
            let mesesPagados = 0;
            let mesesCondonados = 0;
            let mesesDeuda = 0;
            let valorPagado = 0;
            
            for (let a√±o = afiliacion.getFullYear(); a√±o <= hoy.getFullYear(); a√±o++) {
                const mesInicio = (a√±o === afiliacion.getFullYear()) ? afiliacion.getMonth() : 0;
                const mesFin = (a√±o === hoy.getFullYear()) ? hoy.getMonth() : 11;
                
                for (let mes = mesInicio; mes <= mesFin; mes++) {
                    if (mesEstaPagado(cedula, a√±o, mes)) {
                        mesesPagados++;
                        valorPagado += CONFIG.VALOR_CUOTA;
                    } else if (esMesCondonado(a√±o, mes)) {
                        mesesCondonados++;
                    } else {
                        mesesDeuda++;
                    }
                }
            }
            
            return {
                mesesPagados,
                mesesCondonados,
                mesesDeuda,
                valorPagado,
                valorDebe: mesesDeuda * CONFIG.VALOR_CUOTA
            };
        }

        function actualizarSiguienteRecibo() {
            const todosPagos = obtenerTodosLosPagos();
            let maxRecibo = 0;
            
            todosPagos.forEach(p => {
                if (p.recibo && p.recibo !== 'N/A') {
                    const num = parseInt(p.recibo);
                    if (!isNaN(num) && num > maxRecibo) {
                        maxRecibo = num;
                    }
                }
            });
            
            // Formato de 5 d√≠gitos
            const siguiente = (maxRecibo + 1).toString().padStart(5, '0');
            dom.nextReceiptNumber.textContent = siguiente;
            return siguiente;
        }

        // ============================================================
        // ESTAD√çSTICAS
        // ============================================================
        function calcularEstadisticas() {
            const totalAfiliados = appState.afiliados.length;
            
            let usuariosAlDia = 0;
            appState.afiliados.forEach(af => {
                if (calcularMesesDeuda(af.cedula, af.fecha).length === 0) usuariosAlDia++;
            });
            
            const todosPagos = obtenerTodosLosPagos();
            const pagosCuota = todosPagos.filter(p => p.tipo === 'cuota');
            const pagosCertificado = todosPagos.filter(p => p.tipo === 'certificado');
            
            const mesesPagados = pagosCuota.length;
            const totalCertificados = pagosCertificado.length;
            
            const totalRecaudadoCuotas = pagosCuota.reduce((sum, p) => sum + p.valor, 0);
            const totalRecaudadoCertificados = pagosCertificado.reduce((sum, p) => sum + p.valor, 0);
            const totalRecaudadoGeneral = totalRecaudadoCuotas + totalRecaudadoCertificados;
            
            let deudaTotal = 0;
            appState.afiliados.forEach(af => {
                deudaTotal += calcularMesesDeuda(af.cedula, af.fecha).length * CONFIG.VALOR_CUOTA;
            });
            
            dom.totalAfiliados.textContent = totalAfiliados;
            dom.usuariosAlDia.textContent = usuariosAlDia;
            dom.mesesPagados.textContent = mesesPagados;
            dom.totalCertificados.textContent = totalCertificados;
            dom.recaudadoCuotas.textContent = `$${totalRecaudadoCuotas.toLocaleString()}`;
            dom.recaudadoCertificados.textContent = `$${totalRecaudadoCertificados.toLocaleString()}`;
            dom.totalRecaudado.textContent = `$${totalRecaudadoGeneral.toLocaleString()}`;
            dom.deudaTotal.textContent = `$${deudaTotal.toLocaleString()}`;
        }

        // ============================================================
        // PAGINACI√ìN
        // ============================================================
        function getPaginatedData(data, page) {
            const start = (page - 1) * CONFIG.PAGE_SIZE;
            const end = start + CONFIG.PAGE_SIZE;
            return {
                data: data.slice(start, end),
                totalPages: Math.max(1, Math.ceil(data.length / CONFIG.PAGE_SIZE)),
                currentPage: page,
                total: data.length
            };
        }

        function renderPagination(totalPages, currentPage) {
            if (!dom.pageNumbers) return;
            
            let html = '';
            const maxVisible = 5;
            let start = Math.max(1, currentPage - 2);
            let end = Math.min(totalPages, start + maxVisible - 1);
            
            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }

            if (start > 1) {
                html += `<button class="page-btn" data-page="1">1</button>`;
                if (start > 2) html += `<span style="padding: 0 6px; color: #6a8b6a;">‚Ä¶</span>`;
            }

            for (let i = start; i <= end; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
            }

            if (end < totalPages) {
                if (end < totalPages - 1) html += `<span style="padding: 0 6px; color: #6a8b6a;">‚Ä¶</span>`;
                html += `<button class="page-btn" data-page="${totalPages}">${totalPages}</button>`;
            }

            dom.pageNumbers.innerHTML = html;
            if (dom.pageInput) dom.pageInput.value = currentPage;
            if (dom.prevPageBtn) dom.prevPageBtn.disabled = currentPage === 1;
            if (dom.nextPageBtn) dom.nextPageBtn.disabled = currentPage === totalPages;
            
            document.querySelectorAll('.page-btn[data-page]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const page = parseInt(e.target.dataset.page);
                    if (page !== appState.currentPage) {
                        appState.currentPage = page;
                        renderizarTabla();
                    }
                });
            });
        }

        // ============================================================
        // FILTRO - BUSCA POR C√âDULA Y RECIBO
        // ============================================================
        function obtenerAfiliadosParaMostrar() {
            const filtro = appState.filtroActual.trim();
            
            if (filtro !== '') {
                appState.modoBusqueda = true;
                
                let afiliadoPorCedula = appState.afiliados.find(af => af.cedula === filtro);
                if (afiliadoPorCedula) {
                    appState.ultimoTipoBusqueda = 'c√©dula';
                    return [afiliadoPorCedula];
                }
                
                const todosPagos = obtenerTodosLosPagos();
                const pagosConRecibo = todosPagos.filter(p => 
                    p.recibo && p.recibo.toLowerCase().includes(filtro.toLowerCase())
                );
                
                if (pagosConRecibo.length > 0) {
                    appState.ultimoTipoBusqueda = 'recibo';
                    const cedulasUnicas = [...new Set(pagosConRecibo.map(p => p.cedula))];
                    const afiliadosEncontrados = appState.afiliados.filter(af => 
                        cedulasUnicas.includes(af.cedula)
                    );
                    
                    afiliadosEncontrados.sort((a, b) => {
                        const pagosA = pagosConRecibo.filter(p => p.cedula === a.cedula).length;
                        const pagosB = pagosConRecibo.filter(p => p.cedula === b.cedula).length;
                        return pagosB - pagosA;
                    });
                    
                    return afiliadosEncontrados;
                }
                
                appState.ultimoTipoBusqueda = 'sin resultados';
                return [];
            } else {
                appState.modoBusqueda = false;
                appState.ultimoTipoBusqueda = '';
                return obtenerUltimosAfiliadosConPagos();
            }
        }

        // ============================================================
        // RENDERIZAR TABLA
        // ============================================================
        function renderizarTabla() {
            if (!appState.afiliados.length || !appState.tablaVisible) return;
            
            const a√±oSeleccionado = appState.selectedYear;
            const mesesNombres = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            const mesesCompletos = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            
            let afiliadosAMostrar = obtenerAfiliadosParaMostrar();
            
            const paginated = getPaginatedData(afiliadosAMostrar, appState.currentPage);
            let afiliadosPagina = paginated.data;
            appState.totalPages = paginated.totalPages;
            const totalAfiliadosEnPagina = afiliadosPagina.length;
            
            if (appState.currentPage > appState.totalPages && appState.totalPages > 0) {
                appState.currentPage = 1;
                return renderizarTabla();
            }
            
            dom.a√±oActualDisplay.textContent = a√±oSeleccionado;
            
            if (dom.paginationContainer) {
                dom.paginationContainer.style.display = appState.modoBusqueda ? 'none' : 'flex';
            }
            
            if (appState.modoBusqueda) {
                renderPagination(1, 1);
            } else {
                renderPagination(appState.totalPages, appState.currentPage);
            }
            
            let html = '';
            
            afiliadosPagina.forEach(afiliado => {
                const mesesDeuda = calcularMesesDeuda(afiliado.cedula, afiliado.fecha);
                const deudaTotal = mesesDeuda.length * CONFIG.VALOR_CUOTA;
                
                const registro = appState.pagos.find(p => p.cedula === afiliado.cedula);
                const tieneCertificado = registro && registro.certificado ? 'üìú' : '';
                
                html += `<tr>`;
                html += `<td style="font-weight: 600; color: #1a4a2a;">${afiliado.cedula}</td>`;
                html += `<td style="text-align: left;">${afiliado.nombre}</td>`;
                html += `<td><span class="badge">${afiliado.fecha}</span></td>`;
                html += `<td><span style="font-weight: 900; color: ${deudaTotal > 0 ? '#dd0f0f' : '#5ab05a'};">$${deudaTotal.toLocaleString()}</span></td>`;
                html += `<td style="font-size: 1.2rem;">${tieneCertificado}</td>`;
                html += `<td><button class="btn-detail" onclick="window.verDetalle('${afiliado.cedula}')">Ver</button></td>`;
                
                for (let mes = 0; mes < 12; mes++) {
                    const estado = obtenerEstadoMes(afiliado.cedula, a√±oSeleccionado, mes, afiliado.fecha);
                    
                    if (estado === 'no-visible') {
                        html += `<td><div style="width: 26px; height: 26px;"></div></td>`;
                    } else {
                        const dataAttrs = {
                            'data-cedula': afiliado.cedula,
                            'data-nombre': afiliado.nombre,
                            'data-a√±o': a√±oSeleccionado,
                            'data-mes': mes,
                            'data-mesnombre': mesesNombres[mes],
                            'data-mescompleto': mesesCompletos[mes]
                        };
                        
                        const attrsString = Object.entries(dataAttrs)
                            .map(([key, value]) => `${key}="${value}"`)
                            .join(' ');
                        
                        if (estado === 'debt') {
                            html += `<td><div class="month-checkbox debt" ${attrsString} onclick="window.handleMonthClick(this)"></div></td>`;
                        } else if (estado === 'condoned') {
                            html += `<td><div class="month-checkbox condoned"></div></td>`;
                        } else if (estado === 'paid') {
                            html += `<td><div class="month-checkbox paid"></div></td>`;
                        } else if (estado === 'future') {
                            html += `<td><div class="month-checkbox future"></div></td>`;
                        } else {
                            html += `<td><div style="width: 26px; height: 26px;"></div></td>`;
                        }
                    }
                }
                html += `</tr>`;
            });
            
            const filasFaltantes = CONFIG.PAGE_SIZE - totalAfiliadosEnPagina;
            for (let i = 0; i < filasFaltantes; i++) {
                html += `<tr style="opacity: 0.7; background-color: #f5f5f5;">
                    <td style="color: #aaa;"></td>
                    <td style="color: #aaa; text-align: left;"></td>
                    <td><span class="badge" style="background: #ddd; color: #666;"></span></td>
                    <td><span style="color: #aaa;"></span></td>
                    <td></td>
                    <td><button class="btn-detail" style="opacity: 0.3; background: #ddd;" disabled></button></td>`;
                for (let mes = 0; mes < 12; mes++) {
                    html += `<td><div style="width: 26px; height: 26px; background: #e0e0e0; border-radius: 4px;"></div></td>`;
                }
                html += `</tr>`;
            }
            
            if (afiliadosPagina.length === 0 && appState.modoBusqueda) {
                html = `<tr><td colspan="18" style="padding: 40px; text-align: center; color: #6a8b6a;">
                    ‚ùå No se encontraron resultados para "${appState.filtroActual}"<br>
                    <span style="font-size: 0.8rem; margin-top: 10px; display: block;">
                        üîç Busca por c√©dula exacta o n√∫mero de recibo
                    </span>
                </td></tr>`;
            }
            
            dom.tableBody.innerHTML = html;

            const pagarCertificadoBtn = document.getElementById('pagarCertificadoBtn');
            if (pagarCertificadoBtn) {
                if (appState.modoBusqueda && afiliadosAMostrar.length > 0) {
                    pagarCertificadoBtn.classList.remove('disabled');
                    pagarCertificadoBtn.title = `Pagar certificado para: ${afiliadosAMostrar[0].nombre}`;
                } else {
                    pagarCertificadoBtn.classList.add('disabled');
                    pagarCertificadoBtn.title = 'Busca una c√©dula primero';
                }
            }
        }

        // ============================================================
        // MANEJADOR DE CLIC EN MES
        // ============================================================
        window.handleMonthClick = function(element) {
            resetInactivityTimer();
            
            if (!element.classList.contains('debt')) return;
            if (element.classList.contains('selected')) return;
            if (!element.dataset.cedula || !element.dataset.nombre || !element.dataset.a√±o || !element.dataset.mes) {
                mostrarAlerta('Error: Datos incompletos', 'error');
                return;
            }
            
            appState.pendingPayment = {
                cedula: element.dataset.cedula,
                nombre: element.dataset.nombre,
                a√±o: parseInt(element.dataset.a√±o),
                mes: parseInt(element.dataset.mes),
                mesNombre: element.dataset.mesnombre,
                element: element,
                tipo: 'cuota'
            };
            
            const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            dom.receiptInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 700; color: #1a4a2a;">${appState.pendingPayment.nombre}</span>
                    <span style="background: #e0f0e0; padding: 4px 14px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">${appState.pendingPayment.cedula}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600;">${meses[appState.pendingPayment.mes]} ${appState.pendingPayment.a√±o}</span>
                    <span style="font-weight: 700; color: #1a7a3a;">$${CONFIG.VALOR_CUOTA.toLocaleString()}</span>
                </div>
            `;
            
            dom.tipoCuota.checked = true;
            dom.optionCuota.classList.add('selected');
            dom.optionCertificado.classList.remove('selected');
            
            dom.optionCuota.style.display = 'flex';
            dom.optionCertificado.style.display = 'flex';
            
            dom.receiptNumber.value = dom.nextReceiptNumber.textContent;
            dom.receiptModal.style.display = 'flex';
            setTimeout(() => dom.receiptNumber.focus(), 100);
        };

        // ============================================================
        // MANEJADOR DE CLIC EN OPCIONES DE PAGO
        // ============================================================
        dom.optionCuota.addEventListener('click', () => {
            resetInactivityTimer();
            dom.tipoCuota.checked = true;
            dom.optionCuota.classList.add('selected');
            dom.optionCertificado.classList.remove('selected');
            
            if (appState.pendingPayment && appState.pendingPayment.mes !== undefined) {
                const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                dom.receiptInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 700; color: #1a4a2a;">${appState.pendingPayment.nombre}</span>
                        <span style="background: #e0f0e0; padding: 4px 14px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">${appState.pendingPayment.cedula}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600;">${meses[appState.pendingPayment.mes]} ${appState.pendingPayment.a√±o}</span>
                        <span style="font-weight: 700; color: #1a7a3a;">$${CONFIG.VALOR_CUOTA.toLocaleString()}</span>
                    </div>
                `;
            }
        });

        dom.optionCertificado.addEventListener('click', () => {
            resetInactivityTimer();
            dom.tipoCertificado.checked = true;
            dom.optionCertificado.classList.add('selected');
            dom.optionCuota.classList.remove('selected');
            
            if (appState.pendingPayment) {
                dom.receiptInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 700; color: #1a4a2a;">${appState.pendingPayment.nombre}</span>
                        <span style="background: #e0f0e0; padding: 4px 14px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">${appState.pendingPayment.cedula}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600;">CERTIFICADO</span>
                        <span style="font-weight: 700; color: #b68b40;">$${CONFIG.VALOR_CERTIFICADO.toLocaleString()}</span>
                    </div>
                `;
            }
        });

        // ============================================================
        // GUARDAR RECIBO Y PAGO INMEDIATO (CON VALIDACI√ìN DE TIEMPO)
        // ============================================================
        async function guardarPagoConRecibo() {
    resetInactivityTimer();
    
    if (!appState.pendingPayment) return mostrarAlerta('‚ùå No hay pago pendiente', 'error');
    
    // Verificar que hay token
    if (!appState.token) {
        mostrarAlerta('‚ùå Debes configurar el token de GitHub primero', 'error');
        return;
    }
    
    const recibo = dom.receiptNumber.value.trim();
    if (!recibo) return mostrarAlerta('‚ùå N√∫mero de recibo obligatorio', 'error');
    
    // Validar formato de 5 d√≠gitos
    if (!/^\d{5}$/.test(recibo)) {
        return mostrarAlerta('‚ùå El recibo debe tener 5 d√≠gitos (ej: 00001)', 'error');
    }
    
    // Obtener todos los pagos para validaciones
    const todosPagos = obtenerTodosLosPagos();
    const ahora = new Date();
    const fecha = formatearFecha(ahora);
    const hora = formatearHora(ahora);
    
    // Buscar si el recibo ya existe para ALGUIEN
    const pagosConEsteRecibo = todosPagos.filter(p => p.recibo === recibo);
    
    if (pagosConEsteRecibo.length > 0) {
        // Verificar si es otro usuario
        const esOtroUsuario = pagosConEsteRecibo.some(p => p.cedula !== appState.pendingPayment.cedula);
        
        if (esOtroUsuario) {
            return mostrarAlerta(`‚ùå Recibo ${recibo} ya fue usado por otro afiliado`, 'error');
        }
        
        // Encontrar la fecha M√ÅS ANTIGUA de este recibo para este usuario
        let fechaMasAntigua = null;
        
        pagosConEsteRecibo.forEach(p => {
            if (p.cedula === appState.pendingPayment.cedula) {
                const [dia, mes, a√±o] = p.fecha.split('/').map(Number);
                let fechaPago;
                
                if (p.hora) {
                    const [horaP, minP, segP] = p.hora.split(':').map(Number);
                    fechaPago = new Date(a√±o, mes - 1, dia, horaP, minP, segP);
                } else {
                    // Por compatibilidad con datos antiguos (sin hora)
                    fechaPago = new Date(a√±o, mes - 1, dia, 0, 0, 0);
                }
                
                if (!fechaMasAntigua || fechaPago < fechaMasAntigua) {
                    fechaMasAntigua = fechaPago;
                }
            }
        });
        
        if (fechaMasAntigua) {
            // Calcular diferencia en minutos desde el pago m√°s antiguo
            const diferenciaMinutos = (ahora - fechaMasAntigua) / (1000 * 60);
            
            // Verificar l√≠mite de 30 minutos
            if (diferenciaMinutos > 30) {
                const horas = Math.floor(diferenciaMinutos / 60);
                const minutos = Math.floor(diferenciaMinutos % 60);
                
                let tiempoMensaje = '';
                if (horas > 0) {
                    tiempoMensaje = `${horas}h ${minutos}min`;
                } else {
                    tiempoMensaje = `${minutos}min`;
                }
                
                return mostrarAlerta(
                    `‚ùå Recibo ${recibo} expir√≥ (hace ${tiempoMensaje}).\n` +
                    `M√°ximo 30 minutos para usar el mismo recibo.`, 
                    'error'
                );
            }
            
            // Mostrar tiempo restante
            const tiempoRestante = Math.round(30 - diferenciaMinutos);
            if (!confirm(`‚ö†Ô∏è El recibo ${recibo} se us√≥ por primera vez hace ${Math.round(diferenciaMinutos)} minutos.\n` +
                         `‚è∞ Tienes ${tiempoRestante} minutos restantes.\n\n` +
                         `¬øDeseas continuar con este mismo recibo?`)) {
                return;
            }
        }
    }

    const tipoPago = dom.tipoCuota.checked ? 'cuota' : 'certificado';

    const saveBtn = dom.saveReceiptBtn;
    const originalText = saveBtn.innerHTML;
    
    try {
        saveBtn.innerHTML = '<span class="loading">‚åõ</span> Guardando';
        saveBtn.disabled = true;
        
        let registro = appState.pagos.find(p => p.cedula === appState.pendingPayment.cedula);
        if (!registro) {
            registro = { 
                cedula: appState.pendingPayment.cedula, 
                nombre: appState.pendingPayment.nombre
            };
            appState.pagos.push(registro);
        }
        
        if (tipoPago === 'cuota') {
            const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            const campo = `fecha_pago_a√±o_${appState.pendingPayment.a√±o}`;
            // AHORA LAS CUOTAS TAMBI√âN INCLUYEN HORA
            const pagoStr = `${meses[appState.pendingPayment.mes]}_${appState.pendingPayment.a√±o}_${CONFIG.VALOR_CUOTA}_${fecha}_${hora}_${recibo}`;
            
            registro[campo] = registro[campo] ? `${registro[campo]}; ${pagoStr}` : pagoStr;
            
            if (appState.pendingPayment.element) {
                appState.pendingPayment.element.classList.remove('debt', 'selected');
                appState.pendingPayment.element.classList.add('paid');
            }
        } else {
            const mesActual = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'][appState.fechaActual.getMonth()];
            const a√±oActual = appState.fechaActual.getFullYear();
            const certificadoStr = `${mesActual}_${a√±oActual}_${CONFIG.VALOR_CERTIFICADO}_${fecha}_${hora}_${recibo}`;
            
            registro.certificado = registro.certificado ? `${registro.certificado}; ${certificadoStr}` : certificadoStr;
        }
        
        // Guardar directamente en GitHub
        await guardarPagosEnGitHub();
        
        calcularEstadisticas();
        actualizarSiguienteRecibo();
        renderizarTabla();
        
        mostrarAlerta(`‚úÖ ${tipoPago === 'cuota' ? 'Cuota' : 'Certificado'} guardado - Recibo: ${recibo}`, 'success');
        
        dom.receiptModal.style.display = 'none';
        appState.pendingPayment = null;
        
    } catch (e) {
        mostrarAlerta('Error al guardar: ' + e.message, 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

        // ============================================================
        // GUARDAR EN GITHUB
        // ============================================================
        async function guardarPagosEnGitHub() {
            try {
                const content = {
                    ultima_actualizacion: new Date().toISOString(),
                    valor_cuota: CONFIG.VALOR_CUOTA,
                    pagos: appState.pagos
                };

                const url = `https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.CUOTA_PATH}`;
                
                let sha = null;
                try {
                    const shaRes = await fetch(url, { 
                        headers: { 'Authorization': `token ${appState.token}` } 
                    });
                    if (shaRes.ok) {
                        const shaData = await shaRes.json();
                        sha = shaData.sha;
                    }
                } catch (e) {}
                
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${appState.token}`, 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Pago ${dom.tipoCuota.checked ? 'cuota' : 'certificado'} - ${new Date().toLocaleDateString()}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                        sha,
                        branch: CONFIG.BRANCH
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Error al guardar');
                }
                
                // Guardar tambi√©n en localStorage como respaldo
                guardarPagosEnLocalStorage();
                
                return true;
            } catch (e) {
                throw new Error(e.message);
            }
        }

        // ============================================================
        // MODAL DE DETALLE
        // ============================================================
        window.verDetalle = function(cedula) {
            resetInactivityTimer();
            
            const afiliado = appState.afiliados.find(a => a.cedula === cedula);
            if (!afiliado) return;
            
            dom.modalNombre.textContent = `üìã ${afiliado.nombre}`;
            const registro = appState.pagos.find(p => p.cedula === cedula) || {};
            const info = calcularInfoDetalle(cedula, afiliado.fecha);
            
            let html = `<div style="background: #f0f8f0; padding: 16px; border-radius: 14px; margin-bottom: 16px; border-left: 0px solid #2a7a4a;">
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center;">
                    <div>
                        <div style="font-size: 0.65rem; color: #4a6b4a; text-transform: uppercase; margin-bottom: 4px;">Meses Pagados</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #1a7a3a;">${info.mesesPagados}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.65rem; color: #4a6b4a; text-transform: uppercase; margin-bottom: 4px;">Meses Condonados</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #ffd966;">${info.mesesCondonados}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.65rem; color: #4a6b4a; text-transform: uppercase; margin-bottom: 4px;">Meses Debe</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #c04040;">${info.mesesDeuda}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.65rem; color: #4a6b4a; text-transform: uppercase; margin-bottom: 4px;">Valor Pagado</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #1a7a3a;">$${info.valorPagado.toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.65rem; color: #4a6b4a; text-transform: uppercase; margin-bottom: 4px;">Valor Debe</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #c04040;">$${info.valorDebe.toLocaleString()}</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid #d0e0d0;">
                    <span style="font-weight: 600; color: #1a4a2a;">C√©dula:</span>
                    <span style="font-weight: 600;">${afiliado.cedula}</span>
                    <span style="font-weight: 600; color: #1a4a2a;">Afiliaci√≥n:</span>
                    <span style="background: #e0f0e0; padding: 4px 14px; border-radius: 100px;">${afiliado.fecha}</span>
                </div>
            </div>`;
            
            const mesesNombres = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            const afiliacion = parseFecha(afiliado.fecha);
            const hoy = appState.fechaActual;
            const mesesCondonadosLista = [];
            
            for (let a√±o = afiliacion.getFullYear(); a√±o <= hoy.getFullYear(); a√±o++) {
                const mesInicio = (a√±o === afiliacion.getFullYear()) ? afiliacion.getMonth() : 0;
                const mesFin = (a√±o === hoy.getFullYear()) ? hoy.getMonth() : 11;
                
                for (let mes = mesInicio; mes <= mesFin; mes++) {
                    if (esMesCondonado(a√±o, mes) && !mesEstaPagado(cedula, a√±o, mes)) {
                        mesesCondonadosLista.push({ a√±o, mes });
                    }
                }
            }
            
            if (mesesCondonadosLista.length > 0) {
                html += `<h4 style="margin: 20px 0 12px; font-weight: 700; color: #ffd966;">‚ú® Meses condonados (valor $0)</h4>`;
                html += `<div style="background: #fff9e6; border: 1px solid #ffd966; border-radius: 14px; padding: 16px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 2px;">`;
                mesesCondonadosLista.forEach(({a√±o, mes}) => {
                    html += `<span style="background: #ffd966; color: #1a4a2a; padding: 6px 14px; border-radius: 100px; font-weight: 600; font-size: 0.75rem;">${mesesNombres[mes]} ${a√±o}</span>`;
                });
                html += `</div>`;
            }
            
            html += `<h4 style="margin-bottom: 14px; font-weight: 700; color: #1a4a2a;">üí∞ Historial de pagos</h4>`;
            
            let hayPagos = false;
            
            const a√±os = [];
            for (let a√±o = parseFecha(afiliado.fecha).getFullYear(); a√±o <= appState.fechaActual.getFullYear(); a√±o++) a√±os.push(a√±o);
            
            a√±os.sort((a,b) => b - a).forEach(a√±o => {
                const pagos = extraerPagosDeString(registro[`fecha_pago_a√±o_${a√±o}`], a√±o);
                if (pagos.length) {
                    hayPagos = true;
                    html += `<div style="background: white; border: 1px solid #d8ecd8; border-radius: 14px; padding: 14px; margin-bottom: 14px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 700; color: #1a4a2a;">üìÜ ${a√±o}</span>
                        <span style="background: #e0f0e0; padding: 4px 12px; border-radius: 100px; font-size: 0.65rem; font-weight: 600;">${pagos.length} cuotas</span>
                    </div>`;
                    pagos.forEach(p => {
                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e0f0e0;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="text-transform: capitalize; font-weight: 600;">${p.mes}</span>
                                <span style="color: #4a6b4a;">${p.a√±o}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-weight: 700; color: #1a7a3a;">$${p.valor.toLocaleString()}</span>
                                <span style="color: #4a6b4a; background: #f0f8f0; padding: 4px 10px; border-radius: 100px; font-size: 0.6rem;">${p.fecha}</span>
                                <span style="background: #1a4a2a; color: white; padding: 4px 10px; border-radius: 100px; font-size: 0.6rem;">${p.recibo}</span>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
            });
            
            if (registro.certificado) {
                const certificados = extraerCertificadosDeString(registro.certificado);
                if (certificados.length) {
                    hayPagos = true;
                    html += `<h4 style="margin: 20px 0 12px; font-weight: 700; color: #b68b40;">üìú Certificados emitidos</h4>`;
                    html += `<div style="background: #fff9e6; border: 1px solid #ffd966; border-radius: 14px; padding: 14px; margin-bottom: 16px;">`;
                    certificados.forEach(c => {
                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid #ffd966;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="text-transform: capitalize; font-weight: 600;">${c.mes} ${c.a√±o}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-weight: 700; color: #b68b40;">$${c.valor.toLocaleString()}</span>
                                <span style="color: #4a6b4a; background: #f0f8f0; padding: 4px 10px; border-radius: 100px; font-size: 0.6rem;">${c.fecha} ${c.hora}</span>
                                <span style="background: #b68b40; color: white; padding: 4px 10px; border-radius: 100px; font-size: 0.6rem;">${c.recibo}</span>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
            }
            
            if (!hayPagos) {
                html += `<div style="padding: 8px; text-align: center; background: #f0f8f0; border-radius: 14px; color: #4a6b4a;">
                    No hay pagos registrados
                </div>`;
            }
            
            const mesesDeuda = calcularMesesDeuda(cedula, afiliado.fecha);
            if (mesesDeuda.length) {
                html += `<h4 style="color: #c04040; margin: 20px 0 12px; font-weight: 700;">‚ö†Ô∏è Deuda pendiente</h4>`;
                html += `<div style="background: #fff0f0; padding: 16px; border-radius: 14px; border: 1px solid #e0b0b0;">`;
                mesesDeuda.forEach(({a√±o, mes}) => {
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid #ffd0d0;">
                        <span style="text-transform: capitalize; font-weight: 600; color: #a04040;">${mesesNombres[mes]} ${a√±o}</span>
                        <span style="font-weight: 700; color: #c04040;">$${CONFIG.VALOR_CUOTA.toLocaleString()}</span>
                    </div>`;
                });
                html += `<div style="margin-top: 12px; padding-top: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: 700;">
                    <span style="color: #a04040;">Total deuda:</span>
                    <span style="color: #c04040; font-size: 1rem;">$${(mesesDeuda.length * CONFIG.VALOR_CUOTA).toLocaleString()}</span>
                </div>`;
                html += `</div>`;
            } else {
                html += `<div style="background: #e4ffe4; padding: 20px; border-radius: 14px; text-align: center; margin-top: 20px; border: 1px solid #a0d0a0;">
                    <span style="color: #1a7a3a; font-weight: 700;">‚úì Al d√≠a - No tiene deudas</span>
                </div>`;
            }
            
            dom.modalContent.innerHTML = html;
            dom.modal.style.display = 'flex';
        };

        // ============================================================
        // REPORTES
        // ============================================================
        function generarReporteCompacto(titulo, filtroFn) {
            resetInactivityTimer();
            
            const pagos = filtroFn ? obtenerTodosLosPagos().filter(filtroFn) : obtenerTodosLosPagos();
            
            const usuarios = {};
            
            pagos.forEach(p => {
                if (!usuarios[p.cedula]) {
                    usuarios[p.cedula] = { 
                        cedula: p.cedula, 
                        nombre: p.nombre, 
                        items: [], 
                        total: 0 
                    };
                }
                const tipoIcon = p.tipo === 'cuota' ? 'üí∞' : 'üìú';
                usuarios[p.cedula].items.push({ 
                    tipo: p.tipo,
                    icon: tipoIcon,
                    mes: p.mes ? p.mes.charAt(0).toUpperCase() + p.mes.slice(1, 3) : 'Cert',
                    a√±o: p.a√±o, 
                    fecha: p.fecha,
                    hora: p.hora || '',
                    valor: p.valor,
                    recibo: p.recibo 
                });
                usuarios[p.cedula].total += p.valor;
            });

            let html = `<table style="width: 100%; border-collapse: collapse; font-size: 0.7rem; table-layout: fixed;">
                <colgroup>
                    <col style="width: 12%">
                    <col style="width: 25%">
                    <col style="width: 38%">
                    <col style="width: 25%">
                </colgroup>
                <thead>
                    <tr style="background: #1a4a2a; color: white;">
                        <th style="padding: 10px; text-align: center;">C√©dula</th>
                        <th style="padding: 10px; text-align: left;">Nombre</th>
                        <th style="padding: 10px; text-align: left;">Detalle</th>
                        <th style="padding: 10px; text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>`;
            
            if (Object.keys(usuarios).length === 0) {
                html += `<tr><td colspan="4" style="padding: 40px; text-align: center; color: #6a8b6a;">No hay registros</td></tr>`;
            } else {
                Object.values(usuarios).sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(u => {
                    html += `<tr style="border-bottom: 1px solid #d8ecd8;">`;
                    html += `<td style="padding: 8px; font-weight: 600; text-align: center; word-break: break-word;">${u.cedula}</td>`;
                    html += `<td style="padding: 8px; text-align: left; word-break: break-word;">${u.nombre}</td>`;
                    html += `<td style="padding: 8px; text-align: left; word-break: break-word;">`;
                    u.items.sort((a,b) => b.a√±o - a.a√±o || a.mes.localeCompare(b.mes)).forEach(item => {
                        let detalle = '';
                        if (item.tipo === 'cuota') {
                            detalle = `${item.icon} ${item.mes} ${item.a√±o}`;
                        } else {
                            detalle = `${item.icon} Certificado ${item.mes} ${item.a√±o}`;
                        }
                        html += `<span class="month-badge" style="display: inline-block; margin: 2px; background: ${item.tipo === 'cuota' ? '#e0f0e0' : '#fff3cd'}; white-space: nowrap;" title="Recibo: ${item.recibo}">${detalle}</span> `;
                    });
                    html += `</td>`;
                    html += `<td style="padding: 8px; text-align: right; font-weight: 700; color: #1a7a3a; word-break: break-word;">$${u.total.toLocaleString()}</td>`;
                    html += `</tr>`;
                });
                const total = Object.values(usuarios).reduce((s, u) => s + u.total, 0);
                html += `<tr style="background: #e0f0e0; font-weight: 700;">
                    <td colspan="3" style="padding: 10px; text-align: right;">Total general:</td>
                    <td style="padding: 10px; text-align: right; color: #1a4a2a;">$${total.toLocaleString()}</td>
                </tr>`;
            }
            html += `</tbody></table>`;
            
            dom.reportTitle.textContent = titulo;
            dom.reportContent.innerHTML = html;
            dom.reportModal.style.display = 'flex';
        }

        function generarReporteCertificados() {
            resetInactivityTimer();
            
            const todosPagos = obtenerTodosLosPagos();
            const certificados = todosPagos.filter(p => p.tipo === 'certificado');
            
            let html = `<table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">
                <thead>
                    <tr style="background: #b68b40; color: white;">
                        <th style="padding: 10px;">Recibo</th>
                        <th style="padding: 10px;">C√©dula</th>
                        <th style="padding: 10px;">Nombre</th>
                        <th style="padding: 10px;">Fecha</th>
                        <th style="padding: 10px;">Hora</th>
                        <th style="padding: 10px;">Valor</th>
                    </tr>
                </thead>
                <tbody>`;
            
            if (certificados.length === 0) {
                html += `<tr><td colspan="6" style="padding: 40px; text-align: center;">No hay certificados emitidos</td></tr>`;
            } else {
                certificados.sort((a,b) => b.fechaObj - a.fechaObj).forEach(c => {
                    html += `<tr style="border-bottom: 1px solid #ffd966;">
                        <td style="padding: 8px; text-align: center; font-weight: 600;">${c.recibo}</td>
                        <td style="padding: 8px; text-align: center;">${c.cedula}</td>
                        <td style="padding: 8px;">${c.nombre}</td>
                        <td style="padding: 8px; text-align: center;">${c.fecha}</td>
                        <td style="padding: 8px; text-align: center;">${c.hora}</td>
                        <td style="padding: 8px; text-align: right; font-weight: 700; color: #b68b40;">$${c.valor.toLocaleString()}</td>
                    </tr>`;
                });
                
                const total = certificados.reduce((s, c) => s + c.valor, 0);
                html += `<tr style="background: #fff3cd; font-weight: 700;">
                    <td colspan="5" style="padding: 10px; text-align: right;">Total certificados:</td>
                    <td style="padding: 10px; text-align: right;">$${total.toLocaleString()}</td>
                </tr>`;
            }
            html += `</tbody></table>`;
            
            dom.reportTitle.textContent = 'üìú Certificados emitidos';
            dom.reportContent.innerHTML = html;
            dom.reportModal.style.display = 'flex';
        }

        // ============================================================
        // CARGAR DATOS
        // ============================================================
        async function cargarAfiliados() {
            const url = `https://raw.githubusercontent.com/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/refs/heads/${CONFIG.BRANCH}/${CONFIG.AFILIADOS_PATH}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('No se pudo cargar afiliados');
            return await res.json();
        }

        async function cargarPagos() {
            const url = `https://raw.githubusercontent.com/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/refs/heads/${CONFIG.BRANCH}/${CONFIG.CUOTA_PATH}`;
            try {
                const res = await fetch(url);
                if (res.status === 404) return [];
                return (await res.json()).pagos || [];
            } catch {
                return [];
            }
        }

        // ============================================================
        // UI
        // ============================================================
        function mostrarAlerta(msg, tipo = 'error') {
            dom.alertMessage.textContent = msg;
            dom.alertMessage.className = `alert show alert-${tipo}`;
            setTimeout(() => dom.alertMessage.classList.remove('show'), 4000);
        }

        // ============================================================
        // FUNCI√ìN PARA GUARDAR TOKEN
        // ============================================================
        function guardarToken() {
            const token = dom.apiTokenInput.value.trim();
            if (!token) {
                mostrarAlerta('‚ùå Debes ingresar un token', 'error');
                return;
            }
            
            // Validar formato b√°sico de token GitHub (empieza con ghp_ o github_pat_)
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                if (!confirm('‚ö†Ô∏è El token no tiene formato de GitHub (debe empezar con ghp_ o github_pat_). ¬øContinuar de todas formas?')) {
                    return;
                }
            }
            
            appState.token = token;
            sessionStorage.setItem('github_token', token);
            mostrarAlerta('‚úÖ Token guardado correctamente', 'success');
            
            // Opcional: sincronizar autom√°ticamente despu√©s de guardar token
            setTimeout(() => sincronizarConGitHub(), 1000);
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================
        function inicializarEventos() {
            dom.searchInput.addEventListener('input', (e) => {
                resetInactivityTimer();
                appState.filtroActual = e.target.value;
                appState.currentPage = 1;
                if (appState.tablaVisible) renderizarTabla();
            });

            const logoutBtn = document.getElementById('logoutBtn');
            const logoutConfirmModal = document.getElementById('logoutConfirmModal');
            const closeLogoutModalBtn = document.getElementById('closeLogoutModalBtn');
            const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
            const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
            const redirectToLoginBtn = document.getElementById('redirectToLoginBtn');

            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    resetInactivityTimer();
                    logoutConfirmModal.style.display = 'flex';
                });
            }

            if (closeLogoutModalBtn) {
                closeLogoutModalBtn.addEventListener('click', () => {
                    logoutConfirmModal.style.display = 'none';
                });
            }

            if (cancelLogoutBtn) {
                cancelLogoutBtn.addEventListener('click', () => {
                    logoutConfirmModal.style.display = 'none';
                });
            }

            if (confirmLogoutBtn) {
                confirmLogoutBtn.addEventListener('click', () => {
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                });
            }

            if (redirectToLoginBtn) {
                redirectToLoginBtn.addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }

            window.addEventListener('click', (e) => {
                if (e.target === logoutConfirmModal) {
                    logoutConfirmModal.style.display = 'none';
                }
                if (e.target === dom.sessionExpiredModal) {
                    window.location.href = 'index.html';
                }
            });

            dom.toggleTableBtn.addEventListener('click', () => {
                resetInactivityTimer();
                appState.tablaVisible = !appState.tablaVisible;
                dom.tableContainer.style.display = appState.tablaVisible ? 'block' : 'none';
                dom.toggleTableBtn.innerHTML = appState.tablaVisible ? 'üïµÔ∏è Ocultar tabla' : 'üìã Mostrar tabla';
                if (appState.tablaVisible) {
                    appState.currentPage = 1;
                    renderizarTabla();
                }
            });

            dom.yearSelect.addEventListener('change', (e) => {
                resetInactivityTimer();
                appState.selectedYear = parseInt(e.target.value);
                if (appState.tablaVisible) renderizarTabla();
            });

            dom.prevPageBtn.addEventListener('click', () => {
                resetInactivityTimer();
                if (appState.currentPage > 1) {
                    appState.currentPage--;
                    renderizarTabla();
                }
            });

            dom.nextPageBtn.addEventListener('click', () => {
                resetInactivityTimer();
                if (appState.currentPage < appState.totalPages) {
                    appState.currentPage++;
                    renderizarTabla();
                }
            });

            dom.goToPageBtn.addEventListener('click', () => {
                resetInactivityTimer();
                const page = parseInt(dom.pageInput.value);
                if (page >= 1 && page <= appState.totalPages) {
                    appState.currentPage = page;
                    renderizarTabla();
                }
            });

            dom.closeReceiptBtn.addEventListener('click', () => {
                resetInactivityTimer();
                dom.receiptModal.style.display = 'none';
                appState.pendingPayment = null;
                dom.optionCuota.style.display = 'flex';
                dom.optionCertificado.style.display = 'flex';
                dom.tipoCuota.checked = true;
                dom.optionCuota.classList.add('selected');
                dom.optionCertificado.classList.remove('selected');
            });

            dom.cancelReceiptBtn.addEventListener('click', () => {
                resetInactivityTimer();
                dom.receiptModal.style.display = 'none';
                appState.pendingPayment = null;
                dom.optionCuota.style.display = 'flex';
                dom.optionCertificado.style.display = 'flex';
                dom.tipoCuota.checked = true;
                dom.optionCuota.classList.add('selected');
                dom.optionCertificado.classList.remove('selected');
            });

            dom.saveReceiptBtn.addEventListener('click', guardarPagoConRecibo);

            const saveBtn = document.getElementById('savePaymentsBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    resetInactivityTimer();
                    if (appState.sincronizando) {
                        mostrarAlerta('‚è≥ Ya est√° sincronizando...', 'info');
                        return;
                    }
                    
                    // Verificar token antes de sincronizar
                    if (!appState.token) {
                        mostrarAlerta('‚ùå Debes configurar el token de GitHub primero', 'error');
                        return;
                    }
                    
                    try {
                        saveBtn.innerHTML = '<span class="loading">‚åõ</span> Sincronizando';
                        saveBtn.disabled = true;
                        await sincronizarConGitHub();
                    } catch (e) {
                        mostrarAlerta('Error al sincronizar: ' + e.message, 'error');
                    } finally {
                        saveBtn.innerHTML = 'üíæ Sincronizar con GitHub';
                        saveBtn.disabled = false;
                    }
                });
            }

            dom.paymentsTodayBtn.addEventListener('click', () => {
                resetInactivityTimer();
                const hoy = appState.fechaActual;
                const d = hoy.getDate().toString().padStart(2,'0');
                const m = hoy.getMonth();
                const a = hoy.getFullYear();
                generarReporteCompacto('Pagos de hoy', p => {
                    const [dd, mm, aa] = p.fecha.split('/');
                    return dd === d && parseInt(mm)-1 === m && parseInt(aa) === a;
                });
            });

            dom.paymentsMonthBtn.addEventListener('click', () => {
                resetInactivityTimer();
                const m = appState.fechaActual.getMonth();
                const a = appState.fechaActual.getFullYear();
                generarReporteCompacto(`Pagos de ${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][m]} ${a}`, p => {
                    const [dd, mm, aa] = p.fecha.split('/');
                    return parseInt(mm)-1 === m && parseInt(aa) === a;
                });
            });

            dom.paymentsYearBtn.addEventListener('click', () => {
                resetInactivityTimer();
                const a = appState.fechaActual.getFullYear();
                generarReporteCompacto(`Pagos ${a}`, p => parseInt(p.fecha.split('/')[2]) === a);
            });

            dom.paymentsAllBtn.addEventListener('click', () => {
                resetInactivityTimer();
                generarReporteCompacto('Todos los pagos');
            });
            
            dom.certificatesReportBtn.addEventListener('click', () => {
                resetInactivityTimer();
                generarReporteCertificados();
            });

            dom.printReportBtn.addEventListener('click', () => {
                resetInactivityTimer();
                const w = window.open('', '_blank');
                w.document.write(`
                    <html>
                        <head>
                            <title>${dom.reportTitle.textContent}</title>
                            <style>
                                body { font-family: 'Inter', Arial; padding: 40px; }
                                table { border-collapse: collapse; width: 100%; }
                                th { background: #1a4a2a; color: white; padding: 10px; }
                                td { padding: 8px; border: 1px solid #ddd; }
                                .month-badge { background: #1a4a2a; color: white; padding: 4px 10px; border-radius: 100px; }
                            </style>
                        </head>
                        <body>
                            <h1 style="color: #1a4a2a;">JAC Bateas - ${dom.reportTitle.textContent}</h1>
                            <p>Fecha: ${new Date().toLocaleDateString('es-ES')}</p>
                            ${dom.reportContent.innerHTML}
                        </body>
                    </html>
                `);
                w.document.close();
                setTimeout(() => w.print(), 300);
            });

            dom.printDetailBtn.addEventListener('click', () => {
                resetInactivityTimer();
                const w = window.open('', '_blank');
                w.document.write(`
                    <html>
                        <head>
                            <title>${dom.modalNombre.textContent}</title>
                            <style>
                                body { font-family: 'Inter', Arial; padding: 40px; }
                                .badge { background: #f0f8f0; padding: 4px 14px; border-radius: 100px; }
                            </style>
                        </head>
                        <body>
                            <h1 style="color: #1a4a2a;">${dom.modalNombre.textContent}</h1>
                            <p>Fecha: ${new Date().toLocaleDateString('es-ES')}</p>
                            ${dom.modalContent.innerHTML}
                        </body>
                    </html>
                `);
                w.document.close();
                setTimeout(() => w.print(), 300);
            });

            dom.closeModalBtn.addEventListener('click', () => {
                resetInactivityTimer();
                dom.modal.style.display = 'none';
            });
            
            dom.closeReportModalBtn.addEventListener('click', () => {
                resetInactivityTimer();
                dom.reportModal.style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                if (e.target === dom.modal) dom.modal.style.display = 'none';
                if (e.target === dom.reportModal) dom.reportModal.style.display = 'none';
                if (e.target === dom.receiptModal) {
                    dom.receiptModal.style.display = 'none';
                    appState.pendingPayment = null;
                    dom.optionCuota.style.display = 'flex';
                    dom.optionCertificado.style.display = 'flex';
                    dom.tipoCuota.checked = true;
                    dom.optionCuota.classList.add('selected');
                    dom.optionCertificado.classList.remove('selected');
                }
            });

            const pagarCertificadoBtn = document.getElementById('pagarCertificadoBtn');
            if (pagarCertificadoBtn) {
                pagarCertificadoBtn.addEventListener('click', function() {
                    resetInactivityTimer();
                    
                    const filtro = appState.filtroActual.trim();
                    
                    if (!filtro) {
                        mostrarAlerta('‚ùå Debes buscar una c√©dula primero', 'error');
                        return;
                    }
                    
                    const afiliado = appState.afiliados.find(af => af.cedula === filtro);
                    
                    if (!afiliado) {
                        mostrarAlerta('‚ùå C√©dula no encontrada', 'error');
                        return;
                    }
                    
                    appState.pendingPayment = {
                        cedula: afiliado.cedula,
                        nombre: afiliado.nombre,
                        tipo: 'certificado'
                    };
                    
                    dom.receiptInfo.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 700; color: #1a4a2a;">${afiliado.nombre}</span>
                            <span style="background: #e0f0e0; padding: 4px 14px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">${afiliado.cedula}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">CERTIFICADO</span>
                            <span style="font-weight: 700; color: #b68b40;">$${CONFIG.VALOR_CERTIFICADO.toLocaleString()}</span>
                        </div>
                    `;
                    
                    dom.optionCuota.style.display = 'none';
                    dom.optionCertificado.style.display = 'flex';
                    dom.tipoCertificado.checked = true;
                    dom.optionCertificado.classList.add('selected');
                    
                    const paymentSelector = document.querySelector('.payment-type-selector');
                    if (paymentSelector) {
                        paymentSelector.style.padding = '8px';
                        paymentSelector.style.background = '#f8fff8';
                    }
                    
                    dom.receiptNumber.value = dom.nextReceiptNumber.textContent;
                    dom.receiptModal.style.display = 'flex';
                    setTimeout(() => dom.receiptNumber.focus(), 100);
                });
            }

            // ===== BOT√ìN PARA VOLTEAR TODAS LAS TARJETAS =====
            const toggleAllCardsBtn = document.getElementById('toggleAllCardsBtn');
            if (toggleAllCardsBtn) {
                toggleAllCardsBtn.addEventListener('click', () => {
                    resetInactivityTimer();
                    const tarjetas = document.querySelectorAll('.stat-card');
                    let todasVolteadas = true;
                    
                    // Verificar si todas est√°n volteadas
                    tarjetas.forEach(t => {
                        if (!t.classList.contains('flipped')) {
                            todasVolteadas = false;
                        }
                    });
                    
                    // Voltear o desvoltear seg√∫n el estado
                    tarjetas.forEach(t => {
                        if (todasVolteadas) {
                            t.classList.remove('flipped');
                        } else {
                            t.classList.add('flipped');
                        }
                    });
                    
                    toggleAllCardsBtn.innerHTML = todasVolteadas ? '<span>üëÅÔ∏è</span> Tarjetas' : '<span>üîí</span> Ocultar';
                });
            }

            // Evento para guardar token
            if (dom.saveTokenBtn) {
                dom.saveTokenBtn.addEventListener('click', guardarToken);
            }
            
            // Permitir guardar token con Enter
            if (dom.apiTokenInput) {
                dom.apiTokenInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        guardarToken();
                    }
                });
            }
        }

        // ============================================================
        // INICIALIZACI√ìN
        // ============================================================
        async function inicializar() {
            const a√±oActual = appState.fechaActual.getFullYear();
            for (let i = 2024; i <= a√±oActual; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                dom.yearSelect.appendChild(opt);
            }
            dom.yearSelect.value = a√±oActual;
            
            dom.fechaActualDisplay.textContent = formatearFecha(appState.fechaActual);
            
            // Mostrar token guardado si existe
            if (appState.token) {
                dom.apiTokenInput.value = appState.token;
            }
            
            inicializarEventos();
            
            await cargarDatosIniciales();
            
            // Si hay token guardado, sincronizar autom√°ticamente
            if (appState.token) {
                setTimeout(() => sincronizarConGitHub(), 2000);
            } else {
                mostrarAlerta('‚ö†Ô∏è Ingresa tu token de GitHub para guardar datos', 'info');
            }
        }

        inicializar();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor en Tiempo Real - Afiliados Bateas Sector 3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary: #8BC34A;
            --primary-dark: #689F38;
            --secondary: #FFC107;
            --secondary-dark: #FFA000;
            --accent: #4CAF50;
            --light: #F1F8E9;
            --dark: #33691E;
            --text: #212121;
            --text-light: #757575;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            --info: #2196F3;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            --glass: rgba(255, 255, 255, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--gradient);
            min-height: 100vh;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Header */
        .header {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-icon {
            font-size: 2rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo-text h1 {
            color: var(--dark);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 15px;
            padding: 12px;
            background: var(--light);
            border-radius: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }
        
        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 5px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 150px;
            display: flex;
            flex-direction: column;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 1px;
            border-bottom: 1px solid var(--light);
        }
        
        .card-title {
            font-size: 1rem;
            color: var(--dark);
            font-weight: 600;
        }
        
        .card-icon {
            font-size: 1.3rem;
            color: var(--primary);
        }
        
        /* √öltimo Afiliado */
        .ultimo-afiliado {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .ultimo-afiliado .card-icon {
            color: white;
        }
        
        .afiliado-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            flex-shrink: 0;
        }
        
        .afiliado-datos {
            flex: 1;
            overflow: hidden;
        }
        
        .afiliado-datos h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            line-height: 1.2;
        }
        
        .afiliado-datos p {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Contador */
        .contador-card {
            text-align: center;
            justify-content: center;
        }
        
        .numero-contador {
            font-size: 3rem;
            font-weight: 800;
            color: var(--dark);
            line-height: 1;
            margin: 15px 0;
        }
        
        .contador-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* Gr√°fico */
        .chart-container {
            flex: 1;
            min-height: 0;
        }
        
       
        
        .notificaciones-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .notificacion {
            padding: 8px;
            border-radius: 10px;
            background: var(--light);
            border-left: 3px solid var(--success);
            font-size: 0.85rem;
        }
        
        .notificacion.nueva {
            border-left-color: var(--accent);
            background: #E8F5E9;
        }
        
        .notificacion-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 3px;
            text-align: right;
        }
        
        /* Lista de Afiliados */
        .afiliados-table-container {
            flex: 1;
            overflow: hidden;
            max-height: 180px;
        }
        
        .afiliados-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .afiliados-table th {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: left;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        
        .afiliados-table td {
            padding: 8px;
            border-bottom: 1px solid var(--light);
        }
        
        .badge-nuevo {
            background: var(--accent);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Controles */
        .controles {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(to right, var(--secondary), var(--secondary-dark));
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger), #d32f2f);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success), #388E3C);
            color: white;
        }
        
        /* Contador de actualizaci√≥n */
        .update-counter {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: var(--dark);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Notificaci√≥n Toast */
        .notification-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        
        .notification-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        
        /* Scroll personalizado */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 6px;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controles {
                flex-wrap: wrap;
            }
            
            .btn {
                flex: 1;
                min-width: 120px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }
            
            .logo-text h1 {
                font-size: 1.5rem;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .controles {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        .afiliados-table th:nth-child(1),
.afiliados-table td:nth-child(1) {
    width: 50px; /* ID */
}

.afiliados-table th:nth-child(2),
.afiliados-table td:nth-child(2) {
    width: 200px; /* Nombre */
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.afiliados-table th:nth-child(3),
.afiliados-table td:nth-child(3) {
    width: 100px; /* C√©dula */
}

.afiliados-table th:nth-child(4),
.afiliados-table td:nth-child(4) {
    width: 80px; /* Fecha */
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-container">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="logo-text">
                    <h1>MONITOR EN TIEMPO REAL</h1>
                    <p>Junta de Acci√≥n Comunal - Barrio Bateas Sector 3</p>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">Conectando...</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i>
                    <span id="lastUpdate">--:--:--</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount">0</span>
                </div>
            </div>
        </div>
        
        <!-- Dashboard -->
        <div class="dashboard">
            <!-- √öltimo Afiliado -->
            <div class="card ultimo-afiliado">
                <div class="card-header">
                    <h2 class="card-title">√öLTIMO AFILIADO</h2>
                    <div class="card-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                </div>
                <div class="afiliado-info">
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="afiliado-datos">
                        <h3 id="ultimoNombre">Cargando...</h3>
                        <p><i class="fas fa-id-card"></i> C√©dula: <span id="ultimoCedula">--</span></p>
                        <p><i class="fas fa-calendar-alt"></i> Fecha: <span id="ultimoFecha">--</span></p>
                        <p><i class="fas fa-hashtag"></i> ID: <span id="ultimoId">--</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Contador Total -->
            <div class="card contador-card">
                <div class="card-header">
                    <h2 class="card-title">TOTAL AFILIADOS</h2>
                    <div class="card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="numero-contador" id="totalAfiliados">0</div>
                <p class="contador-label">Afiliados activos registrados</p>
            </div>
            
            <!-- Estad√≠sticas -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ESTAD√çSTICAS</h2>
                    <div class="card-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>
        </div>
        
        
        
        
        <!-- Lista de Afiliados -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">LISTA DE AFILIADOS</h2>
                <div class="card-icon">
                    <i class="fas fa-list"></i>
                </div>
            </div>
            <div class="afiliados-table-container">
                <table class="afiliados-table" id="afiliadosTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>C√©dula</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="afiliadosBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Controles -->
        <div class="controles">
            <button class="btn btn-primary" id="btnActualizar">
                <i class="fas fa-sync-alt"></i> Actualizar Ahora
            </button>
            <button class="btn btn-secondary" id="btnVerDetalles">
                <i class="fas fa-eye"></i> Ver Detalles
            </button>
            <button class="btn btn-success" id="btnForzarActualizacion">
                <i class="fas fa-bolt"></i> Forzar Actualizaci√≥n
            </button>
            <button class="btn btn-danger" id="btnTestConexion">
                <i class="fas fa-wifi"></i> Test Conexi√≥n
            </button>
        </div>
    </div>
    
    <!-- Contador de actualizaci√≥n -->
    <div class="update-counter" id="updateCounter">
        <i class="fas fa-clock"></i>
        <span id="nextUpdate">Pr√≥xima actualizaci√≥n: 60s</span>
    </div>
    
    <!-- Notificaci√≥n Toast -->
    <div class="notification-toast" id="notificationToast">
        <button class="notification-close" id="closeNotification">
            <i class="fas fa-times"></i>
        </button>
        <h3 id="toastTitle">¬°Nuevo Afiliado!</h3>
        <p id="toastMessage">Cargando informaci√≥n...</p>
        <div class="notificacion-time" id="toastTime"></div>
    </div>
    
    <script>
        // Variables globales
        let afiliados = [];
        let ultimoAfiliado = null;
        let notificaciones = [];
        let chartInstance = null;
        let updateInterval = null;
        let countdownInterval = null;
        let tiempoRestante = 60;
        let ultimoIdCargado = 0;
        
        // URL del JSON - Cambia esto seg√∫n tu estructura
        const JSON_URL = './afiliados.json'; // Si el JSON est√° en la misma carpeta
        // O si est√° en otra ubicaci√≥n:
        // const JSON_URL = 'https://carlos2601.github.io/bateas3/afiliados.json';
        
        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando monitor de afiliados...');
            console.log('üì° URL del JSON:', JSON_URL);
            configurarEventListeners();
            iniciarContadorActualizacion();
            cargarDatosRapido(); // Carga r√°pida inicial
            iniciarActualizacionAutomatica();
        });
        
        // Configurar event listeners
        function configurarEventListeners() {
            document.getElementById('btnActualizar').addEventListener('click', () => cargarDatosRapido());
            document.getElementById('btnVerDetalles').addEventListener('click', verDetallesCompletos);
            document.getElementById('btnForzarActualizacion').addEventListener('click', forzarActualizacion);
            document.getElementById('btnTestConexion').addEventListener('click', testConexion);
            document.getElementById('closeNotification').addEventListener('click', ocultarNotificacion);
        }
        
        // Funci√≥n de carga r√°pida
        async function cargarDatosRapido() {
            try {
                actualizarEstado('Cargando...', 'info');
                reiniciarContador(30); // Reiniciar contador a 30 segundos
                
                // Usar cach√© local primero para respuesta instant√°nea
                const datosCache = localStorage.getItem('afiliados_cache_real');
                if (datosCache) {
                    const datosParseados = JSON.parse(datosCache);
                    procesarDatos(datosParseados, true);
                }
                
                // Cargar desde GitHub en segundo plano
                setTimeout(async () => {
                    try {
                        console.log('üîÑ Actualizando desde GitHub en segundo plano...');
                        await cargarDesdeGitHub();
                    } catch (error) {
                        console.log('‚ö†Ô∏è Actualizaci√≥n en segundo plano fall√≥:', error.message);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error en carga r√°pida:', error);
                actualizarEstado('Error', 'danger');
            }
        }
        
        // Cargar desde GitHub - Soluci√≥n CORS
        async function cargarDesdeGitHub() {
            try {
                console.log('üîÑ Intentando conectar a GitHub...');
                actualizarEstado('Conectando...', 'info');
                
                // Crear un identificador √∫nico para evitar cach√©
                const timestamp = Date.now();
                
                // Intentar diferentes m√©todos para evitar CORS
                let datos = null;
                let metodoUsado = '';
                
                // M√©todo 1: Usar raw.githubusercontent directamente con no-cache
                try {
                    console.log('üì° M√©todo 1: Raw GitHub...');
                    const response = await fetch(`${JSON_URL}?t=${timestamp}`, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (response.ok) {
                        datos = await response.json();
                        metodoUsado = 'raw.githubusercontent';
                        console.log('‚úÖ M√©todo 1 exitoso');
                    } else {
                        throw new Error('M√©todo 1 fall√≥');
                    }
                } catch (error1) {
                    console.log('‚ö†Ô∏è M√©todo 1 fall√≥, intentando M√©todo 2...');
                    
                    // M√©todo 2: Usar GitHub Pages si existe
                    try {
                        const githubPagesUrl = 'https://carlos2601.github.io/bateas3/afiliados.json';
                        const response = await fetch(`${githubPagesUrl}?t=${timestamp}`, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });
                        
                        if (response.ok) {
                            datos = await response.json();
                            metodoUsado = 'GitHub Pages';
                            console.log('‚úÖ M√©todo 2 exitoso');
                        } else {
                            throw new Error('M√©todo 2 fall√≥');
                        }
                    } catch (error2) {
                        console.log('‚ö†Ô∏è M√©todo 2 fall√≥, intentando M√©todo 3...');
                        
                        // M√©todo 3: Usar un proxy simple
                        try {
                            // Lista de proxies CORS alternativos
                            const proxies = [
                                `https://corsproxy.io/?${encodeURIComponent(JSON_URL + '?t=' + timestamp)}`,
                                `https://api.allorigins.win/raw?url=${encodeURIComponent(JSON_URL + '?t=' + timestamp)}`,
                                `https://thingproxy.freeboard.io/fetch/${encodeURIComponent(JSON_URL + '?t=' + timestamp)}`
                            ];
                            
                            for (let i = 0; i < proxies.length; i++) {
                                try {
                                    console.log(`üì° Intentando proxy ${i + 1}...`);
                                    const response = await fetch(proxies[i], {
                                        method: 'GET',
                                        headers: {
                                            'Accept': 'application/json'
                                        }
                                    });
                                    
                                    if (response.ok) {
                                        const text = await response.text();
                                        datos = JSON.parse(text);
                                        metodoUsado = `Proxy ${i + 1}`;
                                        console.log(`‚úÖ Proxy ${i + 1} exitoso`);
                                        break;
                                    }
                                } catch (proxyError) {
                                    console.log(`‚ö†Ô∏è Proxy ${i + 1} fall√≥`);
                                }
                            }
                            
                            if (!datos) {
                                throw new Error('Todos los proxies fallaron');
                            }
                        } catch (error3) {
                            console.log('‚ùå Todos los m√©todos fallaron');
                            throw new Error('No se pudo conectar a GitHub');
                        }
                    }
                }
                
                // Procesar datos si se obtuvieron
                if (datos) {
                    console.log(`‚úÖ Datos obtenidos (${metodoUsado}):`, datos.length, 'registros');
                    
                    // Procesar y comparar con cach√©
                    procesarDatos(datos, false);
                    actualizarEstado('Actualizado', 'success');
                    actualizarUltimaActualizacion();
                    
                    // Guardar en cach√©
                    localStorage.setItem('afiliados_cache_real', JSON.stringify(datos));
                    localStorage.setItem('ultima_actualizacion', Date.now());
                    localStorage.setItem('metodo_conexion', metodoUsado);
                    
                    // Mostrar notificaci√≥n de √©xito
                    mostrarNotificacion('Actualizaci√≥n exitosa', 
                        `Datos obtenidos via ${metodoUsado}`, 'success');
                }
                
            } catch (error) {
                console.log('‚ö†Ô∏è Error conectando a GitHub:', error.message);
                
                // Verificar si hay cach√© local
                const datosCache = localStorage.getItem('afiliados_cache_real');
                if (datosCache) {
                    console.log('üìÇ Usando datos de cach√©...');
                    const datosParseados = JSON.parse(datosCache);
                    procesarDatos(datosParseados, true);
                    actualizarEstado('Cach√© (sin conexi√≥n)', 'warning');
                    
                    // Mostrar advertencia
                    mostrarNotificacion('Modo sin conexi√≥n', 
                        'Usando datos almacenados localmente', 'warning');
                } else {
                    actualizarEstado('Sin conexi√≥n', 'danger');
                    mostrarNotificacion('Error de conexi√≥n', 
                        'No se pudo conectar y no hay datos locales', 'danger');
                }
            }
        }
        
        // Procesar datos CORREGIDO: Ordenar por ID num√©rico descendente
        function procesarDatos(datos, esCache = false) {
            console.log('üìä Procesando datos...');
            
            if (!Array.isArray(datos)) {
                console.error('‚ùå Los datos no son un array');
                return;
            }
            
            // Guardar cantidad anterior para detectar cambios
            const cantidadAnterior = afiliados.length;
            
            // ORDENAR POR ID NUM√âRICO DESCENDENTE (m√°s alto = m√°s nuevo)
            afiliados = normalizarDatos(datos).sort((a, b) => {
                // Convertir IDs a n√∫meros para comparar correctamente
                const idA = parseInt(a.id) || 0;
                const idB = parseInt(b.id) || 0;
                return idB - idA; // Orden descendente (m√°s alto primero)
            });
            
            console.log('‚úÖ Datos ordenados por ID descendente');
            console.log('üìä Primeros 3 (m√°s nuevos):', afiliados.slice(0, 3));
            
            // Actualizar contador
            actualizarContador();
            
            // Encontrar el ID m√°s alto (√∫ltimo afiliado)
            const ultimoId = Math.max(...afiliados.map(a => parseInt(a.id) || 0));
            const nuevoUltimo = afiliados.find(a => parseInt(a.id) === ultimoId);
            
            if (nuevoUltimo) {
                console.log('üéØ √öltimo afiliado (ID m√°s alto):', nuevoUltimo.id, '-', nuevoUltimo.nombre);
                
                // Verificar si es un afiliado realmente nuevo
                const idAnterior = ultimoAfiliado ? parseInt(ultimoAfiliado.id) || 0 : 0;
                const idActual = parseInt(nuevoUltimo.id) || 0;
                
                if (idActual > idAnterior) {
                    console.log(`üÜï Nuevo afiliado detectado! ID anterior: ${idAnterior}, ID nuevo: ${idActual}`);
                    
                    if (!esCache && idAnterior > 0) {
                        // Es una actualizaci√≥n real, mostrar notificaci√≥n
                        procesarNuevoAfiliado(nuevoUltimo);
                    }
                    
                    actualizarUltimoAfiliado(nuevoUltimo);
                } else if (ultimoAfiliado === null) {
                    // Primera carga
                    actualizarUltimoAfiliado(nuevoUltimo);
                }
            }
            
            // Actualizar lista
            actualizarListaAfiliados();
            
            // Actualizar gr√°fico
            actualizarGrafico();
            
            // Actualizar notificaciones si hay cambios
            if (cantidadAnterior !== afiliados.length && !esCache) {
                mostrarNotificacion(
                    'Datos actualizados',
                    `Ahora hay ${afiliados.length} afiliados`,
                    'info'
                );
            }
        }
        
        // Normalizar datos
        function normalizarDatos(datos) {
            return datos.map(item => {
                // Asegurar que el ID sea tratado como n√∫mero
                const idNumero = parseInt(item.id) || 0;
                
                return {
                    id: idNumero.toString(),
                    nombre: item.nombre || 'Sin nombre',
                    cedula: item.cedula || 'Sin c√©dula',
                    fecha_afiliacion: item.fecha_afiliacion || 'Sin fecha',
                    registro: item.registro || '',
                    folio: item.folio || '',
                    renglon: item.renglon || '',
                    direccion: item.direccion || 'Sin direcci√≥n',
                    nuevo: false
                };
            });
        }
        
        // Procesar nuevo afiliado
        function procesarNuevoAfiliado(afiliado) {
            console.log('üéâ Procesando nuevo afiliado:', afiliado.nombre);
            
            // Marcar como nuevo
            afiliado.nuevo = true;
            
            // Crear notificaci√≥n
            const notificacion = {
                id: Date.now(),
                tipo: 'nuevo',
                titulo: '¬°NUEVO AFILIADO REGISTRADO!',
                mensaje: `${afiliado.nombre}`,
                detalles: `ID: ${afiliado.id} | C√©dula: ${afiliado.cedula} | Fecha: ${new Date(afiliado.fecha_afiliacion).toLocaleDateString('es-CO')}`,
                timestamp: new Date().toLocaleTimeString('es-CO'),
                fecha: new Date().toLocaleDateString('es-CO')
            };
            
            agregarNotificacion(notificacion);
            
            // Mostrar notificaci√≥n con sonido
            mostrarNotificacion(
                'üéâ NUEVO AFILIADO',
                `${afiliado.nombre}`,
                'success'
            );
            
            // Reproducir sonido de notificaci√≥n
            reproducirSonidoNotificacion();
        }
        
        // Reproducir sonido de notificaci√≥n
        function reproducirSonidoNotificacion() {
            try {
                // Crear sonido simple
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('‚ö†Ô∏è No se pudo reproducir sonido');
            }
        }
        
        // Actualizar contador
        function actualizarContador() {
            const total = afiliados.length;
            const elemento = document.getElementById('totalAfiliados');
            elemento.textContent = total;
            
            // Animaci√≥n
            elemento.classList.add('animate__animated', 'animate__pulse');
            setTimeout(() => {
                elemento.classList.remove('animate__animated', 'animate__pulse');
            }, 500);
        }
        
        // Actualizar √∫ltimo afiliado
        function actualizarUltimoAfiliado(afiliado) {
            ultimoAfiliado = afiliado;
            
            document.getElementById('ultimoNombre').textContent = afiliado.nombre;
            document.getElementById('ultimoCedula').textContent = afiliado.cedula;
            document.getElementById('ultimoId').textContent = `#${afiliado.id}`;
            
            // Formatear fecha
            const fecha = new Date(afiliado.fecha_afiliacion);
            const fechaFormateada = !isNaN(fecha.getTime()) ? 
                fecha.toLocaleDateString('es-CO') : 
                afiliado.fecha_afiliacion;
            document.getElementById('ultimoFecha').textContent = fechaFormateada;
            
            // Animaci√≥n
            const card = document.querySelector('.ultimo-afiliado');
            card.classList.add('animate__animated', 'animate__pulse');
            setTimeout(() => {
                card.classList.remove('animate__animated', 'animate__pulse');
            }, 1000);
        }
        
       // Actualizar lista de afiliados
function actualizarListaAfiliados() {
    const tbody = document.getElementById('afiliadosBody');
    tbody.innerHTML = '';
    
    // Mostrar primeros 5 afiliados (ya est√°n ordenados por ID descendente)
    const ultimosAfiliados = afiliados.slice(0, 5);
    
    ultimosAfiliados.forEach(afiliado => {
        const tr = document.createElement('tr');
        
        // Formatear fecha
        const fecha = new Date(afiliado.fecha_afiliacion);
        const fechaFormateada = !isNaN(fecha.getTime()) ? 
            fecha.toLocaleDateString('es-CO', { day: 'numeric', month: 'short' }) : 
            afiliado.fecha_afiliacion;
        
        tr.innerHTML = `
            <td style="font-weight: bold;">${afiliado.id}</td>
            <td>
                <div style="font-weight: 500; font-size: 0.85rem;">
                    ${afiliado.nombre}
                </div>
                ${afiliado.nuevo ? '<span class="badge-nuevo">NUEVO</span>' : ''}
            </td>
            <td>${afiliado.cedula}</td>
            <td>${fechaFormateada}</td>
        `;
        
        tbody.appendChild(tr);
    });
}
        
        // Actualizar gr√°fico
        function actualizarGrafico() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Datos para el gr√°fico
            const ultimos5Dias = obtenerAfiliacionesPorDia(5);
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ultimos5Dias.map(d => d.dia),
                    datasets: [{
                        label: 'Afiliaciones por d√≠a',
                        data: ultimos5Dias.map(d => d.cantidad),
                        backgroundColor: '#8BC34A',
                        borderColor: '#689F38',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Obtener afiliaciones por d√≠a
        function obtenerAfiliacionesPorDia(dias) {
            const resultado = [];
            const hoy = new Date();
            
            for (let i = dias - 1; i >= 0; i--) {
                const fecha = new Date();
                fecha.setDate(hoy.getDate() - i);
                const fechaStr = fecha.toLocaleDateString('es-CO', { day: 'numeric', month: 'short' });
                
                const cantidad = afiliados.filter(a => {
                    try {
                        const fechaAfiliacion = new Date(a.fecha_afiliacion);
                        return fechaAfiliacion.toDateString() === fecha.toDateString();
                    } catch (e) {
                        return false;
                    }
                }).length;
                
                resultado.push({
                    dia: fechaStr,
                    cantidad: cantidad
                });
            }
            
            return resultado;
        }
        
        // Agregar notificaci√≥n
        function agregarNotificacion(notificacion) {
            notificaciones.unshift(notificacion);
            
            // Limitar a 5 notificaciones
            if (notificaciones.length > 5) {
                notificaciones = notificaciones.slice(0, 5);
            }
            
            actualizarListaNotificaciones();
            actualizarContadorNotificaciones();
            
            // Guardar notificaciones
            localStorage.setItem('monitor_notificaciones', JSON.stringify(notificaciones));
        }
        
        // Actualizar lista de notificaciones
        function actualizarListaNotificaciones() {
            const lista = document.getElementById('notificacionesList');
            lista.innerHTML = '';
            
            notificaciones.slice(0, 4).forEach(notif => {
                const div = document.createElement('div');
                div.className = `notificacion ${notif.tipo === 'nuevo' ? 'nueva' : ''}`;
                div.innerHTML = `
                    <strong>${notif.titulo}</strong>
                    <p>${notif.mensaje}</p>
                    <small style="color: #666;">${notif.detalles || ''}</small>
                    <div class="notificacion-time">${notif.timestamp}</div>
                `;
                lista.appendChild(div);
            });
        }
        
        // Mostrar notificaci√≥n toast
        function mostrarNotificacion(titulo, mensaje, tipo = 'info') {
            const toast = document.getElementById('notificationToast');
            document.getElementById('toastTitle').textContent = titulo;
            document.getElementById('toastMessage').textContent = mensaje;
            document.getElementById('toastTime').textContent = new Date().toLocaleTimeString('es-CO');
            
            toast.style.display = 'block';
            
            setTimeout(() => {
                if (toast.style.display === 'block') {
                    ocultarNotificacion();
                }
            }, 5000);
        }
        
        // Ocultar notificaci√≥n
        function ocultarNotificacion() {
            document.getElementById('notificationToast').style.display = 'none';
        }
        
        // Actualizar estado
        function actualizarEstado(mensaje, tipo = 'info') {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            text.textContent = mensaje;
            
            const colores = {
                success: '#4CAF50',
                warning: '#FF9800',
                danger: '#F44336',
                info: '#2196F3'
            };
            
            indicator.style.background = colores[tipo] || colores.info;
        }
        
        // Actualizar √∫ltima actualizaci√≥n
        function actualizarUltimaActualizacion() {
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('lastUpdate').textContent = hora;
        }
        
        // Actualizar contador de notificaciones
        function actualizarContadorNotificaciones() {
            const nuevas = notificaciones.filter(n => n.tipo === 'nuevo').length;
            document.getElementById('notificationCount').textContent = nuevas;
        }
        
        // Iniciar contador de actualizaci√≥n
        function iniciarContadorActualizacion() {
            tiempoRestante = 60;
            actualizarContadorUI();
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                tiempoRestante--;
                actualizarContadorUI();
                
                if (tiempoRestante <= 0) {
                    reiniciarContador(60);
                }
            }, 1000);
        }
        
        // Actualizar contador UI
        function actualizarContadorUI() {
            document.getElementById('nextUpdate').textContent = `Pr√≥xima: ${tiempoRestante}s`;
            
            // Cambiar color seg√∫n tiempo restante
            const counter = document.getElementById('updateCounter');
            if (tiempoRestante <= 10) {
                counter.style.background = 'var(--warning)';
            } else if (tiempoRestante <= 5) {
                counter.style.background = 'var(--danger)';
            } else {
                counter.style.background = 'var(--dark)';
            }
        }
        
        // Reiniciar contador
        function reiniciarContador(segundos = 60) {
            tiempoRestante = segundos;
            actualizarContadorUI();
        }
        
        // Iniciar actualizaci√≥n autom√°tica
        function iniciarActualizacionAutomatica() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // Actualizar cada 60 segundos
            updateInterval = setInterval(() => {
                console.log('üîÑ Actualizaci√≥n autom√°tica iniciada');
                cargarDesdeGitHub();
                reiniciarContador(60);
            }, 60000);
            
            console.log('üîÑ Actualizaci√≥n autom√°tica configurada cada 60 segundos');
        }
        
        // Forzar actualizaci√≥n inmediata
        function forzarActualizacion() {
            console.log('‚ö° Forzando actualizaci√≥n...');
            reiniciarContador(10);
            cargarDesdeGitHub();
            mostrarNotificacion('Actualizando', 'Buscando nuevos afiliados...', 'info');
        }
        
        // Test de conexi√≥n
        async function testConexion() {
            console.log('üì° Probando conexi√≥n a GitHub...');
            actualizarEstado('Probando conexi√≥n...', 'warning');
            
            try {
                const inicio = Date.now();
                const response = await fetch('https://api.github.com/repos/carlos2601/bateas3', {
                    method: 'HEAD',
                    mode: 'cors'
                });
                const fin = Date.now();
                
                if (response.ok) {
                    const tiempo = fin - inicio;
                    mostrarNotificacion('Conexi√≥n OK', `GitHub responde en ${tiempo}ms`, 'success');
                    actualizarEstado('Conectado', 'success');
                } else {
                    throw new Error('GitHub no responde');
                }
            } catch (error) {
                mostrarNotificacion('Error conexi√≥n', 'No se puede conectar a GitHub', 'danger');
                actualizarEstado('Sin conexi√≥n', 'danger');
            }
        }
        
        // Ver detalles completos
        function verDetallesCompletos() {
            if (!ultimoAfiliado) {
                mostrarNotificacion('Sin datos', 'No hay afiliados cargados', 'warning');
                return;
            }
            
            const detalles = `
üè¢ DETALLES COMPLETOS DEL √öLTIMO AFILIADO

üë§ NOMBRE: ${ultimoAfiliado.nombre}
üÜî C√âDULA: ${ultimoAfiliado.cedula}
üìÖ FECHA DE AFILIACI√ìN: ${new Date(ultimoAfiliado.fecha_afiliacion).toLocaleDateString('es-CO')}
üìã REGISTRO: ${ultimoAfiliado.registro}
üìñ FOLIO: ${ultimoAfiliado.folio}
üìù RENGL√ìN: ${ultimoAfiliado.renglon}
üè† DIRECCI√ìN: ${ultimoAfiliado.direccion}
üî¢ ID: ${ultimoAfiliado.id}

üìä TOTAL DE AFILIADOS: ${afiliados.length}
            `;
            
            alert(detalles);
        }
        
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JAC Bateas ¬∑ Mi Cuenta</title>
    <style>
        /* ===== RESET Y VARIABLES - PALETA VERDES Y AMARILLOS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #2b5e2b 0%, #1e4a1e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
        }

        .app {
            max-width: 380px;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0, 40, 0, 0.2);
            padding: 24px 20px;
            border: 1px solid rgba(160, 200, 160, 0.3);
        }

        /* ===== HEADER COMPACTO ===== */
        .header {
            text-align: center;
            margin-bottom: 28px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .logo-icon {
            background: linear-gradient(135deg, #2d6a4f 0%, #1b4d3e 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 8px 15px rgba(29, 78, 49, 0.25);
        }

        .logo-text {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #2d6a4f 0%, #1b4d3e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge {
            background: #e9f5e9;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.65rem;
            font-weight: 600;
            color: #2d6a4f;
            display: inline-block;
            border: 1px solid #b7e4b7;
        }

        /* ===== BUSCADOR CENTRADO Y COMPACTO ===== */
        .search-section {
            background: white;
            border-radius: 24px;
            padding: 20px 16px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(45, 106, 79, 0.1);
            border: 1px solid #d0ebd0;
        }

        .search-title {
            text-align: center;
            margin-bottom: 16px;
        }

        .search-title h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e4a1e;
            margin-bottom: 4px;
        }

        .search-title p {
            font-size: 0.7rem;
            color: #5b8c5b;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 12px;
        }

        .input-wrapper i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #8bb88b;
            font-size: 1rem;
        }

        #cedulaInput {
            width: 100%;
            padding: 14px 16px 14px 45px;
            border: 2px solid #d0ebd0;
            border-radius: 16px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: #f8fff8;
            text-align: center;
            letter-spacing: 1px;
        }

        #cedulaInput:focus {
            border-color: #2d6a4f;
            background: white;
            box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.1);
            outline: none;
        }

        #cedulaInput::placeholder {
            color: #b7d9b7;
            font-size: 0.8rem;
            letter-spacing: normal;
        }

        .btn-consulta {
            width: 100%;
            background: linear-gradient(135deg, #2d6a4f 0%, #1b4d3e 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 8px 15px rgba(45, 106, 79, 0.25);
        }

        .btn-consulta:active {
            transform: scale(0.98);
            box-shadow: 0 4px 10px rgba(45, 106, 79, 0.2);
        }

        /* ===== MODAL MODERNO CON DESPLAZAMIENTO ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 40, 0, 0.5);
            backdrop-filter: blur(8px);
            align-items: flex-end;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 380px;
            border-radius: 32px 32px 0 0;
            padding: 24px 20px;
            transform: translateY(100%);
            animation: slideUp 0.3s ease forwards;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 -10px 30px rgba(0, 40, 0, 0.15);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e3f0e3;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #1e4a1e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-close {
            background: #e3f0e3;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2d6a4f;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-close:active {
            background: #c8e0c8;
            transform: scale(0.9);
        }

        /* ===== PERFIL COMPACTO CON FECHA DE AFILIACI√ìN ===== */
        .profile-card {
            background: linear-gradient(135deg, #f0f9f0 0%, #ffffff 100%);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #c8e4c8;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar-mini {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2d6a4f 0%, #1b4d3e 100%);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            font-weight: 600;
            box-shadow: 0 8px 15px rgba(45, 106, 79, 0.2);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1e4a1e;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .profile-detail {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: #5b8c5b;
            margin-bottom: 4px;
        }

        .profile-detail i {
            color: #8bb88b;
            width: 16px;
        }

        .profile-detail span {
            color: #2d6a4f;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 14px;
            border-radius: 100px;
            font-size: 0.6rem;
            font-weight: 700;
            background: #d4edda;
            color: #155724;
            border: 1px solid #a3d0b1;
        }

        .status-badge.debt {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        /* ===== STATS COMPACTAS CON INFORMACI√ìN DE DEUDA ===== */
        .stats-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-mini-card {
            background: #f5fbf5;
            border-radius: 18px;
            padding: 16px 12px;
            border: 1px solid #d4e8d4;
            box-shadow: 0 4px 10px rgba(45, 106, 79, 0.03);
        }

        .stat-mini-label {
            font-size: 0.6rem;
            font-weight: 700;
            color: #5b8c5b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-mini-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e4a1e;
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-mini-desc {
            font-size: 0.55rem;
            color: #8bb88b;
        }

        /* ===== TARJETA DE DEuda - DESTACADA ===== */
        .debt-summary-card {
            background: #fff9e6;
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 20px;
            border: 2px solid #ffd966;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debt-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .debt-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #856404;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .debt-months {
            font-size: 1.1rem;
            font-weight: 700;
            color: #b9770e;
        }

        .debt-total {
            font-size: 1.3rem;
            font-weight: 800;
            color: #b9770e;
            background: #fff3cd;
            padding: 8px 16px;
            border-radius: 100px;
            border: 1px solid #ffe5a3;
        }

        /* ===== SECCI√ìN MESES PENDIENTES ===== */
        .pending-section {
            background: #fff9e6;
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #ffe5a3;
        }

        .pending-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
            color: #856404;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .pending-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pending-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: white;
            border-radius: 14px;
            border: 1px solid #ffe5a3;
        }

        .pending-month {
            font-size: 0.8rem;
            font-weight: 600;
            color: #856404;
        }

        .pending-amount {
            font-size: 0.8rem;
            font-weight: 700;
            color: #b9770e;
            background: #fff3cd;
            padding: 4px 12px;
            border-radius: 100px;
        }

        /* ===== HISTORIAL COMPACTO ===== */
        .history-section {
            background: #f5fbf5;
            border-radius: 18px;
            padding: 16px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-header h4 {
            font-size: 0.8rem;
            font-weight: 700;
            color: #1e4a1e;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .year-filter {
            background: white;
            border: 1px solid #c8e4c8;
            border-radius: 100px;
            padding: 6px 14px;
            font-size: 0.65rem;
            font-weight: 600;
            color: #2d6a4f;
            outline: none;
        }

        .timeline-mini {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .timeline-item-mini {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-radius: 14px;
            border: 1px solid #d4e8d4;
            gap: 8px;
        }

        .timeline-month-mini {
            min-width: 65px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #1e4a1e;
        }

        .timeline-badge-mini {
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.6rem;
            font-weight: 600;
            background: #d4edda;
            color: #155724;
        }

        .timeline-amount-mini {
            margin-left: auto;
            font-size: 0.7rem;
            font-weight: 700;
            color: #2d6a4f;
        }

        .timeline-receipt-mini {
            background: #e3f0e3;
            padding: 3px 8px;
            border-radius: 100px;
            font-size: 0.55rem;
            color: #2d6a4f;
        }

        .empty-state {
            text-align: center;
            padding: 24px;
            background: white;
            border-radius: 16px;
            color: #8bb88b;
            font-size: 0.7rem;
        }

        /* ===== LOADING ===== */
        .loading-mini {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }

        .loading-spinner-mini {
            background: white;
            padding: 20px;
            border-radius: 24px;
            box-shadow: 0 15px 30px rgba(45, 106, 79, 0.15);
            text-align: center;
            border: 1px solid #c8e4c8;
        }

        .spinner-mini {
            width: 40px;
            height: 40px;
            border: 3px solid #e3f0e3;
            border-top: 3px solid #2d6a4f;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== ALERTAS ===== */
        .alert-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            display: none;
            z-index: 30000;
            box-shadow: 0 10px 25px rgba(0,40,0,0.1);
            border-left: 4px solid;
            width: 90%;
            max-width: 300px;
            text-align: center;
        }

        .alert-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        /* ===== FOOTER ===== */
        .footer-mini {
            margin-top: 20px;
            text-align: center;
            color: #8bb88b;
            font-size: 0.55rem;
            border-top: 1px solid #d4e8d4;
            padding-top: 16px;
        }

        /* ===== SCROLL PERSONALIZADO ===== */
        .modal-content::-webkit-scrollbar {
            width: 4px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #e3f0e3;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #8bb88b;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- LOADING COMPACTO -->
    <div id="loadingMini" class="loading-mini">
        <div class="loading-spinner-mini">
            <div class="spinner-mini"></div>
            <p style="color: #2d6a4f; font-size: 0.8rem; font-weight: 500;">Consultando...</p>
        </div>
    </div>

    <!-- ALERTA TOAST -->
    <div id="alertToast" class="alert-toast"></div>

    <!-- APLICACI√ìN PRINCIPAL -->
    <div class="app">
        <!-- HEADER COMPACTO -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üåø</div>
                <span class="logo-text">JAC Bateas</span>
            </div>
            <span class="badge">Mi Cuenta</span>
        </div>

        <!-- BUSCADOR CENTRADO -->
        <div class="search-section">
            <div class="search-title">
                <h2>üîç Consulta tu estado</h2>
                <p>Ingresa tu n√∫mero de documento</p>
            </div>
            
            <div class="input-wrapper">
                <i>üìÑ</i>
                <input type="text" id="cedulaInput" placeholder="C√©dula" inputmode="numeric" autocomplete="off">
            </div>
            
            <button id="btnConsultar" class="btn-consulta">
                <span>üìã</span>
                Ver mi informaci√≥n
            </button>
        </div>

        <!-- INFORMACI√ìN DE AYUDA -->
        <div style="text-align: center; color: #8bb88b; font-size: 0.6rem;">
            <span>Junta de Acci√≥n Comunal ¬∑ Bateas</span>
        </div>
    </div>

    <!-- MODAL DE RESULTADOS CON DESPLAZAMIENTO -->
    <div id="resultModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <span style="font-size: 1.2rem;">üë§</span>
                    Mi informaci√≥n
                </h3>
                <button id="closeModalBtn" class="btn-close">‚úï</button>
            </div>

            <!-- CONTENIDO DEL MODAL CON SCROLL -->
            <div id="modalBody">
                <!-- PERFIL COMPACTO CON FECHA DE AFILIACI√ìN -->
                <div class="profile-card">
                    <div class="avatar-mini" id="avatarMini">üë§</div>
                    <div class="profile-info">
                        <div class="profile-name" id="nombreAfiliado">Nombre completo</div>
                        <div class="profile-detail">
                            <i>üìÑ</i>
                            <span id="cedulaAfiliado">4438681</span>
                        </div>
                        <div class="profile-detail">
                            <i>üìÖ</i>
                            <span>Afiliaci√≥n: <span id="fechaAfiliacionMini">01/01/2024</span></span>
                        </div>
                        <div style="margin-top: 8px;">
                            <span class="status-badge" id="estadoBadge">‚úì AL D√çA</span>
                        </div>
                    </div>
                </div>

                <!-- ESTAD√çSTICAS COMPACTAS -->
                <div class="stats-mini">
                    <div class="stat-mini-card">
                        <div class="stat-mini-label">üí∞ Pagado</div>
                        <div class="stat-mini-value" id="totalPagadoMini">$0</div>
                        <div class="stat-mini-desc">total cancelado</div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-label">‚úÖ Cuotas</div>
                        <div class="stat-mini-value" id="cuotasPagadasMini">0</div>
                        <div class="stat-mini-desc">meses pagados</div>
                    </div>
                </div>

                <!-- TARJETA RESUMEN DE DEUDA (meses y valor total) -->
                <div class="debt-summary-card" id="debtSummary">
                    <div class="debt-info">
                        <span class="debt-label">üìä MESES PENDIENTES</span>
                        <span class="debt-months" id="mesesPendientesCount">0 meses</span>
                    </div>
                    <div class="debt-total" id="deudaTotalValue">$0</div>
                </div>

                <!-- MESES PENDIENTES POR PAGAR (LISTA DETALLADA) -->
                <div class="pending-section" id="pendingSection">
                    <div class="pending-title">
                        <span>‚ö†Ô∏è</span>
                        <span>Detalle de meses pendientes</span>
                    </div>
                    <div class="pending-list" id="pendingList">
                        <!-- CONTENIDO DIN√ÅMICO -->
                    </div>
                </div>

                <!-- HISTORIAL DE PAGOS -->
                <div class="history-section">
                    <div class="history-header">
                        <h4>
                            <span>üìä</span>
                            Historial de pagos
                        </h4>
                        <select id="filtroAnioModal" class="year-filter">
                            <option value="todos">Todos</option>
                        </select>
                    </div>
                    
                    <div id="timelineContainerMini">
                        <!-- CONTENIDO DIN√ÅMICO -->
                    </div>
                </div>

                <!-- FECHA DE CONSULTA -->
                <div style="text-align: center; margin-top: 16px; color: #8bb88b; font-size: 0.55rem;">
                    Consulta realizada el <span id="fechaConsultaModal"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // JAC BATEAS - CONSULTA M√ìVIL MODERNA
        // Colores: verdes oscuros (#2d6a4f, #1b4d3e) y amarillo oscuro (#856404)
        // ============================================================

        const CONFIG = {
            REPO_OWNER: 'carlos2601',
            REPO_NAME: 'juntadeaccioncomunalbarriobateaspuertogaitanmetalilianalondo-ogallego1010101010101000111010001010010',
            AFILIADOS_PATH: 'afiliados.json',
            CUOTA_PATH: 'cuota.json',
            BRANCH: 'main',
            VALOR_CUOTA: 5000
        };

        let appState = {
            afiliados: [],
            pagos: [],
            fechaActual: new Date()
        };

        const dom = {
            loading: document.getElementById('loadingMini'),
            alert: document.getElementById('alertToast'),
            cedulaInput: document.getElementById('cedulaInput'),
            btnConsultar: document.getElementById('btnConsultar'),
            modal: document.getElementById('resultModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            avatarMini: document.getElementById('avatarMini'),
            nombreAfiliado: document.getElementById('nombreAfiliado'),
            cedulaAfiliado: document.getElementById('cedulaAfiliado'),
            fechaAfiliacionMini: document.getElementById('fechaAfiliacionMini'),
            estadoBadge: document.getElementById('estadoBadge'),
            totalPagadoMini: document.getElementById('totalPagadoMini'),
            cuotasPagadasMini: document.getElementById('cuotasPagadasMini'),
            mesesPendientesCount: document.getElementById('mesesPendientesCount'),
            deudaTotalValue: document.getElementById('deudaTotalValue'),
            debtSummary: document.getElementById('debtSummary'),
            pendingSection: document.getElementById('pendingSection'),
            pendingList: document.getElementById('pendingList'),
            filtroAnioModal: document.getElementById('filtroAnioModal'),
            timelineContainerMini: document.getElementById('timelineContainerMini'),
            fechaConsultaModal: document.getElementById('fechaConsultaModal')
        };

        // ============================================================
        // UTILIDADES
        // ============================================================

        function mostrarLoading() {
            dom.loading.style.display = 'flex';
        }

        function ocultarLoading() {
            dom.loading.style.display = 'none';
        }

        function mostrarAlerta(mensaje, tipo = 'error') {
            dom.alert.textContent = mensaje;
            dom.alert.className = `alert-toast alert-${tipo}`;
            dom.alert.style.display = 'block';
            
            setTimeout(() => {
                dom.alert.style.display = 'none';
            }, 3000);
        }

        function formatearMoneda(valor) {
            return `$${valor.toLocaleString('es-CO')}`;
        }

        function formatearFechaCorta(date) {
            return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function parseFecha(fechaStr) {
            if (!fechaStr) return new Date();
            const partes = fechaStr.split('/');
            return new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
        }

        function obtenerNumeroMes(nombreMes) {
            const meses = {
                'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3,
                'mayo': 4, 'junio': 5, 'julio': 6, 'agosto': 7,
                'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11
            };
            return meses[nombreMes?.toLowerCase()] || 0;
        }

        function nombreMes(numero) {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return meses[numero];
        }

        // ============================================================
        // CARGA DE DATOS
        // ============================================================

        async function cargarAfiliados() {
            const url = `https://raw.githubusercontent.com/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/refs/heads/${CONFIG.BRANCH}/${CONFIG.AFILIADOS_PATH}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Error cargando afiliados');
                return await res.json();
            } catch (e) {
                console.error(e);
                return [];
            }
        }

        async function cargarPagos() {
            const url = `https://raw.githubusercontent.com/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/refs/heads/${CONFIG.BRANCH}/${CONFIG.CUOTA_PATH}`;
            try {
                const res = await fetch(url);
                if (res.status === 404) return [];
                const data = await res.json();
                return data.pagos || [];
            } catch (e) {
                console.error(e);
                return [];
            }
        }

        // ============================================================
        // PROCESAMIENTO DE PAGOS
        // ============================================================

        function extraerPagosDeString(str, a√±o) {
            if (!str) return [];
            return str.split(';').filter(p => p.trim()).map(p => {
                const partes = p.trim().split('_');
                return {
                    mes: partes[0],
                    a√±o: parseInt(partes[1]),
                    valor: parseInt(partes[2]),
                    fecha: partes[3],
                    recibo: partes[4] || 'N/A'
                };
            }).filter(p => p.a√±o === a√±o);
        }

        function obtenerPagosAfiliado(cedula) {
            const registro = appState.pagos.find(p => p.cedula === cedula);
            if (!registro) return [];
            
            const pagos = [];
            const a√±os = [2024, 2025, 2026];
            
            a√±os.forEach(a√±o => {
                const campo = `fecha_pago_a√±o_${a√±o}`;
                const pagosA√±o = extraerPagosDeString(registro[campo], a√±o);
                pagos.push(...pagosA√±o);
            });
            
            return pagos.sort((a, b) => {
                const fechaA = new Date(b.a√±o, obtenerNumeroMes(b.mes), 1);
                const fechaB = new Date(a.a√±o, obtenerNumeroMes(a.mes), 1);
                return fechaA - fechaB;
            });
        }

        function mesEstaPagado(cedula, a√±o, mes) {
            const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            const registro = appState.pagos.find(p => p.cedula === cedula);
            if (!registro) return false;
            const pagosStr = registro[`fecha_pago_a√±o_${a√±o}`] || '';
            return pagosStr.split(';').some(p => p.trim().startsWith(`${meses[mes]}_${a√±o}`));
        }

        function calcularMesesDeuda(cedula, fechaAfiliacion) {
            const afiliacion = parseFecha(fechaAfiliacion);
            const hoy = appState.fechaActual;
            const meses = [];
            
            for (let a√±o = afiliacion.getFullYear(); a√±o <= hoy.getFullYear(); a√±o++) {
                const mesInicio = (a√±o === afiliacion.getFullYear()) ? afiliacion.getMonth() : 0;
                const mesFin = (a√±o === hoy.getFullYear()) ? hoy.getMonth() : 11;
                
                for (let mes = mesInicio; mes <= mesFin; mes++) {
                    if (!mesEstaPagado(cedula, a√±o, mes)) {
                        meses.push({ a√±o, mes });
                    }
                }
            }
            
            return meses;
        }

        // ============================================================
        // CONSULTA PRINCIPAL
        // ============================================================

        async function consultarAfiliado() {
            const cedula = dom.cedulaInput.value.trim();
            
            if (!cedula) {
                mostrarAlerta('Ingresa tu n√∫mero de c√©dula', 'error');
                return;
            }

            if (cedula.length < 5) {
                mostrarAlerta('C√©dula inv√°lida', 'error');
                return;
            }

            mostrarLoading();

            try {
                const afiliado = appState.afiliados.find(a => a.cedula === cedula);
                
                if (!afiliado) {
                    ocultarLoading();
                    mostrarAlerta('Afiliado no encontrado', 'error');
                    return;
                }

                // Procesar informaci√≥n
                const pagosAfiliado = obtenerPagosAfiliado(cedula);
                const mesesDeuda = calcularMesesDeuda(cedula, afiliado.fecha);
                const totalPagado = pagosAfiliado.reduce((sum, p) => sum + p.valor, 0);
                const deudaTotal = mesesDeuda.length * CONFIG.VALOR_CUOTA;
                
                // Limitar nombre a 25 caracteres
                const nombreCorto = afiliado.nombre.length > 25 
                    ? afiliado.nombre.substring(0, 22) + '...' 
                    : afiliado.nombre;

                // Actualizar perfil
                dom.nombreAfiliado.textContent = nombreCorto;
                dom.cedulaAfiliado.textContent = afiliado.cedula;
                dom.fechaAfiliacionMini.textContent = afiliado.fecha;
                dom.avatarMini.textContent = afiliado.nombre.charAt(0).toUpperCase();
                
                const estaAlDia = mesesDeuda.length === 0;
                dom.estadoBadge.textContent = estaAlDia ? '‚úì AL D√çA' : '‚ö†Ô∏è CON DEUDA';
                dom.estadoBadge.className = estaAlDia ? 'status-badge' : 'status-badge debt';
                
                // Actualizar estad√≠sticas
                dom.totalPagadoMini.textContent = formatearMoneda(totalPagado);
                dom.cuotasPagadasMini.textContent = pagosAfiliado.length;
                
                // Actualizar resumen de deuda (meses y valor total)
                dom.mesesPendientesCount.textContent = `${mesesDeuda.length} ${mesesDeuda.length === 1 ? 'mes' : 'meses'}`;
                dom.deudaTotalValue.textContent = formatearMoneda(deudaTotal);
                
                // Renderizar meses pendientes (lista detallada)
                if (mesesDeuda.length > 0) {
                    let pendingHtml = '';
                    mesesDeuda.forEach(({a√±o, mes}) => {
                        pendingHtml += `
                            <div class="pending-item">
                                <span class="pending-month">${nombreMes(mes)} ${a√±o}</span>
                                <span class="pending-amount">${formatearMoneda(CONFIG.VALOR_CUOTA)}</span>
                            </div>
                        `;
                    });
                    dom.pendingList.innerHTML = pendingHtml;
                    dom.pendingSection.style.display = 'block';
                    dom.debtSummary.style.display = 'flex';
                } else {
                    dom.pendingList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #2d6a4f; background: white; border-radius: 14px;">
                            ‚úì No tienes deudas pendientes
                        </div>
                    `;
                    // Si no hay deuda, mostrar mensaje en el resumen
                    dom.mesesPendientesCount.textContent = '0 meses';
                    dom.deudaTotalValue.textContent = '$0';
                }
                
                // Generar filtro de a√±os
                const a√±os = [...new Set(pagosAfiliado.map(p => p.a√±o))];
                a√±os.sort((a,b) => b - a);
                
                let a√±oOptions = '<option value="todos">üìÜ Todos los a√±os</option>';
                a√±os.forEach(a√±o => {
                    a√±oOptions += `<option value="${a√±o}">${a√±o}</option>`;
                });
                dom.filtroAnioModal.innerHTML = a√±oOptions;
                
                // Renderizar timeline
                renderizarTimelineMini(pagosAfiliado);
                
                // Fecha de consulta
                dom.fechaConsultaModal.textContent = formatearFechaCorta(new Date());
                
                // Mostrar modal
                ocultarLoading();
                dom.modal.style.display = 'flex';
                
            } catch (e) {
                ocultarLoading();
                mostrarAlerta('Error al consultar', 'error');
                console.error(e);
            }
        }

        // ============================================================
        // RENDERIZAR TIMELINE COMPACTO
        // ============================================================

        function renderizarTimelineMini(pagos) {
            const filtro = dom.filtroAnioModal.value;
            const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            let pagosFiltrados = pagos;
            
            if (filtro !== 'todos') {
                const a√±oFiltro = parseInt(filtro);
                pagosFiltrados = pagosFiltrados.filter(p => p.a√±o === a√±oFiltro);
            }
            
            let html = '<div class="timeline-mini">';
            
            if (pagosFiltrados.length === 0) {
                html += '<div class="empty-state">';
                html += 'üì≠ No hay pagos registrados en este per√≠odo';
                html += '</div>';
            } else {
                pagosFiltrados.forEach(pago => {
                    const mesAbr = pago.mes.substring(0, 3);
                    const mesCapitalize = mesAbr.charAt(0).toUpperCase() + mesAbr.slice(1);
                    
                    html += `<div class="timeline-item-mini">`;
                    html += `<div class="timeline-month-mini">${mesCapitalize} ${pago.a√±o}</div>`;
                    html += `<div class="timeline-badge-mini">‚úÖ Pagado</div>`;
                    html += `<div class="timeline-amount-mini">${formatearMoneda(pago.valor)}</div>`;
                    html += `<div class="timeline-receipt-mini">${pago.recibo.substring(0, 8)}</div>`;
                    html += `</div>`;
                });
            }
            
            html += '</div>';
            dom.timelineContainerMini.innerHTML = html;
        }

        // ============================================================
        // INICIALIZACI√ìN
        // ============================================================

        async function inicializar() {
            mostrarLoading();
            
            try {
                appState.afiliados = await cargarAfiliados();
                appState.pagos = await cargarPagos();
                console.log(`‚úÖ ${appState.afiliados.length} afiliados, ${appState.pagos.length} registros`);
            } catch (e) {
                console.error(e);
                mostrarAlerta('Error cargando datos', 'error');
            } finally {
                ocultarLoading();
            }

            // Event listeners
            dom.btnConsultar.addEventListener('click', consultarAfiliado);
            
            dom.cedulaInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    consultarAfiliado();
                }
            });

            dom.closeModalBtn.addEventListener('click', () => {
                dom.modal.style.display = 'none';
            });

            dom.modal.addEventListener('click', (e) => {
                if (e.target === dom.modal) {
                    dom.modal.style.display = 'none';
                }
            });

            dom.filtroAnioModal.addEventListener('change', () => {
                const cedula = dom.cedulaAfiliado.textContent;
                if (cedula && cedula !== '1234567890') {
                    const pagosAfiliado = obtenerPagosAfiliado(cedula);
                    renderizarTimelineMini(pagosAfiliado);
                }
            });

            // Limpiar input al abrir
            dom.cedulaInput.value = '';
        }

        inicializar();
    </script>
</body>
</html>
